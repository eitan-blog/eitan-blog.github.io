<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>HashMap（一）</title>
    <url>/2021/05/13/HashMap%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<p>基于 <em>jkd1.8</em> 源码认识 HashMap。包含以下内容：</p>
<ol>
<li>扰动函数</li>
<li>初始化容量</li>
<li>负载因子</li>
</ol>
<span id="more"></span>

<h2 id="扰动函数"><a href="#扰动函数" class="headerlink" title="扰动函数"></a>扰动函数</h2><p>在 HashMap 存放元素时候有这样一段代码来处理哈希值，用于优化散列效果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-运算符"><a href="#1-运算符" class="headerlink" title="1.运算符"></a>1.运算符</h3><ul>
<li>&gt;&gt;&gt;：无符号右移。无论是正数还是负数，高位通通补0；</li>
<li>^：异或运算符。相同为 0，不同为 1；</li>
<li>&amp;：与运算符。同为 1 时才为 1，否则为 0。</li>
</ul>
<h3 id="2-元素在数组中的位置"><a href="#2-元素在数组中的位置" class="headerlink" title="2.元素在数组中的位置"></a>2.元素在数组中的位置</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 找到元素在数组中的位置，n为数组长度。</span></span><br><span class="line">i = (n - <span class="number">1</span>) &amp; hash</span><br></pre></td></tr></table></figure>

<h3 id="3-为什么-HashMap-数组的长度-n-要是2的整数幂"><a href="#3-为什么-HashMap-数组的长度-n-要是2的整数幂" class="headerlink" title="3.为什么 HashMap 数组的长度 n 要是2的整数幂"></a>3.为什么 HashMap 数组的长度 n 要是2的整数幂</h3><p>为使 hash 值散列分布在数组的下标当中。</p>
<p>假设我们有一个长度为16的数组，则他的下标范围为 0~15。而任何一个2的整数幂，减1得到的二进制位全部是1。让 hash 值与其就行与运算，结果将保留 hash 值小于数组下标范围的低位。当 hash 足够散列时，得到的结果必为在数组下标内散列的值。</p>
<figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">    <span class="number">00100100</span> <span class="number">10100101</span> <span class="number">11000100</span> <span class="number">00100101</span>    // Hash值</span><br><span class="line">&amp;   <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00001111</span>    // <span class="number">16</span> - <span class="number">1</span> = <span class="number">15</span></span><br><span class="line">----------------------------------</span><br><span class="line">    <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000101</span>    // 高位全部归零，只保留末四位。</span><br></pre></td></tr></table></figure>

<h3 id="4-扰动函数里为何无符号右移16位"><a href="#4-扰动函数里为何无符号右移16位" class="headerlink" title="4.扰动函数里为何无符号右移16位"></a>4.扰动函数里为何无符号右移16位</h3><p>为使 hash 值的高位也能影响到该元素在数组中的位置，提高散列性。</p>
<p>因为获取元素在数组中的位置时取的是 hash 值在数组下标范围内的低位，则将Hash值的高16位右移并与原Hash值取异或运算（^），混合高16位和低16位的值，会得到一个更加散列的低16位的Hash值。</p>
<h2 id="初始化容量"><a href="#初始化容量" class="headerlink" title="初始化容量"></a>初始化容量</h2><p>在 HashMap 的初始化中，有这样一段方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">        <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中 <em>threshold</em> 的取值为比 <em>initialCapacity</em> 大的最小2的整数幂：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = cap - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="负载因子"><a href="#负载因子" class="headerlink" title="负载因子"></a>负载因子</h2><p>负载因子决定了数据量达到多少了以后，hashmap 会进行扩容，默认值为 0.75。</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>HashMap</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL调优（一）未完成</title>
    <url>/2021/05/14/MySQL%E8%B0%83%E4%BC%98%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<h2 id="Server-处理-Client-的请求过程"><a href="#Server-处理-Client-的请求过程" class="headerlink" title="Server 处理 Client 的请求过程"></a>Server 处理 Client 的请求过程</h2><p><img src="https://raw.githubusercontent.com/xyq-material/image/master/blog/20210514091718.png" alt="image-20210514091715754"></p>
<span id="more"></span>

<h2 id="性能监控"><a href="#性能监控" class="headerlink" title="性能监控"></a>性能监控</h2><h3 id="SHOW-PROFILE-分析SQL执行耗时"><a href="#SHOW-PROFILE-分析SQL执行耗时" class="headerlink" title="SHOW PROFILE 分析SQL执行耗时"></a>SHOW PROFILE 分析SQL执行耗时</h3><ol>
<li><p>开启分析</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> profiling<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>运行查询语句</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> category;</span><br></pre></td></tr></table></figure></li>
<li><p>查看查询语句耗时</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> profiles;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------+------------------------+</span></span><br><span class="line"><span class="operator">|</span> Query_ID <span class="operator">|</span> Duration   <span class="operator">|</span> Query                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------+------------------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> <span class="number">0.00019575</span> <span class="operator">|</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span> <span class="number">0.00018800</span> <span class="operator">|</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> category <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------+------------------------+</span></span><br></pre></td></tr></table></figure></li>
<li><p>查询单个语句的详细信息</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> profile <span class="keyword">for</span> query <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Status               <span class="operator">|</span> Duration <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> starting             <span class="operator">|</span> <span class="number">0.000052</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> checking permissions <span class="operator">|</span> <span class="number">0.000005</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Opening tables       <span class="operator">|</span> <span class="number">0.000014</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> init                 <span class="operator">|</span> <span class="number">0.000014</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">System</span> lock          <span class="operator">|</span> <span class="number">0.000006</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> optimizing           <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> statistics           <span class="operator">|</span> <span class="number">0.000008</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> preparing            <span class="operator">|</span> <span class="number">0.000006</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> executing            <span class="operator">|</span> <span class="number">0.000002</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Sending data         <span class="operator">|</span> <span class="number">0.000034</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">end</span>                  <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> query <span class="keyword">end</span>            <span class="operator">|</span> <span class="number">0.000004</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> closing tables       <span class="operator">|</span> <span class="number">0.000006</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> freeing items        <span class="operator">|</span> <span class="number">0.000031</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cleaning up          <span class="operator">|</span> <span class="number">0.000008</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br></pre></td></tr></table></figure></li>
<li><p>查看sql相关的所有分析【主要看i/o与cpu】</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> profile <span class="keyword">all</span> <span class="keyword">for</span> query <span class="number">1</span> \G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: starting</span><br><span class="line">           Duration: <span class="number">0.000052</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="keyword">NULL</span></span><br><span class="line">        Source_file: <span class="keyword">NULL</span></span><br><span class="line">        Source_line: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: checking permissions</span><br><span class="line">           Duration: <span class="number">0.000005</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: sql_parse.cc</span><br><span class="line">        Source_line: <span class="number">5266</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: Opening tables</span><br><span class="line">           Duration: <span class="number">0.000014</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: sql_base.cc</span><br><span class="line">        Source_line: <span class="number">5018</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">4.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: init</span><br><span class="line">           Duration: <span class="number">0.000014</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: sql_select.cc</span><br><span class="line">        Source_line: <span class="number">1050</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">5.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: <span class="keyword">System</span> lock</span><br><span class="line">           Duration: <span class="number">0.000006</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: lock.cc</span><br><span class="line">        Source_line: <span class="number">304</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">6.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: optimizing</span><br><span class="line">           Duration: <span class="number">0.000003</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: sql_optimizer.cc</span><br><span class="line">        Source_line: <span class="number">138</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">7.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: statistics</span><br><span class="line">           Duration: <span class="number">0.000008</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: sql_optimizer.cc</span><br><span class="line">        Source_line: <span class="number">362</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">8.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: preparing</span><br><span class="line">           Duration: <span class="number">0.000006</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: sql_optimizer.cc</span><br><span class="line">        Source_line: <span class="number">485</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">9.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: executing</span><br><span class="line">           Duration: <span class="number">0.000002</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: sql_executor.cc</span><br><span class="line">        Source_line: <span class="number">110</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">10.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: Sending data</span><br><span class="line">           Duration: <span class="number">0.000034</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: sql_executor.cc</span><br><span class="line">        Source_line: <span class="number">190</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">11.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: <span class="keyword">end</span></span><br><span class="line">           Duration: <span class="number">0.000003</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: sql_select.cc</span><br><span class="line">        Source_line: <span class="number">1105</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">12.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: query <span class="keyword">end</span></span><br><span class="line">           Duration: <span class="number">0.000004</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: sql_parse.cc</span><br><span class="line">        Source_line: <span class="number">4965</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">13.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: closing tables</span><br><span class="line">           Duration: <span class="number">0.000006</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: sql_parse.cc</span><br><span class="line">        Source_line: <span class="number">5013</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">14.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: freeing items</span><br><span class="line">           Duration: <span class="number">0.000031</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: sql_parse.cc</span><br><span class="line">        Source_line: <span class="number">6404</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">15.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">             Status: cleaning up</span><br><span class="line">           Duration: <span class="number">0.000008</span></span><br><span class="line">           CPU_user: <span class="number">0.000000</span></span><br><span class="line">         CPU_system: <span class="number">0.000000</span></span><br><span class="line">  Context_voluntary: <span class="keyword">NULL</span></span><br><span class="line">Context_involuntary: <span class="keyword">NULL</span></span><br><span class="line">       Block_ops_in: <span class="keyword">NULL</span></span><br><span class="line">      Block_ops_out: <span class="keyword">NULL</span></span><br><span class="line">      Messages_sent: <span class="keyword">NULL</span></span><br><span class="line">  Messages_received: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_major: <span class="keyword">NULL</span></span><br><span class="line">  Page_faults_minor: <span class="keyword">NULL</span></span><br><span class="line">              Swaps: <span class="keyword">NULL</span></span><br><span class="line">    Source_function: <span class="operator">&lt;</span><span class="literal">unknown</span><span class="operator">&gt;</span></span><br><span class="line">        Source_file: sql_parse.cc</span><br><span class="line">        Source_line: <span class="number">1772</span></span><br></pre></td></tr></table></figure></li>
<li><p>关闭分析</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> profiling<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="MySQL-Performance-Schema"><a href="#MySQL-Performance-Schema" class="headerlink" title="MySQL Performance Schema"></a>MySQL Performance Schema</h3><p>详细可以查看<a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema.html">官方文档</a></p>
<h3 id="查看线程连接个数-SHOW-PROCESSLIST"><a href="#查看线程连接个数-SHOW-PROCESSLIST" class="headerlink" title="查看线程连接个数 SHOW PROCESSLIST"></a>查看线程连接个数 SHOW PROCESSLIST</h3><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">+----+------+-----------------+----------+---------+------+-------+------------------+</span><br><span class="line">|<span class="string"> Id </span>|<span class="string"> User </span>|<span class="string"> Host            </span>|<span class="string"> db       </span>|<span class="string"> Command </span>|<span class="string"> Time </span>|<span class="string"> State </span>|<span class="string"> Info             </span>|</span><br><span class="line">+----+------+-----------------+----------+---------+------+-------+------------------+</span><br><span class="line">|<span class="string"> 45 </span>|<span class="string"> root </span>|<span class="string"> localhost:11156 </span>|<span class="string"> bugstack </span>|<span class="string"> Sleep   </span>|<span class="string">  210 </span>|<span class="string">       </span>|<span class="string"> NULL             </span>|</span><br><span class="line">|<span class="string"> 46 </span>|<span class="string"> root </span>|<span class="string"> localhost:13537 </span>|<span class="string"> NULL     </span>|<span class="string"> Query   </span>|<span class="string">    0 </span>|<span class="string"> init  </span>|<span class="string"> show processlist </span>|</span><br><span class="line">+----+------+-----------------+----------+---------+------+-------+------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li>id：表示session id</li>
<li>user：表示操作的用户</li>
<li>host：表示操作的主机</li>
<li>db：表示操作的数据库</li>
<li>command：表示命令类型</li>
<li>info：表示详细的sql语句</li>
<li>time：表示相应命令执行时间</li>
<li>state：表示命令执行状态</li>
</ul>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis（二）</title>
    <url>/2021/05/17/Redis%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    <content><![CDATA[<p>介绍了 Redis 的事务、发布订阅、回收策略、过期和持久化</p>
<span id="more"></span>

<h2 id="布隆过滤器-make-失败"><a href="#布隆过滤器-make-失败" class="headerlink" title="布隆过滤器(make 失败)"></a>布隆过滤器(make 失败)</h2><p>网址：<a href="https://github.com/RedisBloom/RedisBloom">https://github.com/RedisBloom/RedisBloom</a></p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>打开网址，在<em>DownloadZip</em>处右键复制链接地址</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">wget https://github.com/RedisBloom/RedisBloom/archive/refs/heads/master.zip</span><br></pre></td></tr></table></figure>

<h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">unzip <span class="literal">master</span>.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 猜测是没有 python 环境</span></span><br><span class="line">make</span><br></pre></td></tr></table></figure>



<h3 id="Redis事务"><a href="#Redis事务" class="headerlink" title="Redis事务"></a>Redis事务</h3><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> MULTI</span></span><br><span class="line">OK</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> INCR foo</span></span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> INCR bar</span></span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> EXEC</span></span><br><span class="line">1) (integer) 1</span><br><span class="line">2) (integer) 1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Redis 先执行收到 <em>EXEC</em> 的事务</p>
</blockquote>
<h3 id="Redis事务不会回滚，且失败后会继续执行后续命令"><a href="#Redis事务不会回滚，且失败后会继续执行后续命令" class="headerlink" title="Redis事务不会回滚，且失败后会继续执行后续命令"></a>Redis事务不会回滚，且失败后会继续执行后续命令</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6380&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380(TX)&gt; get k1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6380(TX)&gt; set k2 3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6380(TX)&gt; EXEC</span><br><span class="line">1) (nil)</span><br><span class="line">2) OK</span><br><span class="line">127.0.0.1:6380&gt; get k2</span><br><span class="line">&quot;3&quot;</span><br></pre></td></tr></table></figure>

<h3 id="WATCH-来检查-key是否被改变"><a href="#WATCH-来检查-key是否被改变" class="headerlink" title="WATCH 来检查 key是否被改变"></a>WATCH 来检查 key是否被改变</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6380&gt; set k2 3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; WATCH k2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380(TX)&gt; set k2 5</span><br><span class="line">QUEUED</span><br></pre></td></tr></table></figure>

<p>另开一个bash，设置k2的值</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6380&gt; set k2 7</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>执行事务发现没有将k2发生改变</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6380(TX)&gt; EXEC</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6380&gt; get k2</span><br><span class="line">&quot;7&quot;</span><br></pre></td></tr></table></figure>



<h2 id="Pub-Sub"><a href="#Pub-Sub" class="headerlink" title="Pub/Sub"></a>Pub/Sub</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">help @pubsub</span><br><span class="line"></span><br><span class="line">  PSUBSCRIBE pattern [pattern ...]</span><br><span class="line">  summary: Listen for messages published to channels matching the given patterns</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  PUBLISH channel message</span><br><span class="line">  summary: Post a message to a channel</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  PUBSUB subcommand [argument [argument ...]]</span><br><span class="line">  summary: Inspect the state of the Pub/Sub subsystem</span><br><span class="line">  since: 2.8.0</span><br><span class="line"></span><br><span class="line">  PUNSUBSCRIBE [pattern [pattern ...]]</span><br><span class="line">  summary: Stop listening for messages posted to channels matching the given patterns</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  SUBSCRIBE channel [channel ...]</span><br><span class="line">  summary: Listen for messages published to the given channels</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  UNSUBSCRIBE [channel [channel ...]]</span><br><span class="line">  summary: Stop listening for messages posted to the given channels</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Redis的回收策略"><a href="#Redis的回收策略" class="headerlink" title="Redis的回收策略"></a>Redis的回收策略</h2><p>查看配置文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/redis/6379.conf</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置最大使用内存</span></span><br><span class="line">maxmemory &lt;bytes&gt;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 选择内存满后的回收策略</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> volatile-lru -&gt; Evict using approximated LRU, only keys with an expire <span class="built_in">set</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> allkeys-lru -&gt; Evict any key using approximated LRU.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> volatile-lfu -&gt; Evict using approximated LFU, only keys with an expire <span class="built_in">set</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> allkeys-lfu -&gt; Evict any key using approximated LFU.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> volatile-random -&gt; Remove a random key having an expire <span class="built_in">set</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> allkeys-random -&gt; Remove a random key, any key.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> volatile-ttl -&gt; Remove the key with the nearest expire time (minor TTL)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> noeviction -&gt; Don<span class="string">&#x27;t evict anything, just return an error on write operations.</span></span></span><br><span class="line">maxmemory-policy noeviction</span><br></pre></td></tr></table></figure>



<h2 id="Redis过期"><a href="#Redis过期" class="headerlink" title="Redis过期"></a>Redis过期</h2><h3 id="访问Redis不会刷新过期时间"><a href="#访问Redis不会刷新过期时间" class="headerlink" title="访问Redis不会刷新过期时间"></a>访问Redis不会刷新过期时间</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6380&gt; set k1 1 ex 50</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; ttl k1</span><br><span class="line">(integer) 46</span><br><span class="line">127.0.0.1:6380&gt; get k1</span><br><span class="line">&quot;1&quot;</span><br><span class="line">127.0.0.1:6380&gt; ttl k1</span><br><span class="line">(integer) 39</span><br></pre></td></tr></table></figure>

<h3 id="发生写时会剔除过期时间"><a href="#发生写时会剔除过期时间" class="headerlink" title="发生写时会剔除过期时间"></a>发生写时会剔除过期时间</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6380&gt; set k2 a ex 50</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; ttl k2</span><br><span class="line">(integer) 47</span><br><span class="line">127.0.0.1:6380&gt; set k2 b</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; ttl k2</span><br><span class="line">(integer) -1</span><br></pre></td></tr></table></figure>

<h3 id="Redis如何过期"><a href="#Redis如何过期" class="headerlink" title="Redis如何过期"></a>Redis如何过期</h3><p>Redis密钥以两种方式过期：被动方式和主动方式。</p>
<p>仅当某些客户端尝试访问密钥时，密钥才会被动过期，并且发现该密钥已超时。</p>
<p>当然，这还不够，因为有过期的密钥将永远无法再次访问。这些密钥无论如何都应该过期，因此，Redis会定期对具有过期集的密钥中的一些密钥进行随机测试。所有已过期的密钥将从密钥空间中删除。</p>
<p>具体来说，这是Redis每秒执行10次的操作：</p>
<ol>
<li>从一组相关联的过期密钥中测试20个随机密钥。</li>
<li>删除找到的所有密钥已过期。</li>
<li>如果超过25％的密钥已过期，请从步骤1重新开始。</li>
</ol>
<p>目的：不轮询所有的key，牺牲部分内存来保证Redis的高性能</p>
<h2 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h2><h3 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h3><h4 id="触发RDB的配置"><a href="#触发RDB的配置" class="headerlink" title="触发RDB的配置"></a>触发RDB的配置</h4><ul>
<li>save</li>
<li>bgsave</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/redis/6379.conf</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> save 3600 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> save 300 100</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> save 60 10000</span></span><br></pre></td></tr></table></figure>

<p>save 3600 1 表示，在3600秒之中有一次操作则触发RDB  </p>
<h4 id="fork"><a href="#fork" class="headerlink" title="fork()"></a>fork()</h4><p>fork()的引出：在redis进行RDB时，会开启一个进程将某一时刻的数据全部存入磁盘。因为在Linux系统中，各个进程直接内存是隔离的。如果在开时一个进程的时需要将redis全部数据都复制一份，会降低redis的效率，这是需要fork()。</p>
<p><img src="https://raw.githubusercontent.com/xyq-material/image/master/blog/20210518153845.png" alt="image-20210518153844660"></p>
<h4 id="Copy-On-Write"><a href="#Copy-On-Write" class="headerlink" title="Copy On Write"></a>Copy On Write</h4><p>fork()出的进程和原进程通过指针指向的是相同的内存空间，当一个进程要对数据进行修改时会在内存中另起一块空间，对其赋值并将指针指向该地址空间。</p>
<p><img src="https://raw.githubusercontent.com/xyq-material/image/master/blog/20210518153730.png" alt="image-20210518153729229"></p>
<h3 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h3><p>redis 的写操作记录到文件中，丢失数据会很少。因此将老的数据使用RDB存储起来，将新数据增量到AOF中。</p>
<p>BGREWRITEAOF：重写 AOF</p>
<h3 id="三种级别"><a href="#三种级别" class="headerlink" title="三种级别"></a>三种级别</h3><p>在 <em>/etc/redis/6379.conf</em> 中</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> AOF 默认不开启</span></span><br><span class="line">appendonly no</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 三种级别</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> appendfsync always</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="meta">#</span><span class="bash"> appendfsync no</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在 RDB 时不将 AOF 的 bufferPage 刷到磁盘</span></span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line"></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> When rewriting the AOF file, Redis is able to use an RDB preamble <span class="keyword">in</span> the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> AOF file <span class="keyword">for</span> faster rewrites and recoveries. When this option is turned</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> on the rewritten AOF file is composed of two different stanzas:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment">#   [RDB file][AOF tail]</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># When loading, Redis recognizes that the AOF file starts with the &quot;REDIS&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> string and loads the prefixed RDB file, <span class="keyword">then</span> continues loading the AOF</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tail.</span></span><br><span class="line">aof-use-rdb-preamble yes</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>NO：从不主动刷到磁盘</li>
<li>always：每次操作都刷新到磁盘</li>
<li>everysec：每秒刷新一次到磁盘</li>
</ul>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Tags Testing Article</title>
    <url>/2021/05/11/Tags-Testing-Article/</url>
    <content><![CDATA[<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/xyq-material/blog/master/LeetCode/20210512131715.png" alt="逸"></p>
]]></content>
      <tags>
        <tag>Testing</tag>
        <tag>Another Tag</tag>
      </tags>
  </entry>
  <entry>
    <title>RocketMQ（一）</title>
    <url>/2021/05/17/RocketMQ%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<h2 id="主要内容"><a href="#主要内容" class="headerlink" title="主要内容"></a>主要内容</h2><ul>
<li>编译安装</li>
<li>HelloWorld</li>
</ul>
<h3 id="官方网站"><a href="#官方网站" class="headerlink" title="官方网站"></a>官方网站</h3><p><a href="http://rocketmq.apache.org/">http://rocketmq.apache.org/</a></p>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><p><a href="https://github.com/apache/rocketmq">https://github.com/apache/rocketmq</a></p>
<span id="more"></span>



<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="在-Linux-上安装-JDK"><a href="#在-Linux-上安装-JDK" class="headerlink" title="在 Linux 上安装 JDK"></a>在 Linux 上安装 JDK</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum search jdk</span><br><span class="line"></span><br><span class="line">yum install java-1.8.0-openjdk.x86_64</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 找到安装位置</span></span><br><span class="line">java -verbose</span><br><span class="line"></span><br><span class="line">[Loaded java.lang.Shutdown from /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.292.b10-1.el7_9.x86_64/jre/lib/rt.jar]</span><br><span class="line">[Loaded java.lang.Shutdown$Lock from /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.292.b10-1.el7_9.x86_64/jre/lib/rt.jar]</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置 JAVA_HOME</span></span><br><span class="line">vim /etc/profile</span><br></pre></td></tr></table></figure>

<h3 id="在-Linux-上安装-Maven"><a href="#在-Linux-上安装-Maven" class="headerlink" title="在 Linux 上安装 Maven"></a>在 Linux 上安装 Maven</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载压缩包</span></span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压</span></span><br><span class="line">tar -zxvf apache-maven-3.6.3-bin.tar.gz</span><br><span class="line"></span><br><span class="line">mv apache-maven-3.6.3 /usr/local/</span><br><span class="line"></span><br><span class="line">vim /usr/local/apache-maven-3.6.3/conf/settings.xml</span><br><span class="line">   &lt;mirror&gt;</span><br><span class="line">      &lt;id&gt;aliyun-maven&lt;/id&gt;</span><br><span class="line">      &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">      &lt;name&gt;aliyun maven&lt;/name&gt;</span><br><span class="line">      &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;</span><br><span class="line">    &lt;/mirror&gt;</span><br><span class="line">    </span><br><span class="line">vim /etc/profile</span><br><span class="line">export MAVEN_HOME=/usr/local/apache-maven-3.6.3</span><br><span class="line">export PATH=$PATH:$MAVEN_HAOM/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<h3 id="安装-RocketMQ"><a href="#安装-RocketMQ" class="headerlink" title="安装 RocketMQ"></a>安装 RocketMQ</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/apache/rocketmq/4.8.0/rocketmq-all-4.8.0-source-release.zip</span><br><span class="line"></span><br><span class="line">unzip rocketmq-all-4.8.0-source-release.zip</span><br><span class="line"></span><br><span class="line">mvn -Prelease-all -DskipTests clean install -U</span><br><span class="line"></span><br><span class="line"># 启动</span><br><span class="line">./mqnamesrv</span><br><span class="line">./mqbroker</span><br><span class="line"></span><br><span class="line"># 测试</span><br><span class="line">./tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br></pre></td></tr></table></figure>

<p>若遇到错误：linux No compiler is provided in this environment. Perhaps you are running on a JRE rather than a JDK，则执行以下命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install java-devel</span><br></pre></td></tr></table></figure>

<p>启动报错：Native memory allocation (mmap) failed to map 2147483648 bytes for committing reserved memory</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /usr/local/rocketmq-4.8.0/bin/runserver.sh</span><br><span class="line">vim /usr/local/rocketmq-4.8.0/bin/runbroker.sh</span><br><span class="line"></span><br><span class="line">JAVA_OPT=&quot;$&#123;JAVA_OPT&#125; -server -Xms4g -Xmx4g -Xmn2g -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 改为</span></span><br><span class="line">JAVA_OPT=&quot;$&#123;JAVA_OPT&#125; -server -Xms256m -Xmx256m -Xmn128m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;</span><br></pre></td></tr></table></figure>

<p>测试报错：connect to null failed</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim tools.sh</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 放在 JVM Configuration 之前</span></span><br><span class="line">export NAMESRV_ADDR=localhost:9876</span><br></pre></td></tr></table></figure>

<p>测试报错：org.apache.rocketmq.client.exception.MQClientException: No route info of this topic: TopicTest</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动broker指定连接的ip：port</span></span><br><span class="line">./mqbroker -n localhost:9876</span><br></pre></td></tr></table></figure>

<h3 id="控制台rocketmq-console编译安装"><a href="#控制台rocketmq-console编译安装" class="headerlink" title="控制台rocketmq-console编译安装"></a>控制台rocketmq-console编译安装</h3><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><p><a href="https://github.com/apache/rocketmq-externals">github仓库</a></p>
<h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mvn clean package -Dmaven.test.skip=true</span><br></pre></td></tr></table></figure>

<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -jar rocketmq-console-ng-2.0.0.jar --rocketmq.config.namesrvAddr=172.17.0.2:9876</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>RocketMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2021/05/11/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<span id="more"></span>

<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>系统调用的大致过程</title>
    <url>/2021/05/13/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84%E5%A4%A7%E8%87%B4%E8%BF%87%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><h3 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h3><p>操作系统(operating system)内核中有一组实现系统功能的代码，系统调用就是对上述代码的调用。程序利用系统调用，向OS提出服务请求，由OS代为完成。</p>
<h3 id="中断"><a href="#中断" class="headerlink" title="中断"></a>中断</h3><p>中断是一种使CPU中止正在执行的程序而转去处理特殊事件的操作，这些引起中断的事件称为中断源，它们可能是来自外设的输入输出请求，也可能是计算机的一些异常事故或其它内部原因。</p>
<span id="more"></span>

<h2 id="系统调用过程"><a href="#系统调用过程" class="headerlink" title="系统调用过程"></a>系统调用过程</h2><ol>
<li>触发中断：硬件或软件发出中断请求（电信号），要求CPU暂停当前工作转手处理更重要的事情。</li>
<li>查询中断向量表：通过中断传来的参数 <em>int 0x80</em>，在 kernel 里的中断向量表中找到对应方法</li>
<li>切换用户态到内核态：保护现场，切换用户态到内核态</li>
<li>执行对应方法</li>
</ol>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>system call</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis（一）</title>
    <url>/2021/05/14/Redis%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<p>学习 Redis 需要掌握的常识</p>
<span id="more"></span>

<h2 id="基础常识"><a href="#基础常识" class="headerlink" title="基础常识"></a>基础常识</h2><h3 id="磁道和扇区"><a href="#磁道和扇区" class="headerlink" title="磁道和扇区"></a>磁道和扇区</h3><p>下图显示的是一个盘面，盘面中一圈圈灰色同心圆为一条条磁道，从圆心向外画直线，可以将磁道划分为若干个弧段，每个磁道上一个弧段被称之为一个扇区（图践绿色部分）。扇区是磁盘的最小组成单元，通常是512字节。</p>
<p><img src="https://raw.githubusercontent.com/xyq-material/image/master/blog/20210514115953.png" alt="image-20210514115951384"></p>
<h3 id="内存和磁盘I-O速度"><a href="#内存和磁盘I-O速度" class="headerlink" title="内存和磁盘I/O速度"></a>内存和磁盘I/O速度</h3><p>内存寻址速度是 ns 级的，而磁盘是 ms 级的。</p>
<h3 id="操作数"><a href="#操作数" class="headerlink" title="操作数"></a>操作数</h3><p>关系型数据库，千/每秒；redis，十万/每秒。</p>
<h2 id="Redis介绍"><a href="#Redis介绍" class="headerlink" title="Redis介绍"></a>Redis介绍</h2><p>Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件。 它支持多种类型的数据结构，如 <a href="http://www.redis.cn/topics/data-types-intro.html#strings">字符串（strings）</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#hashes">散列（hashes）</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#lists">列表（lists）</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#sets">集合（sets）</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#sorted-sets">有序集合（sorted sets）</a> 与范围查询， <a href="http://www.redis.cn/topics/data-types-intro.html#bitmaps">bitmaps</a>， <a href="http://www.redis.cn/topics/data-types-intro.html#hyperloglogs">hyperloglogs</a> 和 <a href="http://www.redis.cn/commands/geoadd.html">地理空间（geospatial）</a> 索引半径查询。 Redis 内置了 <a href="http://www.redis.cn/topics/replication.html">复制（replication）</a>，<a href="http://www.redis.cn/commands/eval.html">LUA脚本（Lua scripting）</a>， <a href="http://www.redis.cn/topics/lru-cache.html">LRU驱动事件（LRU eviction）</a>，<a href="http://www.redis.cn/topics/transactions.html">事务（transactions）</a> 和不同级别的 <a href="http://www.redis.cn/topics/persistence.html">磁盘持久化（persistence）</a>， 并通过 <a href="http://www.redis.cn/topics/sentinel.html">Redis哨兵（Sentinel）</a>和自动 <a href="http://www.redis.cn/topics/cluster-tutorial.html">分区（Cluster）</a>提供高可用性（high availability）。</p>
<h2 id="Redis安装"><a href="#Redis安装" class="headerlink" title="Redis安装"></a>Redis安装</h2><h3 id="下载资源包"><a href="#下载资源包" class="headerlink" title="下载资源包"></a>下载资源包</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install wget</span><br><span class="line"></span><br><span class="line">wget https://download.redis.io/releases/redis-6.2.3.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -zxvf redis-6.2.3.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="安装编译环境"><a href="#安装编译环境" class="headerlink" title="安装编译环境"></a>安装编译环境</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install gcc</span><br></pre></td></tr></table></figure>

<h3 id="编译与安装"><a href="#编译与安装" class="headerlink" title="编译与安装"></a>编译与安装</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make</span><br><span class="line"></span><br><span class="line">yum install gcc</span><br><span class="line"></span><br><span class="line">make distclean</span><br><span class="line"></span><br><span class="line">make install PREFIX=/opt/eitan/redis6</span><br></pre></td></tr></table></figure>

<h3 id="注册为服务"><a href="#注册为服务" class="headerlink" title="注册为服务"></a>注册为服务</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加以下两行</span></span><br><span class="line">export REDIS_HOME=/opt/eitan/redis6</span><br><span class="line">export PATH=$PATH:$REDIS_HOME/bin</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新加载 profile</span></span><br><span class="line">source /etc/profile</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存退出后查看是否添加成功</span></span><br><span class="line">echo $PATH</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注册为服务</span></span><br><span class="line">cd /root/soft/redis-6.2.3/utils</span><br><span class="line">./install_server.sh</span><br></pre></td></tr></table></figure>

<h3 id="解决报错"><a href="#解决报错" class="headerlink" title="解决报错"></a>解决报错</h3><p>Please take a look at the provided example service unit files in this directory, and adapt and install them. Sorry!</p>
<p>注释 <em>install_server.sh</em> 中以下部分</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">bail <span class="keyword">if</span> this system is managed by systemd</span></span><br><span class="line">_pid_1_exe=&quot;$(readlink -f /proc/1/exe)&quot;</span><br><span class="line">if [ &quot;$&#123;_pid_1_exe##*/&#125;&quot; = systemd ]</span><br><span class="line">then</span><br><span class="line">  echo &quot;This systems seems to use systemd.&quot;</span><br><span class="line">  echo &quot;Please take a look at the provided example service unit files in this directory, and adapt and install them. Sorry!&quot;</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h3 id="epoll-介绍"><a href="#epoll-介绍" class="headerlink" title="epoll 介绍"></a>epoll 介绍</h3><p><img src="https://raw.githubusercontent.com/xyq-material/image/master/blog/20210516120300.png" alt="image-20210516120258026"></p>
<h2 id="Redis原理"><a href="#Redis原理" class="headerlink" title="Redis原理"></a>Redis原理</h2><p>redis 是单进程、单线程来处理用户请求的。redis 每个连接的命令是“顺序”的，对不同连接的命令不是顺序的。</p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul>
<li>二进制安全：redis 进程与外界交互的时候，只取字节流</li>
</ul>
<h2 id="Redis使用"><a href="#Redis使用" class="headerlink" title="Redis使用"></a>Redis使用</h2><h3 id="客户端连接服务"><a href="#客户端连接服务" class="headerlink" title="客户端连接服务"></a>客户端连接服务</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -p 6380</span><br></pre></td></tr></table></figure>

<h3 id="string"><a href="#string" class="headerlink" title="@string"></a>@string</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">help @string</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 往 value 中追加</span></span><br><span class="line">  APPEND key value</span><br><span class="line">  summary: Append a value to a key</span><br><span class="line">  since: 2.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 统计 1 在字符范围中出现的次数</span></span><br><span class="line">  BITCOUNT key [start end]</span><br><span class="line">  summary: Count set bits in a string</span><br><span class="line">  since: 2.6.0</span><br><span class="line"></span><br><span class="line">  BITFIELD key [GET type offset] [SET type offset value] [INCRBY type offset increment] [OVERFLOW WRAP|SAT|FAIL]</span><br><span class="line">  summary: Perform arbitrary bitfield integer operations on strings</span><br><span class="line">  since: 3.2.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 按位操作 operation，值存入 destKey</span></span><br><span class="line">  BITOP operation destkey key [key ...]</span><br><span class="line">  summary: Perform bitwise operations between strings</span><br><span class="line">  since: 2.6.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 返回字符范围中第一次出现 1 在二进制节中的偏移量</span></span><br><span class="line">  BITPOS key bit [start] [end]</span><br><span class="line">  summary: Find first bit set or clear in a string</span><br><span class="line">  since: 2.8.7</span><br><span class="line"></span><br><span class="line">  DECR key</span><br><span class="line">  summary: Decrement the integer value of a key by one</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  DECRBY key decrement</span><br><span class="line">  summary: Decrement the integer value of a key by the given number</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  GET key</span><br><span class="line">  summary: Get the value of a key</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  GETBIT key offset</span><br><span class="line">  summary: Returns the bit value at offset in the string value stored at key</span><br><span class="line">  since: 2.2.0</span><br><span class="line"></span><br><span class="line">  GETDEL key</span><br><span class="line">  summary: Get the value of a key and delete the key</span><br><span class="line">  since: 6.2.0</span><br><span class="line"></span><br><span class="line">  GETEX key [EX seconds|PX milliseconds|EXAT timestamp|PXAT milliseconds-timestamp|PERSIST]</span><br><span class="line">  summary: Get the value of a key and optionally set its expiration</span><br><span class="line">  since: 6.2.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 获取范围，可以使用负向索引</span></span><br><span class="line">  GETRANGE key start end</span><br><span class="line">  summary: Get a substring of the string stored at a key</span><br><span class="line">  since: 2.4.0</span><br><span class="line"></span><br><span class="line">  GETSET key value</span><br><span class="line">  summary: Set the string value of a key and return its old value</span><br><span class="line">  since: 1.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 自增加一</span></span><br><span class="line">  INCR key</span><br><span class="line">  summary: Increment the integer value of a key by one</span><br><span class="line">  since: 1.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 增加上一个值</span></span><br><span class="line">  INCRBY key increment</span><br><span class="line">  summary: Increment the integer value of a key by the given amount</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  INCRBYFLOAT key increment</span><br><span class="line">  summary: Increment the float value of a key by the given amount</span><br><span class="line">  since: 2.6.0</span><br><span class="line"></span><br><span class="line">  MGET key [key ...]</span><br><span class="line">  summary: Get the values of all the given keys</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  MSET key value [key value ...]</span><br><span class="line">  summary: Set multiple keys to multiple values</span><br><span class="line">  since: 1.0.1</span><br><span class="line"></span><br><span class="line">  MSETNX key value [key value ...]</span><br><span class="line">  summary: Set multiple keys to multiple values, only if none of the keys exist</span><br><span class="line">  since: 1.0.1</span><br><span class="line"></span><br><span class="line">  PSETEX key milliseconds value</span><br><span class="line">  summary: Set the value and expiration in milliseconds of a key</span><br><span class="line">  since: 2.6.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> NX：  当 key 不存在时才能设值；XX：当 key 存在时才能更新</span></span><br><span class="line">  SET key value [EX seconds|PX milliseconds|EXAT timestamp|PXAT milliseconds-timestamp|KEEPTTL] [NX|XX] [GET]</span><br><span class="line">  summary: Set the string value of a key</span><br><span class="line">  since: 1.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 这里的 offset 指的是二进制位的偏移量而不是字符的偏移量</span></span><br><span class="line">  SETBIT key offset value</span><br><span class="line">  summary: Sets or clears the bit at offset in the string value stored at key</span><br><span class="line">  since: 2.2.0</span><br><span class="line"></span><br><span class="line">  SETEX key seconds value</span><br><span class="line">  summary: Set the value and expiration of a key</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  SETNX key value</span><br><span class="line">  summary: Set the value of a key, only if the key does not exist</span><br><span class="line">  since: 1.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 从偏移量之后开始赋值</span></span><br><span class="line">  SETRANGE key offset value</span><br><span class="line">  summary: Overwrite part of a string at key starting at the specified offset</span><br><span class="line">  since: 2.2.0</span><br><span class="line"></span><br><span class="line">  STRALGO LCS algo-specific-argument [algo-specific-argument ...]</span><br><span class="line">  summary: Run algorithms (currently LCS) against strings</span><br><span class="line">  since: 6.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 获取长度</span></span><br><span class="line">  STRLEN key</span><br><span class="line">  summary: Get the length of the value stored in a key</span><br><span class="line">  since: 2.2.0</span><br></pre></td></tr></table></figure>

<h3 id="list"><a href="#list" class="headerlink" title="@list"></a>@list</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">help @list</span><br><span class="line"></span><br><span class="line">  BLMOVE source destination LEFT|RIGHT LEFT|RIGHT timeout</span><br><span class="line">  summary: Pop an element from a list, push it to another list and return it; or block until one is available</span><br><span class="line">  since: 6.2.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 阻塞获取，timeout为0表示一直等待</span></span><br><span class="line">  BLPOP key [key ...] timeout</span><br><span class="line">  summary: Remove and get the first element in a list, or block until one is available</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  BRPOP key [key ...] timeout</span><br><span class="line">  summary: Remove and get the last element in a list, or block until one is available</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  BRPOPLPUSH source destination timeout</span><br><span class="line">  summary: Pop an element from a list, push it to another list and return it; or block until one is available</span><br><span class="line">  since: 2.2.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 获取链表下标为index的元素</span></span><br><span class="line">  LINDEX key index</span><br><span class="line">  summary: Get an element from a list by its index</span><br><span class="line">  since: 1.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 插入元数，BEFORE|AFTER 表示向前|向后</span></span><br><span class="line">  LINSERT key BEFORE|AFTER pivot element</span><br><span class="line">  summary: Insert an element before or after another element in a list</span><br><span class="line">  since: 2.2.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 统计链表长度</span></span><br><span class="line">  LLEN key</span><br><span class="line">  summary: Get the length of a list</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  LMOVE source destination LEFT|RIGHT LEFT|RIGHT</span><br><span class="line">  summary: Pop an element from a list, push it to another list and return it</span><br><span class="line">  since: 6.2.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 弹出链表左边第一个元素</span></span><br><span class="line">  LPOP key [count]</span><br><span class="line">  summary: Remove and get the first elements in a list</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  LPOS key element [RANK rank] [COUNT num-matches] [MAXLEN len]</span><br><span class="line">  summary: Return the index of matching elements on a list</span><br><span class="line">  since: 6.0.6</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 往链表的左边添加元素</span></span><br><span class="line">  LPUSH key element [element ...]</span><br><span class="line">  summary: Prepend one or multiple elements to a list</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  LPUSHX key element [element ...]</span><br><span class="line">  summary: Prepend an element to a list, only if the list exists</span><br><span class="line">  since: 2.2.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 获取链表start到stop范围内的元素</span></span><br><span class="line">  LRANGE key start stop</span><br><span class="line">  summary: Get a range of elements from a list</span><br><span class="line">  since: 1.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> count为正数则从左往右删除count个为element的元素，为负数则从右往左删除</span></span><br><span class="line">  LREM key count element</span><br><span class="line">  summary: Remove elements from a list</span><br><span class="line">  since: 1.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 通过下标保存元素</span></span><br><span class="line">  LSET key index element</span><br><span class="line">  summary: Set the value of an element in a list by its index</span><br><span class="line">  since: 1.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 删除范围外两端的元素</span></span><br><span class="line">  LTRIM key start stop</span><br><span class="line">  summary: Trim a list to the specified range</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  RPOP key [count]</span><br><span class="line">  summary: Remove and get the last elements in a list</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  RPOPLPUSH source destination</span><br><span class="line">  summary: Remove the last element in a list, prepend it to another list and return it</span><br><span class="line">  since: 1.2.0</span><br><span class="line"></span><br><span class="line">  RPUSH key element [element ...]</span><br><span class="line">  summary: Append one or multiple elements to a list</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  RPUSHX key element [element ...]</span><br><span class="line">  summary: Append an element to a list, only if the list exists</span><br><span class="line">  since: 2.2.0</span><br></pre></td></tr></table></figure>

<h3 id="hash"><a href="#hash" class="headerlink" title="@hash"></a>@hash</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">help @hash</span><br><span class="line"></span><br><span class="line">  HDEL key field [field ...]</span><br><span class="line">  summary: Delete one or more hash fields</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  HEXISTS key field</span><br><span class="line">  summary: Determine if a hash field exists</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  HGET key field</span><br><span class="line">  summary: Get the value of a hash field</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  HGETALL key</span><br><span class="line">  summary: Get all the fields and values in a hash</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  HINCRBY key field increment</span><br><span class="line">  summary: Increment the integer value of a hash field by the given number</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  HINCRBYFLOAT key field increment</span><br><span class="line">  summary: Increment the float value of a hash field by the given amount</span><br><span class="line">  since: 2.6.0</span><br><span class="line"></span><br><span class="line">  HKEYS key</span><br><span class="line">  summary: Get all the fields in a hash</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  HLEN key</span><br><span class="line">  summary: Get the number of fields in a hash</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  HMGET key field [field ...]</span><br><span class="line">  summary: Get the values of all the given hash fields</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  HMSET key field value [field value ...]</span><br><span class="line">  summary: Set multiple hash fields to multiple values</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  HRANDFIELD key [count [WITHVALUES]]</span><br><span class="line">  summary: Get one or multiple random fields from a hash</span><br><span class="line">  since: 6.2.0</span><br><span class="line"></span><br><span class="line">  HSCAN key cursor [MATCH pattern] [COUNT count]</span><br><span class="line">  summary: Incrementally iterate hash fields and associated values</span><br><span class="line">  since: 2.8.0</span><br><span class="line"></span><br><span class="line">  HSET key field value [field value ...]</span><br><span class="line">  summary: Set the string value of a hash field</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  HSETNX key field value</span><br><span class="line">  summary: Set the value of a hash field, only if the field does not exist</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  HSTRLEN key field</span><br><span class="line">  summary: Get the length of the value of a hash field</span><br><span class="line">  since: 3.2.0</span><br><span class="line"></span><br><span class="line">  HVALS key</span><br><span class="line">  summary: Get all the values in a hash</span><br><span class="line">  since: 2.0.0</span><br></pre></td></tr></table></figure>

<h3 id="set"><a href="#set" class="headerlink" title="@set"></a>@set</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">help @set</span><br><span class="line"></span><br><span class="line">  SADD key member [member ...]</span><br><span class="line">  summary: Add one or more members to a set</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  SCARD key</span><br><span class="line">  summary: Get the number of members in a set</span><br><span class="line">  since: 1.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 获取差集，数据源来自第一个<span class="built_in">set</span></span></span><br><span class="line">  SDIFF key [key ...]</span><br><span class="line">  summary: Subtract multiple sets</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  SDIFFSTORE destination key [key ...]</span><br><span class="line">  summary: Subtract multiple sets and store the resulting set in a key</span><br><span class="line">  since: 1.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 获取交集</span></span><br><span class="line">  SINTER key [key ...]</span><br><span class="line">  summary: Intersect multiple sets</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  SINTERSTORE destination key [key ...]</span><br><span class="line">  summary: Intersect multiple sets and store the resulting set in a key</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  SISMEMBER key member</span><br><span class="line">  summary: Determine if a given value is a member of a set</span><br><span class="line">  since: 1.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 获取<span class="built_in">set</span>中的所有元素</span></span><br><span class="line">  SMEMBERS key</span><br><span class="line">  summary: Get all the members in a set</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  SMISMEMBER key member [member ...]</span><br><span class="line">  summary: Returns the membership associated with the given elements for a set</span><br><span class="line">  since: 6.2.0</span><br><span class="line"></span><br><span class="line">  SMOVE source destination member</span><br><span class="line">  summary: Move a member from one set to another</span><br><span class="line">  since: 1.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 取出一个</span></span><br><span class="line">  SPOP key [count]</span><br><span class="line">  summary: Remove and return one or multiple random members from a set</span><br><span class="line">  since: 1.0.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 正数：随机取出去重的结果集，不能超过已有集；负数：随机取出带重复的结果集</span></span><br><span class="line">  SRANDMEMBER key [count]</span><br><span class="line">  summary: Get one or multiple random members from a set</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  SREM key member [member ...]</span><br><span class="line">  summary: Remove one or more members from a set</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  SSCAN key cursor [MATCH pattern] [COUNT count]</span><br><span class="line">  summary: Incrementally iterate Set elements</span><br><span class="line">  since: 2.8.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 获取并集</span></span><br><span class="line">  SUNION key [key ...]</span><br><span class="line">  summary: Add multiple sets</span><br><span class="line">  since: 1.0.0</span><br><span class="line"></span><br><span class="line">  SUNIONSTORE destination key [key ...]</span><br><span class="line">  summary: Add multiple sets and store the resulting set in a key</span><br><span class="line">  since: 1.0.0</span><br></pre></td></tr></table></figure>

<h3 id="sorted-set"><a href="#sorted-set" class="headerlink" title="@sorted_set"></a>@sorted_set</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">@sorted_set</span><br><span class="line"></span><br><span class="line">  BZPOPMAX key [key ...] timeout</span><br><span class="line">  summary: Remove and return the member with the highest score from one or more sorted sets, or block until one is available</span><br><span class="line">  since: 5.0.0</span><br><span class="line"></span><br><span class="line">  BZPOPMIN key [key ...] timeout</span><br><span class="line">  summary: Remove and return the member with the lowest score from one or more sorted sets, or block until one is available</span><br><span class="line">  since: 5.0.0</span><br><span class="line"></span><br><span class="line">  ZADD key [NX|XX] [GT|LT] [CH] [INCR] score member [score member ...]</span><br><span class="line">  summary: Add one or more members to a sorted set, or update its score if it already exists</span><br><span class="line">  since: 1.2.0</span><br><span class="line"></span><br><span class="line">  ZCARD key</span><br><span class="line">  summary: Get the number of members in a sorted set</span><br><span class="line">  since: 1.2.0</span><br><span class="line"></span><br><span class="line">  ZCOUNT key min max</span><br><span class="line">  summary: Count the members in a sorted set with scores within the given values</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  ZDIFF numkeys key [key ...] [WITHSCORES]</span><br><span class="line">  summary: Subtract multiple sorted sets</span><br><span class="line">  since: 6.2.0</span><br><span class="line"></span><br><span class="line">  ZDIFFSTORE destination numkeys key [key ...]</span><br><span class="line">  summary: Subtract multiple sorted sets and store the resulting sorted set in a new key</span><br><span class="line">  since: 6.2.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 增加元素的分值</span></span><br><span class="line">  ZINCRBY key increment member</span><br><span class="line">  summary: Increment the score of a member in a sorted set</span><br><span class="line">  since: 1.2.0</span><br><span class="line"></span><br><span class="line">  ZINTER numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX] [WITHSCORES]</span><br><span class="line">  summary: Intersect multiple sorted sets</span><br><span class="line">  since: 6.2.0</span><br><span class="line"></span><br><span class="line">  ZINTERSTORE destination numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX]</span><br><span class="line">  summary: Intersect multiple sorted sets and store the resulting sorted set in a new key</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  ZLEXCOUNT key min max</span><br><span class="line">  summary: Count the number of members in a sorted set between a given lexicographical range</span><br><span class="line">  since: 2.8.9</span><br><span class="line"></span><br><span class="line">  ZMSCORE key member [member ...]</span><br><span class="line">  summary: Get the score associated with the given members in a sorted set</span><br><span class="line">  since: 6.2.0</span><br><span class="line"></span><br><span class="line">  ZPOPMAX key [count]</span><br><span class="line">  summary: Remove and return members with the highest scores in a sorted set</span><br><span class="line">  since: 5.0.0</span><br><span class="line"></span><br><span class="line">  ZPOPMIN key [count]</span><br><span class="line">  summary: Remove and return members with the lowest scores in a sorted set</span><br><span class="line">  since: 5.0.0</span><br><span class="line"></span><br><span class="line">  ZRANDMEMBER key [count [WITHSCORES]]</span><br><span class="line">  summary: Get one or multiple random elements from a sorted set</span><br><span class="line">  since: 6.2.0</span><br><span class="line"></span><br><span class="line">  ZRANGE key min max [BYSCORE|BYLEX] [REV] [LIMIT offset count] [WITHSCORES]</span><br><span class="line">  summary: Return a range of members in a sorted set</span><br><span class="line">  since: 1.2.0</span><br><span class="line"></span><br><span class="line">  ZRANGEBYLEX key min max [LIMIT offset count]</span><br><span class="line">  summary: Return a range of members in a sorted set, by lexicographical range</span><br><span class="line">  since: 2.8.9</span><br><span class="line"></span><br><span class="line">  ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]</span><br><span class="line">  summary: Return a range of members in a sorted set, by score</span><br><span class="line">  since: 1.0.5</span><br><span class="line"></span><br><span class="line">  ZRANGESTORE dst src min max [BYSCORE|BYLEX] [REV] [LIMIT offset count]</span><br><span class="line">  summary: Store a range of members from sorted set into another key</span><br><span class="line">  since: 6.2.0</span><br><span class="line"></span><br><span class="line">  ZRANK key member</span><br><span class="line">  summary: Determine the index of a member in a sorted set</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  ZREM key member [member ...]</span><br><span class="line">  summary: Remove one or more members from a sorted set</span><br><span class="line">  since: 1.2.0</span><br><span class="line"></span><br><span class="line">  ZREMRANGEBYLEX key min max</span><br><span class="line">  summary: Remove all members in a sorted set between the given lexicographical range</span><br><span class="line">  since: 2.8.9</span><br><span class="line"></span><br><span class="line">  ZREMRANGEBYRANK key start stop</span><br><span class="line">  summary: Remove all members in a sorted set within the given indexes</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  ZREMRANGEBYSCORE key min max</span><br><span class="line">  summary: Remove all members in a sorted set within the given scores</span><br><span class="line">  since: 1.2.0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> REV：reverse表示倒序</span></span><br><span class="line">  ZREVRANGE key start stop [WITHSCORES]</span><br><span class="line">  summary: Return a range of members in a sorted set, by index, with scores ordered from high to low</span><br><span class="line">  since: 1.2.0</span><br><span class="line"></span><br><span class="line">  ZREVRANGEBYLEX key max min [LIMIT offset count]</span><br><span class="line">  summary: Return a range of members in a sorted set, by lexicographical range, ordered from higher to lower strings.</span><br><span class="line">  since: 2.8.9</span><br><span class="line"></span><br><span class="line">  ZREVRANGEBYSCORE key max min [WITHSCORES] [LIMIT offset count]</span><br><span class="line">  summary: Return a range of members in a sorted set, by score, with scores ordered from high to low</span><br><span class="line">  since: 2.2.0</span><br><span class="line"></span><br><span class="line">  ZREVRANK key member</span><br><span class="line">  summary: Determine the index of a member in a sorted set, with scores ordered from high to low</span><br><span class="line">  since: 2.0.0</span><br><span class="line"></span><br><span class="line">  ZSCAN key cursor [MATCH pattern] [COUNT count]</span><br><span class="line">  summary: Incrementally iterate sorted sets elements and associated scores</span><br><span class="line">  since: 2.8.0</span><br><span class="line"></span><br><span class="line">  ZSCORE key member</span><br><span class="line">  summary: Get the score associated with the given member in a sorted set</span><br><span class="line">  since: 1.2.0</span><br><span class="line"></span><br><span class="line">  ZUNION numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX] [WITHSCORES]</span><br><span class="line">  summary: Add multiple sorted sets</span><br><span class="line">  since: 6.2.0</span><br><span class="line"></span><br><span class="line">  ZUNIONSTORE destination numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX]</span><br><span class="line">  summary: Add multiple sorted sets and store the resulting sorted set in a new key</span><br><span class="line">  since: 2.0.0</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>自定义动态代理与JDK动态代理</title>
    <url>/2021/05/13/%E5%B0%8F%E7%AA%A5JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<h2 id="什么是动态代理"><a href="#什么是动态代理" class="headerlink" title="什么是动态代理"></a>什么是动态代理</h2><p>动态代理是在运行期利用 <em>JVM</em> 的反射机制生成代理类，可以在不需要知道具体被代理类的情况下编写代理规则，能避免因大量使用静态代理造成的类的急剧膨胀。</p>
<span id="more"></span>

<h2 id="自定义动态代理"><a href="#自定义动态代理" class="headerlink" title="自定义动态代理"></a>自定义动态代理</h2><h3 id="MyProxy"><a href="#MyProxy" class="headerlink" title="MyProxy"></a>MyProxy</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.custom.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.tools.JavaCompiler;</span><br><span class="line"><span class="keyword">import</span> javax.tools.StandardJavaFileManager;</span><br><span class="line"><span class="keyword">import</span> javax.tools.ToolProvider;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProxy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String Ln = <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String Tab = <span class="string">&quot;\t&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(MyClassLoader loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          Class&lt;?&gt;[] interfaceName,</span></span></span><br><span class="line"><span class="params"><span class="function">                                          MyInvocationHandler h)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、动态生成一个.java的源文件</span></span><br><span class="line">        String proxy = generateCode(interfaceName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、把生成的这个.java源文件保存在磁盘上</span></span><br><span class="line">        String filePath = MyProxy.class.getResource(<span class="string">&quot;&quot;</span>).getPath();</span><br><span class="line">        File file = <span class="keyword">new</span> File(filePath + <span class="string">&quot;$Proxy0.java&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists())&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                file.createNewFile();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        FileWriter fileWriter = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileWriter = <span class="keyword">new</span> FileWriter(file);</span><br><span class="line">            fileWriter.write(proxy);</span><br><span class="line">            fileWriter.flush();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//3、把这个.java源文件编译成.class文件</span></span><br><span class="line">            <span class="comment">// 创建一个java文件编译器对象</span></span><br><span class="line">            JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();</span><br><span class="line">            <span class="comment">// java源代码文件管理器</span></span><br><span class="line">            StandardJavaFileManager fileManager = compiler.getStandardFileManager(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// java源文件的一个迭代器对象</span></span><br><span class="line">            Iterable iterable = fileManager.getJavaFileObjects(file);</span><br><span class="line">            <span class="comment">// 获取一个编译的任务</span></span><br><span class="line">            JavaCompiler.CompilationTask task = compiler.getTask(<span class="keyword">null</span>, fileManager, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, iterable);</span><br><span class="line">            <span class="comment">// 执行编译</span></span><br><span class="line">            task.call();</span><br><span class="line">            <span class="comment">// 关闭文件管理器</span></span><br><span class="line">            fileManager.close();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//4、把编译后的.class文件加载到jvm内存中</span></span><br><span class="line">            Class clazz = loader.findClass(<span class="string">&quot;$Proxy0&quot;</span>);</span><br><span class="line">            </span><br><span class="line"><span class="comment">//			  不采用自定义ClassLoader的方式加载</span></span><br><span class="line"><span class="comment">//            URLClassLoader urlClassLoader = new URLClassLoader(new URL[]&#123;new URL(&quot;file:D:\\ideawork\\MySpring\\SpringDemo\\proxyCustom\\target\\classes&quot;)&#125;);</span></span><br><span class="line"><span class="comment">//            Class clazz = urlClassLoader.loadClass(&quot;com.custom.proxy.$Proxy0&quot;);</span></span><br><span class="line">            <span class="comment">//5、根据加载到jvm中的.class字节码文件生成Class类，然后创建Class类的对象</span></span><br><span class="line">            Constructor constructor = clazz.getConstructor(MyInvocationHandler.class);</span><br><span class="line">            <span class="keyword">return</span> constructor.newInstance(h);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fileWriter.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateCode</span><span class="params">(Class&lt;?&gt;[] interfances)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        sb.append(<span class="string">&quot;package com.custom.proxy;&quot;</span> + Ln);</span><br><span class="line">        sb.append(<span class="string">&quot;import java.lang.reflect.Method;&quot;</span> + Ln);</span><br><span class="line">        sb.append(<span class="string">&quot;import com.custom.proxy.MyInvocationHandler;&quot;</span> + Ln);</span><br><span class="line">        sb.append(<span class="string">&quot;public class $Proxy0 implements &quot;</span> + interfances[<span class="number">0</span>].getName() + <span class="string">&quot;&#123;&quot;</span> + Ln);</span><br><span class="line">        sb.append(Tab + <span class="string">&quot;private MyInvocationHandler h;&quot;</span> + Ln);</span><br><span class="line">        sb.append(Tab + <span class="string">&quot;public $Proxy0(MyInvocationHandler h)&#123;&quot;</span> + Ln);</span><br><span class="line">        sb.append(Tab + Tab + <span class="string">&quot;this.h = h;&quot;</span> + Ln);</span><br><span class="line">        sb.append(Tab + <span class="string">&quot;&#125;&quot;</span> + Ln);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Method m : interfances[<span class="number">0</span>].getMethods()) &#123;</span><br><span class="line">            sb.append(Tab + <span class="string">&quot;public &quot;</span> + m.getReturnType().getName() + <span class="string">&quot; &quot;</span> + m.getName() + <span class="string">&quot;() &#123;&quot;</span> + Ln);</span><br><span class="line">            sb.append(Tab + Tab + <span class="string">&quot;try &#123;&quot;</span> + Ln);</span><br><span class="line">            sb.append(Tab + Tab + Tab + <span class="string">&quot;Method m = &quot;</span> + interfances[<span class="number">0</span>].getName() + <span class="string">&quot;.class.getMethod(\&quot;&quot;</span> + m.getName() + <span class="string">&quot;\&quot;);&quot;</span> + Ln);</span><br><span class="line">            sb.append(Tab + Tab + Tab + <span class="string">&quot;h.invoke(this, m, null);&quot;</span> + Ln);</span><br><span class="line"><span class="comment">//            sb.append(Tab + Tab + Tab + &quot;return (&quot; + m.getReturnType().getName() + &quot;)h.invoke(this, m, null);&quot; + Ln);</span></span><br><span class="line">            sb.append(Tab + Tab + <span class="string">&quot;&#125; catch (Throwable e) &#123;&quot;</span> + Ln);</span><br><span class="line">            sb.append(Tab + Tab + Tab + <span class="string">&quot;e.printStackTrace();&quot;</span> + Ln);</span><br><span class="line">            sb.append(Tab + Tab + <span class="string">&quot;&#125;&quot;</span> + Ln);</span><br><span class="line">            sb.append(Tab + <span class="string">&quot;&#125;&quot;</span> + Ln);</span><br><span class="line">            sb.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="MyClassLoader"><a href="#MyClassLoader" class="headerlink" title="MyClassLoader"></a>MyClassLoader</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.custom.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义一个类加载器</span></span><br><span class="line"><span class="comment"> * bootstrap ClassLoader  --jdk/jre/目录下的jar包加载</span></span><br><span class="line"><span class="comment"> * ext ClassLoader  --jdk/ext/目录下的jar包加载</span></span><br><span class="line"><span class="comment"> * App ClassLoader  --我们应用的ClassLoader</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> File classPathFile;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String classPath = MyClassLoader.class.getResource(<span class="string">&quot;&quot;</span>).getPath();</span><br><span class="line">        <span class="keyword">this</span>.classPathFile = <span class="keyword">new</span> File(classPath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (classPathFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">            File classFile = <span class="keyword">new</span> File(classPathFile + <span class="string">&quot;\\&quot;</span> + name.replace(<span class="string">&quot;\\.&quot;</span>, <span class="string">&quot;/&quot;</span>) + <span class="string">&quot;.class&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (classFile.exists()) &#123;</span><br><span class="line">                FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">                ByteArrayOutputStream bos = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fis = <span class="keyword">new</span> FileInputStream(classFile);</span><br><span class="line">                    <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">                    bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                    <span class="keyword">int</span> len;</span><br><span class="line">                    <span class="keyword">while</span> ((len = fis.read(bytes)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                        bos.write(bytes, <span class="number">0</span>, len);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> defineClass(<span class="keyword">null</span>, bos.toByteArray(), <span class="number">0</span>, bos.size());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        fis.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        bos.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="MyInvocationHandler"><a href="#MyInvocationHandler" class="headerlink" title="MyInvocationHandler"></a>MyInvocationHandler</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.custom.proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyInvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="JDK动态代理源码分析"><a href="#JDK动态代理源码分析" class="headerlink" title="JDK动态代理源码分析"></a>JDK动态代理源码分析</h2><h3 id="Object-proxy-Proxy-newProxyInstance"><a href="#Object-proxy-Proxy-newProxyInstance" class="headerlink" title="Object proxy = Proxy.newProxyInstance(..);"></a>Object proxy = Proxy.newProxyInstance(..);</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         Class&lt;?&gt;[] interfaces,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         InvocationHandler h)</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> IllegalArgumentException</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       Objects.requireNonNull(h);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();</span><br><span class="line">       <span class="keyword">final</span> SecurityManager sm = System.getSecurityManager();</span><br><span class="line">       <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">           checkProxyAccess(Reflection.getCallerClass(), loader, intfs);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 查找或生成指定的代理类</span></span><br><span class="line"><span class="comment">        * Look up or generate the designated proxy class.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 使用指定的调用处理程序调用其构造函数</span></span><br><span class="line"><span class="comment">        * Invoke its constructor with the designated invocation handler.</span></span><br><span class="line"><span class="comment">        * 解释：将使用者写的InvacationHandler h 作为构造函数的参数传给代理对象</span></span><br><span class="line"><span class="comment">        * 		代理对象调用h.invoke()方法实现对target的代理和方法的增强</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">//检查创建代理类所需的权限</span></span><br><span class="line">               checkNewProxyPermission(Reflection.getCallerClass(), cl);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</span><br><span class="line">           <span class="keyword">final</span> InvocationHandler ih = h;</span><br><span class="line">           <span class="keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) &#123;</span><br><span class="line">               AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">                   <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                       cons.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> cons.newInstance(<span class="keyword">new</span> Object[]&#123;h&#125;);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IllegalAccessException|InstantiationException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString(), e);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">           Throwable t = e.getCause();</span><br><span class="line">           <span class="keyword">if</span> (t <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">               <span class="keyword">throw</span> (RuntimeException) t;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(t.toString(), t);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString(), e);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Class-lt-gt-cl-getProxyClass0-loader-intfs"><a href="#Class-lt-gt-cl-getProxyClass0-loader-intfs" class="headerlink" title="Class&lt;?&gt; cl = getProxyClass0(loader, intfs);"></a>Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成代理类。在调用之前必须调用checkProxyAccess方法来执行权限检查</span></span><br><span class="line"><span class="comment">    * Generate a proxy class.  Must call the checkProxyAccess method</span></span><br><span class="line"><span class="comment">    * to perform permission checks before calling this.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> Class&lt;?&gt; getProxyClass0(ClassLoader loader,</span><br><span class="line">                                          Class&lt;?&gt;... interfaces) &#123;</span><br><span class="line">       <span class="keyword">if</span> (interfaces.length &gt; <span class="number">65535</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;interface limit exceeded&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// If the proxy class defined by the given loader implementing</span></span><br><span class="line">       <span class="comment">// the given interfaces exists, this will simply return the cached copy;</span></span><br><span class="line">       <span class="comment">// otherwise, it will create the proxy class via the ProxyClassFactory</span></span><br><span class="line">       <span class="comment">// 简单所就是有缓存读缓存，没缓存就生成</span></span><br><span class="line">       <span class="keyword">return</span> proxyClassCache.get(loader, interfaces);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="proxyClassCache-get-loader-interfaces"><a href="#proxyClassCache-get-loader-interfaces" class="headerlink" title="proxyClassCache.get(loader, interfaces);"></a>proxyClassCache.get(loader, interfaces);</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Look-up the value through the cache. This always evaluates the</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@code</span> subKeyFactory&#125; function and optionally evaluates</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@code</span> valueFactory&#125; function if there is no entry in the cache for given</span></span><br><span class="line"><span class="comment">    * pair of (key, subKey) or the entry has already been cleared.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> key       possibly null key</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> parameter parameter used together with key to create sub-key and</span></span><br><span class="line"><span class="comment">    *                  value (should not be null)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the cached value (never null)</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> NullPointerException if &#123;<span class="doctag">@code</span> parameter&#125; passed in or</span></span><br><span class="line"><span class="comment">    *                              &#123;<span class="doctag">@code</span> sub-key&#125; calculated by</span></span><br><span class="line"><span class="comment">    *                              &#123;<span class="doctag">@code</span> subKeyFactory&#125; or &#123;<span class="doctag">@code</span> value&#125;</span></span><br><span class="line"><span class="comment">    *                              calculated by &#123;<span class="doctag">@code</span> valueFactory&#125; is null.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(K key, P parameter)</span> </span>&#123;</span><br><span class="line">       Objects.requireNonNull(parameter);</span><br><span class="line"></span><br><span class="line">       expungeStaleEntries();</span><br><span class="line"></span><br><span class="line">       Object cacheKey = CacheKey.valueOf(key, refQueue);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// lazily install the 2nd level valuesMap for the particular cacheKey</span></span><br><span class="line">       ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; valuesMap = map.get(cacheKey);</span><br><span class="line">       <span class="keyword">if</span> (valuesMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">           ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; oldValuesMap</span><br><span class="line">               = map.putIfAbsent(cacheKey,</span><br><span class="line">                                 valuesMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;());</span><br><span class="line">           <span class="keyword">if</span> (oldValuesMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">               valuesMap = oldValuesMap;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// create subKey and retrieve the possible Supplier&lt;V&gt; stored by that</span></span><br><span class="line">       <span class="comment">// subKey from valuesMap</span></span><br><span class="line">       Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter));</span><br><span class="line">       Supplier&lt;V&gt; supplier = valuesMap.get(subKey);</span><br><span class="line">       Factory factory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (supplier != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">// supplier might be a Factory or a CacheValue&lt;V&gt; instance</span></span><br><span class="line">               <span class="comment">// 这一步为获得代理对象的Class</span></span><br><span class="line">               V value = supplier.get();</span><br><span class="line">               <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">return</span> value;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// else no supplier in cache</span></span><br><span class="line">           <span class="comment">// or a supplier that returned null (could be a cleared CacheValue</span></span><br><span class="line">           <span class="comment">// or a Factory that wasn&#x27;t successful in installing the CacheValue)</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">// lazily construct a Factory</span></span><br><span class="line">           <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">               factory = <span class="keyword">new</span> Factory(key, parameter, subKey, valuesMap);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (supplier == <span class="keyword">null</span>) &#123;</span><br><span class="line">               supplier = valuesMap.putIfAbsent(subKey, factory);</span><br><span class="line">               <span class="keyword">if</span> (supplier == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="comment">// successfully installed Factory</span></span><br><span class="line">                   supplier = factory;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// else retry with winning supplier</span></span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (valuesMap.replace(subKey, supplier, factory)) &#123;</span><br><span class="line">                   <span class="comment">// successfully replaced</span></span><br><span class="line">                   <span class="comment">// cleared CacheEntry / unsuccessful Factory</span></span><br><span class="line">                   <span class="comment">// with our Factory</span></span><br><span class="line">                   supplier = factory;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// retry with current supplier</span></span><br><span class="line">                   supplier = valuesMap.get(subKey);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="V-value-supplier-get"><a href="#V-value-supplier-get" class="headerlink" title="V value = supplier.get();"></a>V value = supplier.get();</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="comment">//WeakCache的内部类</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> <span class="keyword">implements</span> <span class="title">Supplier</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> K key;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> P parameter;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> Object subKey;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; valuesMap;</span><br><span class="line"></span><br><span class="line">       Factory(K key, P parameter, Object subKey,</span><br><span class="line">               ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; valuesMap) &#123;</span><br><span class="line">           <span class="keyword">this</span>.key = key;</span><br><span class="line">           <span class="keyword">this</span>.parameter = parameter;</span><br><span class="line">           <span class="keyword">this</span>.subKey = subKey;</span><br><span class="line">           <span class="keyword">this</span>.valuesMap = valuesMap;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="comment">// serialize access</span></span><br><span class="line">           <span class="comment">// re-check</span></span><br><span class="line">           Supplier&lt;V&gt; supplier = valuesMap.get(subKey);</span><br><span class="line">           <span class="keyword">if</span> (supplier != <span class="keyword">this</span>) &#123;</span><br><span class="line">               <span class="comment">// something changed while we were waiting:</span></span><br><span class="line">               <span class="comment">// might be that we were replaced by a CacheValue</span></span><br><span class="line">               <span class="comment">// or were removed because of failure -&gt;</span></span><br><span class="line">               <span class="comment">// return null to signal WeakCache.get() to retry</span></span><br><span class="line">               <span class="comment">// the loop</span></span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// else still us (supplier == this)</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">// create new value</span></span><br><span class="line">           V value = <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">//Objects.requireNonNull()只是判断是否非空</span></span><br><span class="line">               <span class="comment">//valueFactory.apply(key, parameter)中key为类加载器，parameter为接口的类对象</span></span><br><span class="line">               value = Objects.requireNonNull(valueFactory.apply(key, parameter));</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123; <span class="comment">// remove us on failure</span></span><br><span class="line">                   valuesMap.remove(subKey, <span class="keyword">this</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// the only path to reach here is with non-null value</span></span><br><span class="line">           <span class="keyword">assert</span> value != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// wrap value with CacheValue (WeakReference)</span></span><br><span class="line">           CacheValue&lt;V&gt; cacheValue = <span class="keyword">new</span> CacheValue&lt;&gt;(value);</span><br><span class="line"></span><br><span class="line">           <span class="comment">// put into reverseMap</span></span><br><span class="line">           reverseMap.put(cacheValue, Boolean.TRUE);</span><br><span class="line"></span><br><span class="line">           <span class="comment">// try replacing us with CacheValue (this should always succeed)</span></span><br><span class="line">           <span class="keyword">if</span> (!valuesMap.replace(subKey, <span class="keyword">this</span>, cacheValue)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">&quot;Should not reach here&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// successfully replaced us with new CacheValue -&gt; return the value</span></span><br><span class="line">           <span class="comment">// wrapped by it</span></span><br><span class="line">           <span class="keyword">return</span> value;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * A factory function that generates, defines and returns the proxy class given</span></span><br><span class="line"><span class="comment">    * the ClassLoader and array of interfaces.</span></span><br><span class="line"><span class="comment">    * 指定类加载器和接口生成代理类.class的工厂</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyClassFactory</span></span></span><br><span class="line"><span class="class">       <span class="keyword">implements</span> <span class="title">BiFunction</span>&lt;<span class="title">ClassLoader</span>, <span class="title">Class</span>&lt;?&gt;[], <span class="title">Class</span>&lt;?&gt;&gt;</span></span><br><span class="line"><span class="class">   </span>&#123;</span><br><span class="line">       <span class="comment">// prefix for all proxy class names</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String proxyClassNamePrefix = <span class="string">&quot;$Proxy&quot;</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// next number to use for generation of unique proxy class names</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLong nextUniqueNumber = <span class="keyword">new</span> AtomicLong();</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="keyword">public</span> Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) &#123;</span><br><span class="line"></span><br><span class="line">           Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = <span class="keyword">new</span> IdentityHashMap&lt;&gt;(interfaces.length);</span><br><span class="line">           <span class="keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;</span><br><span class="line">               <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * Verify that the class loader resolves the name of this</span></span><br><span class="line"><span class="comment">                * interface to the same Class object.</span></span><br><span class="line"><span class="comment">                * 验证类加载器是否解析此接口名到同一个类对象</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">               Class&lt;?&gt; interfaceClass = <span class="keyword">null</span>;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   interfaceClass = Class.forName(intf.getName(), <span class="keyword">false</span>, loader);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (interfaceClass != intf) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                       intf + <span class="string">&quot; is not visible from class loader&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * Verify that the Class object actually represents an</span></span><br><span class="line"><span class="comment">                * interface.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">               <span class="keyword">if</span> (!interfaceClass.isInterface()) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                       interfaceClass.getName() + <span class="string">&quot; is not an interface&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * Verify that this interface is not a duplicate.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">               <span class="keyword">if</span> (interfaceSet.put(interfaceClass, Boolean.TRUE) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                       <span class="string">&quot;repeated interface: &quot;</span> + interfaceClass.getName());</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           String proxyPkg = <span class="keyword">null</span>;     <span class="comment">// package to define proxy class in</span></span><br><span class="line">           <span class="keyword">int</span> accessFlags = Modifier.PUBLIC | Modifier.FINAL;</span><br><span class="line"></span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Record the package of a non-public proxy interface so that the</span></span><br><span class="line"><span class="comment">            * proxy class will be defined in the same package.  Verify that</span></span><br><span class="line"><span class="comment">            * all non-public proxy interfaces are in the same package.</span></span><br><span class="line"><span class="comment">            * 记录非公共代理接口所在的包，以便将代理类定义在同一包中</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;</span><br><span class="line">               <span class="keyword">int</span> flags = intf.getModifiers();</span><br><span class="line">               <span class="keyword">if</span> (!Modifier.isPublic(flags)) &#123;</span><br><span class="line">                   accessFlags = Modifier.FINAL;</span><br><span class="line">                   String name = intf.getName();</span><br><span class="line">                   <span class="keyword">int</span> n = name.lastIndexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">                   String pkg = ((n == -<span class="number">1</span>) ? <span class="string">&quot;&quot;</span> : name.substring(<span class="number">0</span>, n + <span class="number">1</span>));</span><br><span class="line">                   <span class="keyword">if</span> (proxyPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">                       proxyPkg = pkg;</span><br><span class="line">                   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pkg.equals(proxyPkg)) &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                           <span class="string">&quot;non-public interfaces from different packages&quot;</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (proxyPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">// if no non-public proxy interfaces, use com.sun.proxy package</span></span><br><span class="line">               proxyPkg = ReflectUtil.PROXY_PACKAGE + <span class="string">&quot;.&quot;</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Choose a name for the proxy class to generate.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="keyword">long</span> num = nextUniqueNumber.getAndIncrement();</span><br><span class="line">           String proxyName = proxyPkg + proxyClassNamePrefix + num;</span><br><span class="line"></span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Generate the specified proxy class.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="comment">//动态生成class的byte数组，通过字符串拼接jvm指令</span></span><br><span class="line">           <span class="keyword">byte</span>[] proxyClassFile = ProxyGenerator.generateProxyClass(</span><br><span class="line">               proxyName, interfaces, accessFlags);</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">//将生成的byte数组加载进jvm，此方法为native方法，由C编写</span></span><br><span class="line">               <span class="keyword">return</span> defineClass0(loader, proxyName,</span><br><span class="line">                                   proxyClassFile, <span class="number">0</span>, proxyClassFile.length);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (ClassFormatError e) &#123;</span><br><span class="line">               <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * A ClassFormatError here means that (barring bugs in the</span></span><br><span class="line"><span class="comment">                * proxy class generation code) there was some other</span></span><br><span class="line"><span class="comment">                * invalid aspect of the arguments supplied to the proxy</span></span><br><span class="line"><span class="comment">                * class creation (such as virtual machine limitations</span></span><br><span class="line"><span class="comment">                * exceeded).</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e.toString());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li><p>自定义动态代理：</p>
<p>​    动态拼接字符串生成代理对象的.java文件 -&gt; 将.java文件编译成.class文件 -&gt; 通过类加载器加载.class文件进jvm -&gt; 反射生成代理对象</p>
</li>
<li><p>jdk动态代理：</p>
<p>​    生成.clsss文件的byte[]数组，直接将数组加载进jvm -&gt; 反射生成代理对象</p>
</li>
<li><p>jdk动态代理无需涉及io流，所以比自定义动态代理高效。</p>
</li>
</ul>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>动态代理</tag>
      </tags>
  </entry>
</search>
