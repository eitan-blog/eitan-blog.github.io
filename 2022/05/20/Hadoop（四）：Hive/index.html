<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;example.com&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Muse&quot;,&quot;version&quot;:&quot;8.4.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;right&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:true,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:true,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;},&quot;path&quot;:&quot;&#x2F;search.xml&quot;,&quot;localsearch&quot;:{&quot;enable&quot;:true,&quot;trigger&quot;:&quot;auto&quot;,&quot;top_n_per_article&quot;:1,&quot;unescape&quot;:false,&quot;preload&quot;:false}}</script>
<meta name="description" content="本文为学习笔记，对应视频教程来自黑马程序员Hive教程 Hive函数入门函数概述123456-- 显示所有的函数和运算符SHOW FUNCTIONS;-- 查看运算符或者函数的使用说明DESCRIBE FUNCTION avg;-- 使用extended 可以查看更加详细的使用说明DESCRIBE FUNCTION EXTENDED avg;  内置函数String Functions 字符串函数">
<meta property="og:type" content="article">
<meta property="og:title" content="Hadoop（四）：Hive">
<meta property="og:url" content="http://example.com/2022/05/20/Hadoop%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9AHive/index.html">
<meta property="og:site_name" content="Eitan&#39;s Blog">
<meta property="og:description" content="本文为学习笔记，对应视频教程来自黑马程序员Hive教程 Hive函数入门函数概述123456-- 显示所有的函数和运算符SHOW FUNCTIONS;-- 查看运算符或者函数的使用说明DESCRIBE FUNCTION avg;-- 使用extended 可以查看更加详细的使用说明DESCRIBE FUNCTION EXTENDED avg;  内置函数String Functions 字符串函数">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/xyq-material/image/master/blog/20220520193317.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xyq-material/image/master/blog/20220516141542.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xyq-material/image/master/blog/20220518172138.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xyq-material/image/master/blog/20220518172819.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xyq-material/image/master/blog/20220519235158.png">
<meta property="article:published_time" content="2022-05-20T11:54:56.738Z">
<meta property="article:modified_time" content="2022-05-20T12:04:17.786Z">
<meta property="article:author" content="Eitan">
<meta property="article:tag" content="hadoop">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/xyq-material/image/master/blog/20220520193317.png">


<link rel="canonical" href="http://example.com/2022/05/20/Hadoop%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9AHive/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;http:&#x2F;&#x2F;example.com&#x2F;2022&#x2F;05&#x2F;20&#x2F;Hadoop%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9AHive&#x2F;&quot;,&quot;path&quot;:&quot;2022&#x2F;05&#x2F;20&#x2F;Hadoop（四）：Hive&#x2F;&quot;,&quot;title&quot;:&quot;Hadoop（四）：Hive&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>Hadoop（四）：Hive | Eitan's Blog</title><script src="/js/config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">
    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Eitan's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive%E5%87%BD%E6%95%B0%E5%85%A5%E9%97%A8"><span class="nav-number">1.</span> <span class="nav-text">Hive函数入门</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E6%A6%82%E8%BF%B0"><span class="nav-number">1.1.</span> <span class="nav-text">函数概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.</span> <span class="nav-text">内置函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#String-Functions-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.1.</span> <span class="nav-text">String Functions 字符串函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Date-Functions-%E6%97%A5%E6%9C%9F%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.2.</span> <span class="nav-text">Date Functions 日期函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Mathematical-Functions-%E6%95%B0%E5%AD%A6%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.3.</span> <span class="nav-text">Mathematical Functions 数学函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Collection-Functions-%E9%9B%86%E5%90%88%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.4.</span> <span class="nav-text">Collection Functions 集合函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Conditional-Functions-%E6%9D%A1%E4%BB%B6%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.5.</span> <span class="nav-text">Conditional Functions 条件函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Type-Conversion-Functions-%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.6.</span> <span class="nav-text">Type Conversion Functions 类型转换函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Data-Masking-Functions-%E6%95%B0%E6%8D%AE%E8%84%B1%E6%95%8F%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.7.</span> <span class="nav-text">Data Masking Functions 数据脱敏函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.8.</span> <span class="nav-text">其他函数</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0"><span class="nav-number">1.3.</span> <span class="nav-text">用户自定义函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#UDF-%E6%99%AE%E9%80%9A%E5%87%BD%E6%95%B0"><span class="nav-number">1.3.1.</span> <span class="nav-text">UDF 普通函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#UDAF-%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="nav-number">1.3.2.</span> <span class="nav-text">UDAF 聚合函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#UDTF-%E8%A1%A8%E7%94%9F%E6%88%90%E5%87%BD%E6%95%B0"><span class="nav-number">1.3.3.</span> <span class="nav-text">UDTF 表生成函数</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9A%E7%94%A8%E6%88%B7%E8%87%AA%E5%AE%9A%E4%B9%89UDF"><span class="nav-number">1.4.</span> <span class="nav-text">案例：用户自定义UDF</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E6%8F%8F%E8%BF%B0"><span class="nav-number">1.4.1.</span> <span class="nav-text">需求描述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5"><span class="nav-number">1.4.2.</span> <span class="nav-text">实践</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive%E5%87%BD%E6%95%B0%E9%AB%98%E7%BA%A7"><span class="nav-number">2.</span> <span class="nav-text">Hive函数高级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#explode%E5%87%BD%E6%95%B0"><span class="nav-number">2.1.</span> <span class="nav-text">explode函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.1.1.</span> <span class="nav-text">功能介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="nav-number">2.1.2.</span> <span class="nav-text">简单使用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#explode%E4%BD%BF%E7%94%A8%E9%99%90%E5%88%B6%E5%8F%8A%E5%8E%9F%E5%9B%A0"><span class="nav-number">2.1.3.</span> <span class="nav-text">explode使用限制及原因</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Lateral-View%E4%BE%A7%E8%A7%86%E5%9B%BE"><span class="nav-number">2.2.</span> <span class="nav-text">Lateral View侧视图</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5%E5%8F%8A%E5%8E%9F%E7%90%86"><span class="nav-number">2.2.1.</span> <span class="nav-text">概念及原理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95"><span class="nav-number">2.2.2.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B"><span class="nav-number">2.2.3.</span> <span class="nav-text">案例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Aggregation-%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.</span> <span class="nav-text">Aggregation 聚合函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.1.</span> <span class="nav-text">基础聚合函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A2%9E%E5%BC%BA%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="nav-number">2.3.2.</span> <span class="nav-text">增强聚合函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CUBE"><span class="nav-number">2.3.3.</span> <span class="nav-text">CUBE</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Window-functions-%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="nav-number">2.4.</span> <span class="nav-text">Window functions 窗口函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">2.4.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-1"><span class="nav-number">2.4.2.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5-1"><span class="nav-number">2.4.3.</span> <span class="nav-text">实践</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sampling-%E6%8A%BD%E6%A0%B7%E5%87%BD%E6%95%B0"><span class="nav-number">2.5.</span> <span class="nav-text">Sampling 抽样函数</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Random%E9%9A%8F%E6%9C%BA%E6%8A%BD%E6%A0%B7"><span class="nav-number">2.5.1.</span> <span class="nav-text">Random随机抽样</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Block%E5%9D%97%E6%8A%BD%E6%A0%B7"><span class="nav-number">2.5.2.</span> <span class="nav-text">Block块抽样</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Bucket-table%E5%88%86%E6%A1%B6%E8%A1%A8%E6%8A%BD%E6%A0%B7"><span class="nav-number">2.5.3.</span> <span class="nav-text">Bucket table分桶表抽样</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive%E5%87%BD%E6%95%B0%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="nav-number">3.</span> <span class="nav-text">Hive函数应用案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E5%AD%97%E8%8A%82%E5%88%86%E9%9A%94%E7%AC%A6"><span class="nav-number">3.1.</span> <span class="nav-text">多字节分隔符</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">3.1.1.</span> <span class="nav-text">应用场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A%E6%9B%BF%E6%8D%A2%E5%88%86%E5%89%B2%E7%AC%A6"><span class="nav-number">3.1.2.</span> <span class="nav-text">解决方案一：替换分割符</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9ARegexSerDe%E6%AD%A3%E5%88%99%E5%8A%A0%E8%BD%BD"><span class="nav-number">3.1.3.</span> <span class="nav-text">解决方案二：RegexSerDe正则加载</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%B8%89%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89InputFormat"><span class="nav-number">3.1.4.</span> <span class="nav-text">解决方案三：自定义InputFormat</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#URL%E8%A7%A3%E6%9E%90%E5%87%BD%E6%95%B0%E5%8F%8A%E4%BE%A7%E8%A7%86%E5%9B%BE"><span class="nav-number">3.2.</span> <span class="nav-text">URL解析函数及侧视图</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="nav-number">3.2.1.</span> <span class="nav-text">数据准备</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#parse-url"><span class="nav-number">3.2.2.</span> <span class="nav-text">parse_url</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#parse-url-tuple"><span class="nav-number">3.2.3.</span> <span class="nav-text">parse_url_tuple</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%8C%E5%88%97%E8%BD%AC%E6%8D%A2%E5%BA%94%E7%94%A8"><span class="nav-number">3.3.</span> <span class="nav-text">行列转换应用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A1%8C%E8%BD%AC%E5%88%97%EF%BC%9A%E5%A4%9A%E8%A1%8C%E8%BD%AC%E5%A4%9A%E5%88%97"><span class="nav-number">3.3.1.</span> <span class="nav-text">行转列：多行转多列</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A1%8C%E8%BD%AC%E5%88%97%EF%BC%9A%E5%A4%9A%E8%A1%8C%E8%BD%AC%E5%8D%95%E5%88%97"><span class="nav-number">3.3.2.</span> <span class="nav-text">行转列：多行转单列</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%97%E8%BD%AC%E8%A1%8C%EF%BC%9A%E5%A4%9A%E5%88%97%E8%BD%AC%E5%A4%9A%E8%A1%8C"><span class="nav-number">3.3.3.</span> <span class="nav-text">列转行：多列转多行</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%97%E8%BD%AC%E8%A1%8C%EF%BC%9A%E5%8D%95%E5%88%97%E8%BD%AC%E5%A4%9A%E8%A1%8C"><span class="nav-number">3.3.4.</span> <span class="nav-text">列转行：单列转多行</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JSON%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="nav-number">3.4.</span> <span class="nav-text">JSON数据处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9C%80%E6%B1%82"><span class="nav-number">3.4.1.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A%E4%BD%BF%E7%94%A8JSON%E8%A7%A3%E6%9E%90%E5%87%BD%E6%95%B0"><span class="nav-number">3.4.2.</span> <span class="nav-text">方法一：使用JSON解析函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A%E6%8C%87%E5%AE%9A%E8%A7%A3%E6%9E%90JSON%E7%9A%84SerDe"><span class="nav-number">3.4.3.</span> <span class="nav-text">方法二：指定解析JSON的SerDe</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B"><span class="nav-number">3.5.</span> <span class="nav-text">窗口函数应用实例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%9E%E7%BB%AD%E7%99%BB%E9%99%86%E7%94%A8%E6%88%B7"><span class="nav-number">3.5.1.</span> <span class="nav-text">连续登陆用户</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BA%A7%E8%81%94%E7%B4%AF%E5%8A%A0%E6%B1%82%E5%92%8C"><span class="nav-number">3.5.2.</span> <span class="nav-text">级联累加求和</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E7%BB%84TopN"><span class="nav-number">3.5.3.</span> <span class="nav-text">分组TopN</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8B%89%E9%93%BE%E8%A1%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.6.</span> <span class="nav-text">拉链表的设计与实现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8A%9F%E8%83%BD%E4%B8%8E%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-number">3.6.1.</span> <span class="nav-text">功能与应用场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8B%89%E9%93%BE%E8%A1%A8%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.6.2.</span> <span class="nav-text">拉链表实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hive%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">4.</span> <span class="nav-text">Hive性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Hive%E8%A1%A8%E8%AE%BE%E8%AE%A1%E4%BC%98%E5%8C%96"><span class="nav-number">4.1.</span> <span class="nav-text">Hive表设计优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E5%8C%BA%E8%A1%A8"><span class="nav-number">4.1.1.</span> <span class="nav-text">分区表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E6%A1%B6%E8%A1%A8"><span class="nav-number">4.1.2.</span> <span class="nav-text">分桶表</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hive%E8%A1%A8%E6%95%B0%E6%8D%AE%E4%BC%98%E5%8C%96"><span class="nav-number">4.2.</span> <span class="nav-text">Hive表数据优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="nav-number">4.2.1.</span> <span class="nav-text">文件格式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%8E%8B%E7%BC%A9"><span class="nav-number">4.2.2.</span> <span class="nav-text">数据压缩</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E4%BC%98%E5%8C%96"><span class="nav-number">4.2.3.</span> <span class="nav-text">存储优化</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97Job%E6%89%A7%E8%A1%8C%E4%BC%98%E5%8C%96"><span class="nav-number">4.3.</span> <span class="nav-text">计算Job执行优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Explain"><span class="nav-number">4.3.1.</span> <span class="nav-text">Explain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#MapReduce%E5%B1%9E%E6%80%A7%E4%BC%98%E5%8C%96"><span class="nav-number">4.3.2.</span> <span class="nav-text">MapReduce属性优化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Join%E4%BC%98%E5%8C%96"><span class="nav-number">4.3.3.</span> <span class="nav-text">Join优化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E5%99%A8"><span class="nav-number">4.3.4.</span> <span class="nav-text">优化器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%93%E8%AF%8D%E4%B8%8B%E6%8E%A8%EF%BC%88PPD%EF%BC%89"><span class="nav-number">4.3.5.</span> <span class="nav-text">谓词下推（PPD）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C"><span class="nav-number">4.3.6.</span> <span class="nav-text">数据倾斜</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Eitan"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Eitan</p>
  <div class="site-description" itemprop="description">blog用于记忆，大脑擅长思考</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/eitan-blog" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;eitan-blog" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:eitan_blog@163.com" title="E-Mail → mailto:eitan_blog@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>




        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/yourname" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/20/Hadoop%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9AHive/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Eitan">
      <meta itemprop="description" content="blog用于记忆，大脑擅长思考">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Eitan's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Hadoop（四）：Hive
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-20 19:54:56 / 修改时间：20:04:17" itemprop="dateCreated datePublished" datetime="2022-05-20T19:54:56+08:00">2022-05-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Big-Data/" itemprop="url" rel="index"><span itemprop="name">Big Data</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>54k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>49 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>本文为学习笔记，对应视频教程来自<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1L5411u7ae">黑马程序员Hive教程</a></p>
<h3 id="Hive函数入门"><a href="#Hive函数入门" class="headerlink" title="Hive函数入门"></a>Hive函数入门</h3><h4 id="函数概述"><a href="#函数概述" class="headerlink" title="函数概述"></a>函数概述</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 显示所有的函数和运算符</span></span><br><span class="line"><span class="keyword">SHOW</span> FUNCTIONS;</span><br><span class="line"><span class="comment">-- 查看运算符或者函数的使用说明</span></span><br><span class="line"><span class="keyword">DESCRIBE</span> <span class="keyword">FUNCTION</span> avg;</span><br><span class="line"><span class="comment">-- 使用extended 可以查看更加详细的使用说明</span></span><br><span class="line"><span class="keyword">DESCRIBE</span> <span class="keyword">FUNCTION</span> EXTENDED avg;</span><br></pre></td></tr></table></figure>

<h4 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h4><h5 id="String-Functions-字符串函数"><a href="#String-Functions-字符串函数" class="headerlink" title="String Functions 字符串函数"></a>String Functions 字符串函数</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 字符串长度函数：length(str | binary)</span></span><br><span class="line"><span class="keyword">SELECT</span> length(&quot;Facebook&quot;);</span><br><span class="line"><span class="comment">-- 字符串反转函数：reverse</span></span><br><span class="line"><span class="keyword">SELECT</span> reverse(&quot;Facebook&quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 字符串连接函数：concat(str1, str2, ... strN)</span></span><br><span class="line"><span class="keyword">SELECT</span> concat(&quot;abc&quot;,&quot;def&quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 带分隔符字符串连接函数：concat_ws(separator, [string | array(string)]+)</span></span><br><span class="line"><span class="keyword">SELECT</span> concat_ws(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;www&#x27;</span>, <span class="keyword">array</span>(<span class="string">&#x27;facebook&#x27;</span>, <span class="string">&#x27;com&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 字符串截取函数：substr(str, pos[, len]) 或者  substring(str, pos[, len])</span></span><br><span class="line"><span class="comment">-- pos是从1开始的索引，如果为负数则倒着数</span></span><br><span class="line"><span class="keyword">SELECT</span> substr(&quot;Facebook&quot;,<span class="number">-2</span>);</span><br><span class="line"><span class="keyword">SELECT</span> substr(&quot;Facebook&quot;,<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 字符串转大写函数：upper,ucase</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">upper</span>(&quot;Facebook&quot;);</span><br><span class="line"><span class="keyword">SELECT</span> ucase(&quot;Facebook&quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 字符串转小写函数：lower,lcase</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">lower</span>(&quot;Facebook&quot;);</span><br><span class="line"><span class="keyword">SELECT</span> lcase(&quot;Facebook&quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 去空格函数：trim 去除左右两边的空格</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">trim</span>(&quot; facebook &quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 左边去空格函数：ltrim</span></span><br><span class="line"><span class="keyword">SELECT</span> ltrim(&quot; facebook &quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 右边去空格函数：rtrim</span></span><br><span class="line"><span class="keyword">SELECT</span> rtrim(&quot; facebook &quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正则表达式替换函数：regexp_replace(str, regexp, rep)</span></span><br><span class="line"><span class="keyword">SELECT</span> regexp_replace(<span class="string">&#x27;100-200&#x27;</span>, <span class="string">&#x27;(\\d+)&#x27;</span>, <span class="string">&#x27;num&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 正则表达式解析函数：regexp_extract(str, regexp[, idx]) 提取正则匹配到的指定组内容</span></span><br><span class="line"><span class="keyword">SELECT</span> regexp_extract(<span class="string">&#x27;100-200&#x27;</span>, <span class="string">&#x27;(\\d+)-(\\d+)&#x27;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- URL解析函数：parse_url 注意要想一次解析出多个 可以使用parse_url_tuple这个UDTF函数</span></span><br><span class="line"><span class="keyword">SELECT</span> parse_url(<span class="string">&#x27;http://www.facebook.cn/path/p1.php?query=1&#x27;</span>, <span class="string">&#x27;HOST&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- json解析函数：get_json_object</span></span><br><span class="line"><span class="comment">-- $代表当前JSON对象</span></span><br><span class="line"><span class="keyword">SELECT</span> get_json_object(</span><br><span class="line">               <span class="string">&#x27;[&#123;&quot;website&quot;:&quot;www.itcast.cn&quot;,&quot;name&quot;:&quot;allenwoon&quot;&#125;, &#123;&quot;website&quot;:&quot;cloud.itcast.com&quot;,&quot;name&quot;:&quot;carbondata 中文文档&quot;&#125;]&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;$.[1].website&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 空格字符串函数：space(n) 返回指定个数空格</span></span><br><span class="line"><span class="keyword">SELECT</span> space(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 重复字符串函数：repeat(str, n) 重复str字符串n次</span></span><br><span class="line"><span class="keyword">SELECT</span> repeat(&quot;123&quot;, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 返回首字符ascii函数：ascii</span></span><br><span class="line"><span class="comment">-- a对应ASCII 97</span></span><br><span class="line"><span class="keyword">SELECT</span> ascii(&quot;apple&quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 左补足函数：lpad</span></span><br><span class="line"><span class="comment">-- ???hi</span></span><br><span class="line"><span class="keyword">SELECT</span> lpad(<span class="string">&#x27;hi&#x27;</span>, <span class="number">5</span>, <span class="string">&#x27;??&#x27;</span>);</span><br><span class="line"><span class="comment">-- h</span></span><br><span class="line"><span class="keyword">SELECT</span> lpad(<span class="string">&#x27;hi&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;??&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 右补足函数：rpad</span></span><br><span class="line"><span class="keyword">SELECT</span> rpad(<span class="string">&#x27;hi&#x27;</span>, <span class="number">5</span>, <span class="string">&#x27;??&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 分割字符串函数: split(str, regex)</span></span><br><span class="line"><span class="keyword">SELECT</span> split(<span class="string">&#x27;oneAtwoBthreeC&#x27;</span>, <span class="string">&#x27;[ABC]&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 集合查找函数: find_in_set(str,str_array)</span></span><br><span class="line"><span class="keyword">SELECT</span> find_in_set(<span class="string">&#x27;ab&#x27;</span>, <span class="string">&#x27;abc,b,ab,c,def&#x27;</span>);</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h5 id="Date-Functions-日期函数"><a href="#Date-Functions-日期函数" class="headerlink" title="Date Functions 日期函数"></a>Date Functions 日期函数</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 获取当前日期: current_date</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">current_date</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取当前时间戳: current_timestamp</span></span><br><span class="line"><span class="comment">-- 同一查询中对current_timestamp的所有调用均返回相同的值。</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">current_timestamp</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 获取当前UNIX时间戳函数: unix_timestamp</span></span><br><span class="line"><span class="keyword">SELECT</span> unix_timestamp();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- UNIX时间戳转日期函数: from_unixtime</span></span><br><span class="line"><span class="keyword">SELECT</span> from_unixtime(<span class="number">0</span>, <span class="string">&#x27;yyyy-MM-dd HH:mm:ss&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 日期转UNIX时间戳函数: unix_timestamp</span></span><br><span class="line"><span class="keyword">SELECT</span> unix_timestamp(&quot;2011-12-07 13:01:03&quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 指定格式日期转UNIX时间戳函数: unix_timestamp</span></span><br><span class="line"><span class="keyword">SELECT</span> unix_timestamp(<span class="string">&#x27;20111207 13:01:03&#x27;</span>,<span class="string">&#x27;yyyyMMdd HH:mm:ss&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 抽取日期函数: to_date</span></span><br><span class="line"><span class="keyword">SELECT</span> to_date(<span class="string">&#x27;2009-07-30 04:17:52&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 日期转年函数: year</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">year</span>(<span class="string">&#x27;2009-07-30 04:17:52&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 日期转月函数: month</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>(<span class="string">&#x27;2009-07-30 04:17:52&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 日期转天函数: day</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">day</span>(<span class="string">&#x27;2009-07-30 04:17:52&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 日期转小时函数: hour</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">hour</span>(<span class="string">&#x27;2009-07-30 04:17:52&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 日期转分钟函数: minute</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">minute</span>(<span class="string">&#x27;2009-07-30 04:17:52&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 日期转秒函数: second</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">second</span>(<span class="string">&#x27;2009-07-30 04:17:52&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 日期转周函数: weekofyear 返回指定日期所示年份第几周</span></span><br><span class="line"><span class="keyword">SELECT</span> weekofyear(<span class="string">&#x27;2009-07-30 04:17:52&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 日期比较函数: datediff  日期格式要求&#x27;yyyy-MM-dd HH:mm:ss&#x27; or &#x27;yyyy-MM-dd&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> datediff(<span class="string">&#x27;2012-12-08&#x27;</span>,<span class="string">&#x27;2012-05-09&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 日期增加函数: date_add</span></span><br><span class="line"><span class="keyword">SELECT</span> date_add(<span class="string">&#x27;2012-02-28&#x27;</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 日期减少函数: date_sub</span></span><br><span class="line"><span class="keyword">SELECT</span> date_sub(<span class="string">&#x27;2012-01-1&#x27;</span>,<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<h5 id="Mathematical-Functions-数学函数"><a href="#Mathematical-Functions-数学函数" class="headerlink" title="Mathematical Functions 数学函数"></a>Mathematical Functions 数学函数</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 取整函数: round  返回double类型的整数值部分 （遵循四舍五入）</span></span><br><span class="line"><span class="keyword">SELECT</span> round(<span class="number">3.1415926</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 指定精度取整函数: round(double a, int d) 返回指定精度d的double类型</span></span><br><span class="line"><span class="keyword">SELECT</span> round(<span class="number">3.1415926</span>,<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 向下取整函数: floor</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">floor</span>(<span class="number">3.1415926</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">floor</span>(<span class="number">-3.1415926</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 向上取整函数: ceil</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">ceil</span>(<span class="number">3.1415926</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">ceil</span>(<span class="number">-3.1415926</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 取随机数函数: rand 每次执行都不一样 返回一个0到1范围内的随机数</span></span><br><span class="line"><span class="keyword">SELECT</span> rand();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 指定种子取随机数函数: rand(int seed) 得到一个稳定的随机数序列</span></span><br><span class="line"><span class="keyword">SELECT</span> rand(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 二进制函数:  bin(BIGINT a)</span></span><br><span class="line"><span class="keyword">SELECT</span> bin(<span class="number">18</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 进制转换函数: conv(BIGINT num, int from_base, int to_base)</span></span><br><span class="line"><span class="keyword">SELECT</span> conv(<span class="number">17</span>,<span class="number">10</span>,<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 绝对值函数: abs</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">abs</span>(<span class="number">-3.9</span>);</span><br></pre></td></tr></table></figure>

<h5 id="Collection-Functions-集合函数"><a href="#Collection-Functions-集合函数" class="headerlink" title="Collection Functions 集合函数"></a>Collection Functions 集合函数</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 集合元素size函数: size(Map&lt;K.V&gt;) size(Array&lt;T&gt;)</span></span><br><span class="line"><span class="keyword">SELECT</span> size(`<span class="keyword">array</span>`(<span class="number">11</span>,<span class="number">22</span>,<span class="number">33</span>));</span><br><span class="line"><span class="keyword">SELECT</span> size(`map`(&quot;id&quot;,<span class="number">10086</span>,&quot;name&quot;,&quot;zhangsan&quot;,&quot;age&quot;,<span class="number">18</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 取map集合keys函数: map_keys(Map&lt;K.V&gt;)</span></span><br><span class="line"><span class="keyword">SELECT</span> map_keys(`map`(&quot;id&quot;,<span class="number">10086</span>,&quot;name&quot;,&quot;zhangsan&quot;,&quot;age&quot;,<span class="number">18</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 取map集合values函数: map_values(Map&lt;K.V&gt;)</span></span><br><span class="line"><span class="keyword">SELECT</span> map_values(`map`(&quot;id&quot;,<span class="number">10086</span>,&quot;name&quot;,&quot;zhangsan&quot;,&quot;age&quot;,<span class="number">18</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 判断数组是否包含指定元素: array_contains(Array&lt;T&gt;, value)</span></span><br><span class="line"><span class="keyword">SELECT</span> array_contains(`<span class="keyword">array</span>`(<span class="number">11</span>,<span class="number">22</span>,<span class="number">33</span>),<span class="number">11</span>);</span><br><span class="line"><span class="keyword">SELECT</span> array_contains(`<span class="keyword">array</span>`(<span class="number">11</span>,<span class="number">22</span>,<span class="number">33</span>),<span class="number">66</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 数组排序函数:sort_array(Array&lt;T&gt;)</span></span><br><span class="line"><span class="keyword">SELECT</span> sort_array(`<span class="keyword">array</span>`(<span class="number">12</span>,<span class="number">2</span>,<span class="number">32</span>));</span><br></pre></td></tr></table></figure>

<h5 id="Conditional-Functions-条件函数"><a href="#Conditional-Functions-条件函数" class="headerlink" title="Conditional Functions 条件函数"></a>Conditional Functions 条件函数</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 使用之前课程创建好的t_student表数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_student LIMIT <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- if条件判断: if(boolean testCondition, T valueTrue, T valueFalseOrNull)</span></span><br><span class="line"><span class="keyword">SELECT</span> if(<span class="number">1</span><span class="operator">=</span><span class="number">2</span>,<span class="number">100</span>,<span class="number">200</span>);</span><br><span class="line"><span class="keyword">SELECT</span> if(sex <span class="operator">=</span><span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;W&#x27;</span>) <span class="keyword">from</span> t_student limit <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 空判断函数: isnull( a )</span></span><br><span class="line"><span class="keyword">SELECT</span> isnull(&quot;allen&quot;);</span><br><span class="line"><span class="keyword">SELECT</span> isnull(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 非空判断函数: isnotnull ( a )</span></span><br><span class="line"><span class="keyword">SELECT</span> isnotnull(&quot;allen&quot;);</span><br><span class="line"><span class="keyword">SELECT</span> isnotnull(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 空值转换函数: nvl(T value, T default_value)</span></span><br><span class="line"><span class="keyword">SELECT</span> nvl(&quot;allen&quot;,&quot;itcast&quot;);</span><br><span class="line"><span class="keyword">SELECT</span> nvl(<span class="keyword">null</span>,&quot;itcast&quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 非空查找函数: COALESCE(T v1, T v2, ...)</span></span><br><span class="line"><span class="comment">-- 返回参数中的第一个非空值；如果所有值都为NULL，那么返回NULL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COALESCE</span>(<span class="keyword">null</span>,<span class="number">11</span>,<span class="number">22</span>,<span class="number">33</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COALESCE</span>(<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="number">33</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COALESCE</span>(<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--条件转换函数: CASE a WHEN b THEN c [WHEN d THEN e]* [ELSE f] END</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CASE</span> <span class="number">100</span> <span class="keyword">WHEN</span> <span class="number">50</span> <span class="keyword">THEN</span> <span class="string">&#x27;tom&#x27;</span> <span class="keyword">WHEN</span> <span class="number">100</span> <span class="keyword">THEN</span> <span class="string">&#x27;mary&#x27;</span> <span class="keyword">ELSE</span> <span class="string">&#x27;tim&#x27;</span> <span class="keyword">END</span> ;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CASE</span> sex <span class="keyword">WHEN</span> <span class="string">&#x27;男&#x27;</span> <span class="keyword">THEN</span> <span class="string">&#x27;man&#x27;</span> <span class="keyword">ELSE</span> <span class="string">&#x27;women&#x27;</span> <span class="keyword">END</span> <span class="keyword">FROM</span> t_student LIMIT <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- nullif( a, b ):</span></span><br><span class="line"><span class="comment">-- 如果 a = b，则返回NULL；否则返回NULL。否则返回一个</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">nullif</span>(<span class="number">11</span>,<span class="number">11</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">nullif</span>(<span class="number">11</span>,<span class="number">12</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- assert_true(condition)</span></span><br><span class="line"><span class="comment">-- 如果&#x27;condition&#x27;不为真，则引发异常，否则返回null</span></span><br><span class="line"><span class="keyword">SELECT</span> assert_true(<span class="number">11</span> <span class="operator">&gt;=</span> <span class="number">0</span>);</span><br><span class="line"><span class="keyword">SELECT</span> assert_true(<span class="number">-1</span> <span class="operator">&gt;=</span> <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h5 id="Type-Conversion-Functions-类型转换函数"><a href="#Type-Conversion-Functions-类型转换函数" class="headerlink" title="Type Conversion Functions 类型转换函数"></a>Type Conversion Functions 类型转换函数</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 任意数据类型之间转换:cast</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">cast</span>(<span class="number">12.14</span> <span class="keyword">as</span> <span class="type">bigint</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">cast</span>(<span class="number">12.14</span> <span class="keyword">as</span> string);</span><br></pre></td></tr></table></figure>

<h5 id="Data-Masking-Functions-数据脱敏函数"><a href="#Data-Masking-Functions-数据脱敏函数" class="headerlink" title="Data Masking Functions 数据脱敏函数"></a>Data Masking Functions 数据脱敏函数</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- mask</span></span><br><span class="line"><span class="comment">-- 将查询回的数据，大写字母转换为X，小写字母转换为x，数字转换为n。</span></span><br><span class="line"><span class="keyword">SELECT</span> mask(&quot;abc123DEF&quot;);</span><br><span class="line"><span class="keyword">SELECT</span> mask(&quot;abc123DEF&quot;,<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;.&#x27;</span>,<span class="string">&#x27;^&#x27;</span>); <span class="comment">--自定义替换的字母</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- mask_first_n(string str[, int n]</span></span><br><span class="line"><span class="comment">-- 对前n个进行脱敏替换</span></span><br><span class="line"><span class="keyword">SELECT</span> mask_first_n(&quot;abc123DEF&quot;,<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- mask_last_n(string str[, int n])</span></span><br><span class="line"><span class="keyword">SELECT</span> mask_last_n(&quot;abc123DEF&quot;,<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- mask_show_first_n(string str[, int n])</span></span><br><span class="line"><span class="comment">-- 除了前n个字符，其余进行掩码处理</span></span><br><span class="line"><span class="keyword">SELECT</span> mask_show_first_n(&quot;abc123DEF&quot;,<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--mask_show_last_n(string str[, int n])</span></span><br><span class="line"><span class="keyword">SELECT</span> mask_show_last_n(&quot;abc123DEF&quot;,<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--mask_hash(string|char|varchar str)</span></span><br><span class="line"><span class="comment">--返回字符串的hash编码。</span></span><br><span class="line"><span class="keyword">SELECT</span> mask_hash(&quot;abc123DEF&quot;);</span><br></pre></td></tr></table></figure>

<h5 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- hive调用java方法: java_method(class, method[, arg1[, arg2..]])</span></span><br><span class="line"><span class="keyword">SELECT</span> java_method(&quot;java.lang.Math&quot;,&quot;max&quot;,<span class="number">11</span>,<span class="number">22</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 反射函数: reflect(class, method[, arg1[, arg2..]])</span></span><br><span class="line"><span class="keyword">SELECT</span> reflect(&quot;java.lang.Math&quot;,&quot;max&quot;,<span class="number">11</span>,<span class="number">22</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 取哈希值函数:hash</span></span><br><span class="line"><span class="keyword">SELECT</span> hash(&quot;allen&quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">--current_user()、logged_in_user()、current_database()、version()</span></span><br><span class="line"><span class="keyword">SELECT</span> logged_in_user();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- SHA-1加密: sha1(string/binary)</span></span><br><span class="line"><span class="keyword">SELECT</span> sha1(&quot;allen&quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- SHA-2家族算法加密：sha2(string/binary, int)  (SHA-224, SHA-256, SHA-384, SHA-512)</span></span><br><span class="line"><span class="keyword">SELECT</span> sha2(&quot;allen&quot;,<span class="number">224</span>);</span><br><span class="line"><span class="keyword">SELECT</span> sha2(&quot;allen&quot;,<span class="number">512</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- crc32加密:</span></span><br><span class="line"><span class="keyword">SELECT</span> crc32(&quot;allen&quot;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- MD5加密: md5(string/binary)</span></span><br><span class="line"><span class="keyword">SELECT</span> md5(&quot;allen&quot;);</span><br></pre></td></tr></table></figure>

<h4 id="用户自定义函数"><a href="#用户自定义函数" class="headerlink" title="用户自定义函数"></a>用户自定义函数</h4><h5 id="UDF-普通函数"><a href="#UDF-普通函数" class="headerlink" title="UDF 普通函数"></a>UDF 普通函数</h5><p>UDF函数通常把它叫做普通函数，最大的特点是一进一出，也就是输入一行输出一行。</p>
<h5 id="UDAF-聚合函数"><a href="#UDAF-聚合函数" class="headerlink" title="UDAF 聚合函数"></a>UDAF 聚合函数</h5><p>UDAF函数通常把它叫做聚合函数，A所代表的单词就是Aggregation聚合的意思。最大的特点是多进一出，也就是输入多行输出一行。</p>
<h5 id="UDTF-表生成函数"><a href="#UDTF-表生成函数" class="headerlink" title="UDTF 表生成函数"></a>UDTF 表生成函数</h5><p>UDTF函数通常把它叫做表生成函数，T所代表的单词是Table-Generating表生成的意思。最大的特点是一进多出，也就是输入一行输出多行。</p>
<h4 id="案例：用户自定义UDF"><a href="#案例：用户自定义UDF" class="headerlink" title="案例：用户自定义UDF"></a>案例：用户自定义UDF</h4><h5 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h5><p>自定义开发实现Hive函数，对手机号机号中间4位进行****处理。</p>
<ol>
<li>能够对输入数据进行非空判断、位数判断处理</li>
<li>能够实现校验手机号格式，把满足规则的进行处理</li>
<li>对于不符合手机号规则的数据原封不动不处理</li>
</ol>
<h5 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h5><ol>
<li><p>开发环境准备</p>
<p>创建Maven工程，添加下述pom依赖：</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 导入 hive 对应版本的依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hive-exec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 打包插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">filters</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">artifact</span>&gt;</span>*:*<span class="tag">&lt;/<span class="name">artifact</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.SF<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.DSA<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.RSA<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">filters</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>编写处理逻辑代码</p>
<p>写一个java类，继承UDF，并重载evaluate方法；</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.hive.udf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.exec.UDFArgumentException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.exec.UDFArgumentLengthException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.metadata.HiveException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.udf.generic.GenericUDF;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.serde2.objectinspector.ObjectInspector;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.serde2.objectinspector.ObjectInspectorConverters;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.serde2.objectinspector.PrimitiveObjectInspector;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.serde2.objectinspector.primitive.PrimitiveObjectInspectorConverter;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.serde2.objectinspector.primitive.PrimitiveObjectInspectorFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当Hive解析query时，会得到传入UDF参数的参数类型，并调用initialize()方法。</span></span><br><span class="line"><span class="comment"> * 针对该UDF的每个参数该方法都会收到一个对应的ObjectInspector参数，且该方法必须返回一个ObjectInspector表示返回值类型。</span></span><br><span class="line"><span class="comment"> * 通过调用该方法，Hive知道该UDF将返回什么数据类型，因此可以继续解析query。</span></span><br><span class="line"><span class="comment"> * 对于Hive的每行记录，我们在initialize()方法内读取ObjectInspector参数，并执行传参的数量和数据类型的检查，正确时才进行计算；</span></span><br><span class="line"><span class="comment"> * 在evaluate()方法中，我们使用initialize()方法里收到的ObjectInspector去读evaluate()方法接收的参数，</span></span><br><span class="line"><span class="comment"> * 即一串泛型Object（实际是DeferredObject），ObjectInspector解析Object并转成具体类型的对象执行数据处理，最后输出结果。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EncryptPhoneNumber</span> <span class="keyword">extends</span> <span class="title">GenericUDF</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String udfName = <span class="string">&quot;ENCRYPT_PHONUM&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> PrimitiveObjectInspectorConverter.TextConverter converter;</span><br><span class="line">    <span class="keyword">private</span> Text result = <span class="keyword">new</span> Text();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectInspector <span class="title">initialize</span><span class="params">(ObjectInspector[] arguments)</span> <span class="keyword">throws</span> UDFArgumentException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (arguments.length != <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UDFArgumentException(udfName + <span class="string">&quot; requires one value argument. Found :&quot;</span></span><br><span class="line">                    + arguments.length);</span><br><span class="line">        &#125;</span><br><span class="line">        PrimitiveObjectInspector argumentOI;</span><br><span class="line">        <span class="keyword">if</span>(arguments[<span class="number">0</span>] <span class="keyword">instanceof</span> PrimitiveObjectInspector) &#123;</span><br><span class="line">            argumentOI = (PrimitiveObjectInspector) arguments[<span class="number">0</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UDFArgumentException(udfName + <span class="string">&quot; takes only primitive types. found &quot;</span></span><br><span class="line">                    + arguments[<span class="number">0</span>].getTypeName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (argumentOI.getPrimitiveCategory()) &#123;</span><br><span class="line">            <span class="keyword">case</span> STRING:</span><br><span class="line">            <span class="keyword">case</span> CHAR:</span><br><span class="line">            <span class="keyword">case</span> VARCHAR:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> UDFArgumentException(udfName + <span class="string">&quot; takes only STRING/CHAR/VARCHAR types. Found &quot;</span></span><br><span class="line">                        + argumentOI.getPrimitiveCategory());</span><br><span class="line">        &#125;</span><br><span class="line">        converter = <span class="keyword">new</span> PrimitiveObjectInspectorConverter.TextConverter(argumentOI);</span><br><span class="line">        <span class="keyword">return</span> PrimitiveObjectInspectorFactory.writableStringObjectInspector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">evaluate</span><span class="params">(DeferredObject[] arguments)</span> <span class="keyword">throws</span> HiveException </span>&#123;</span><br><span class="line">        Object valObject = arguments[<span class="number">0</span>].get();</span><br><span class="line">        <span class="keyword">if</span> (valObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String val = ((Text) converter.convert(valObject)).toString();</span><br><span class="line">        <span class="keyword">if</span> (val == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        result.set(encryptPhonum(val.toString()));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. 能够对输入数据进行非空判断、位数判断处理</span></span><br><span class="line">    <span class="comment">//2. 能够实现校验手机号格式，把满足规则的进行处理</span></span><br><span class="line">    <span class="comment">//3. 对于不符合手机号规则的数据原封不动不处理</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">encryptPhonum</span><span class="params">(String phoNum)</span> </span>&#123;</span><br><span class="line">        String encryptPhoNum = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 手机号不为空 并且为11位</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(phoNum) &amp;&amp; phoNum.trim().length() == <span class="number">11</span> ) &#123;</span><br><span class="line">            <span class="comment">//判断数据是否满足中国大陆手机号码规范</span></span><br><span class="line">            String regex = <span class="string">&quot;^(1[3-9]\\d&#123;9&#125;$)&quot;</span>;</span><br><span class="line">            Pattern p = Pattern.compile(regex);</span><br><span class="line">            Matcher m = p.matcher(phoNum);</span><br><span class="line">            <span class="keyword">if</span> (m.matches()) &#123;<span class="comment">//进入这里都是符合手机号规则的</span></span><br><span class="line">                <span class="comment">//使用正则替换 返回加密后数据</span></span><br><span class="line">                encryptPhoNum = phoNum.trim().replaceAll(<span class="string">&quot;()\\d&#123;4&#125;(\\d&#123;4&#125;)&quot;</span>,<span class="string">&quot;$1****$2&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//不符合手机号规则 数据直接原封不动返回</span></span><br><span class="line">                encryptPhoNum = phoNum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//不符合11位 数据直接原封不动返回</span></span><br><span class="line">            encryptPhoNum = phoNum;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> encryptPhoNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDisplayString</span><span class="params">(String[] children)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;This is encrypt_phonum&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考内置的GenericUDFBaseTrim</p>
</blockquote>
</li>
<li><p>将项目打包上传到hiveserver2服务器的家目录下</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[eitan<span class="variable">@hadoop103</span> <span class="operator">~</span>]$ ll</span><br><span class="line">总用量 <span class="number">116120</span></span><br><span class="line">drwxrwxr<span class="operator">-</span>x. <span class="number">2</span> eitan eitan      <span class="number">4096</span> <span class="number">5</span>月  <span class="number">12</span> <span class="number">16</span>:<span class="number">09</span> bin</span><br><span class="line">drwxrwxr<span class="operator">-</span>x. <span class="number">3</span> eitan eitan      <span class="number">4096</span> <span class="number">5</span>月  <span class="number">13</span> <span class="number">10</span>:<span class="number">15</span> documents</span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">--. 1 eitan eitan 118888832 5月  14 23:54 hive-example-1.0-SNAPSHOT.jar</span></span><br><span class="line">drwxr<span class="operator">-</span>xr<span class="operator">-</span>x. <span class="number">3</span> eitan eitan      <span class="number">4096</span> <span class="number">5</span>月  <span class="number">13</span> <span class="number">21</span>:<span class="number">55</span> hive_export</span><br><span class="line">drwxrwxr<span class="operator">-</span>x. <span class="number">2</span> eitan eitan      <span class="number">4096</span> <span class="number">5</span>月  <span class="number">12</span> <span class="number">16</span>:<span class="number">08</span> log</span><br></pre></td></tr></table></figure></li>
<li><p>使用命令把jar包添加至classpath</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ADD</span> JAR <span class="operator">/</span>home<span class="operator">/</span>eitan<span class="operator">/</span>hive<span class="operator">-</span>example<span class="number">-1.0</span><span class="operator">-</span>SNAPSHOT.jar;</span><br></pre></td></tr></table></figure></li>
<li><p>注册临时函数</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">FUNCTION</span> encrypt_phonum <span class="keyword">AS</span> <span class="string">&#x27;cn.itcast.hive.udf.EncryptPhoneNumber&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>使用效果</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 10086</span></span><br><span class="line"><span class="keyword">SELECT</span> encrypt_phonum(&quot;10086&quot;);</span><br><span class="line"><span class="comment">-- ****5338730</span></span><br><span class="line"><span class="keyword">SELECT</span> encrypt_phonum(&quot;18905338730&quot;);</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Hive函数高级"><a href="#Hive函数高级" class="headerlink" title="Hive函数高级"></a>Hive函数高级</h3><h4 id="explode函数"><a href="#explode函数" class="headerlink" title="explode函数"></a>explode函数</h4><h5 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h5><ul>
<li>explode接收map、array类型的数据作为输入，然后把输入数据中的每个元素拆开变成一行数据，一个元素一行；</li>
<li>lexplode执行效果正好满足于输入一行输出多行，所有叫做UDTF函数。</li>
</ul>
<h5 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> explode(`<span class="keyword">array</span>`(<span class="number">11</span>,<span class="number">22</span>,<span class="number">33</span>)) <span class="keyword">AS</span> item;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> explode(`map`(&quot;id&quot;,<span class="number">10086</span>,&quot;name&quot;,&quot;zhangsan&quot;,&quot;age&quot;,<span class="number">18</span>));</span><br></pre></td></tr></table></figure>

<h5 id="explode使用限制及原因"><a href="#explode使用限制及原因" class="headerlink" title="explode使用限制及原因"></a>explode使用限制及原因</h5><p><strong>限制：</strong>在select的时候，explode的旁边不支持其他字段的同时出现</p>
<p><strong>原因：</strong></p>
<ol>
<li>explode函数属于UDTF函数，即表生成函数；</li>
<li>explode函数执行返回的结果可以理解为一张虚拟的表，其数据来源于源表；</li>
<li>在select中只查询源表数据没有问题，只查询explode生成的虚拟表数据也没问题</li>
<li>但是不能在只查询源表的时候，既想返回源表字段又想返回explode生成的虚拟表字段</li>
<li>通俗点讲，有两张表，不能只查询一张表但是返回分别属于两张表的字段；</li>
<li>从SQL层面上来说应该对两张表进行关联查询</li>
<li>Hive专门提供了语法lateral View侧视图，专门用于搭配explode这样的UDTF函数，以满足上述需要。</li>
</ol>
<h4 id="Lateral-View侧视图"><a href="#Lateral-View侧视图" class="headerlink" title="Lateral View侧视图"></a>Lateral View侧视图</h4><h5 id="概念及原理"><a href="#概念及原理" class="headerlink" title="概念及原理"></a>概念及原理</h5><ol>
<li>Lateral View是一种特殊的语法，主要用于搭配UDTF类型功能的函数一起使用，用于解决UDTF函数的一些查询限制的问题；</li>
<li>将UDTF的结果构建成一个类似于视图的表，然后将原表中的每一行和UDTF函数输出的每一行进行连接，生成一张新的虚拟表；</li>
<li>使用lateral view时也可以对UDTF产生的记录设置字段名称，产生的字段可以用于group by、order by 、limit等语句中，不需要再单独嵌套一层子查询。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/xyq-material/image/master/blog/20220520193317.png" alt="image-20220515104535030"></p>
<h5 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--lateral view侧视图基本语法如下</span></span><br><span class="line"><span class="keyword">SELECT</span> …… <span class="keyword">FROM</span> tabelA <span class="keyword">LATERAL</span> <span class="keyword">VIEW</span>  UDTF(xxx) 别名 <span class="keyword">AS</span> col1,col2,col3……;</span><br></pre></td></tr></table></figure>

<h5 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h5><p>有一份数据《The_NBA_Championship.txt》，关于部分年份的NBA总冠军球队名单：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Chicago Bulls,1991|1992|1993|1996|1997|1998</span><br><span class="line">San Antonio Spurs,1999|2003|2005|2007|2014</span><br><span class="line">Golden State Warriors,1947|1956|1975|2015</span><br><span class="line">Boston Celtics,1957|1959|1960|1961|1962|1963|1964|1965|1966|1968|1969|1974|1976|1981|1984|1986|2008</span><br><span class="line">L.A. Lakers,1949|1950|1952|1953|1954|1972|1980|1982|1985|1987|1988|2000|2001|2002|2009|2010</span><br><span class="line">Miami Heat,2006|2012|2013</span><br><span class="line">Philadelphia 76ers,1955|1967|1983</span><br><span class="line">Detroit Pistons,1989|1990|2004</span><br><span class="line">Houston Rockets,1994|1995</span><br><span class="line">New York Knicks,1970|1973</span><br></pre></td></tr></table></figure>

<p><strong>需求：</strong>使用Hive建表映射成功数据，对数据拆分，并且根据年份的倒序进行排序。</p>
<p><strong>实践：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- step1 建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> the_nba_championship</span><br><span class="line">(</span><br><span class="line">    team_name     string COMMENT &quot;队伍名称&quot;,</span><br><span class="line">    champion_year <span class="keyword">array</span><span class="operator">&lt;</span>string<span class="operator">&gt;</span> COMMENT &quot;夺冠年份&quot;</span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED</span><br><span class="line">    FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line">    COLLECTION ITEMS TERMINATED <span class="keyword">BY</span> &quot;|&quot;;</span><br><span class="line">    </span><br><span class="line"><span class="comment">-- step2 上传数据|加载数据</span></span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH <span class="string">&#x27;/home/eitan/documents/txt/The_NBA_Championship.txt&#x27;</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> the_nba_championship;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- step3 数据拆分查询，不排序则不需要MR操作</span></span><br><span class="line"><span class="keyword">SELECT</span> a.team_name,b.year <span class="keyword">FROM</span> the_nba_championship a <span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(champion_year) b <span class="keyword">AS</span> <span class="keyword">year</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> b.year <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h4 id="Aggregation-聚合函数"><a href="#Aggregation-聚合函数" class="headerlink" title="Aggregation 聚合函数"></a>Aggregation 聚合函数</h4><h5 id="基础聚合函数"><a href="#基础聚合函数" class="headerlink" title="基础聚合函数"></a>基础聚合函数</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_student;</span><br><span class="line"><span class="comment">-- 场景1：没有group by子句的聚合操作</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt1,<span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">AS</span> cnt2 <span class="keyword">FROM</span> t_student;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt1,<span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">AS</span> cnt2,<span class="built_in">count</span>(sex) <span class="keyword">FROM</span> t_student;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 场景2：带有group by子句的聚合操作 注意group by语法限制</span></span><br><span class="line"><span class="keyword">SELECT</span> sex, <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> t_student <span class="keyword">GROUP</span> <span class="keyword">BY</span> sex;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 场景3：select时多个聚合函数一起使用</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">AS</span> cnt1,<span class="built_in">avg</span>(age) <span class="keyword">AS</span> cnt2 <span class="keyword">FROM</span> t_student;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 场景4：聚合函数和case when条件转换函数、coalesce函数、if函数使用</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">sum</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> sex <span class="operator">=</span> <span class="string">&#x27;男&#x27;</span><span class="keyword">THEN</span> <span class="number">1</span> <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>)</span><br><span class="line"><span class="keyword">FROM</span> t_student;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">sum</span>(if(sex <span class="operator">=</span> <span class="string">&#x27;男&#x27;</span>,<span class="number">1</span>,<span class="number">0</span>))</span><br><span class="line"><span class="keyword">FROM</span> t_student;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 聚合参数针对null的处理方式</span></span><br><span class="line"><span class="comment">-- null null 0</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">max</span>(<span class="keyword">null</span>), <span class="built_in">min</span>(<span class="keyword">null</span>), <span class="built_in">count</span>(<span class="keyword">null</span>);</span><br><span class="line"><span class="comment">-- 下面这两个不支持null</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">sum</span>(<span class="keyword">null</span>), <span class="built_in">avg</span>(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 场景5：聚合操作时针对null的处理</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_1 (val1 <span class="type">int</span>, val2 <span class="type">int</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> tmp_1 <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">2</span>),(<span class="keyword">null</span>,<span class="number">2</span>),(<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tmp_1;</span><br><span class="line"><span class="comment">-- 第二行数据(NULL, 2) 在进行sum(val1 + val2)的时候会被忽略</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">sum</span>(val1), <span class="built_in">sum</span>(val1 <span class="operator">+</span> val2) <span class="keyword">FROM</span> tmp_1;</span><br><span class="line"><span class="comment">-- 可以使用coalesce函数解决</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">sum</span>(<span class="built_in">coalesce</span>(val1,<span class="number">0</span>)),</span><br><span class="line">    <span class="built_in">sum</span>(<span class="built_in">coalesce</span>(val1,<span class="number">0</span>) <span class="operator">+</span> val2)</span><br><span class="line"><span class="keyword">FROM</span> tmp_1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 场景6：配合distinct关键字去重聚合</span></span><br><span class="line"><span class="comment">-- 此场景下，会编译期间会自动设置只启动一个reduce task处理数据  性能可能会不会 造成数据拥堵</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="keyword">DISTINCT</span> sex) <span class="keyword">AS</span> cnt1 <span class="keyword">FROM</span> t_student;</span><br><span class="line"><span class="comment">-- 可以先去重 在聚合 通过子查询完成</span></span><br><span class="line"><span class="comment">-- 因为先执行distinct的时候 可以使用多个reducetask来跑数据</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">AS</span> gender_uni_cnt</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> sex <span class="keyword">FROM</span> t_student) a;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 案例需求：找出t_student中男女学生年龄最大的及其名字</span></span><br><span class="line"><span class="comment">-- 这里使用了struct来构造数据 然后针对struct应用max找出最大元素 然后取值</span></span><br><span class="line"><span class="keyword">SELECT</span> struct(age, name) <span class="keyword">FROM</span> t_student;</span><br><span class="line"><span class="keyword">SELECT</span> struct(age, name).col1 <span class="keyword">FROM</span> t_student;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">max</span>(struct(age, name)) <span class="keyword">FROM</span> t_student;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> sex,</span><br><span class="line">       <span class="built_in">max</span>(struct(age, name)).col1 <span class="keyword">as</span> age,</span><br><span class="line">       <span class="built_in">max</span>(struct(age, name)).col2 <span class="keyword">as</span> name</span><br><span class="line"><span class="keyword">FROM</span> t_student</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> sex;</span><br></pre></td></tr></table></figure>

<h5 id="增强聚合函数"><a href="#增强聚合函数" class="headerlink" title="增强聚合函数"></a>增强聚合函数</h5><p>增强聚合的GROUPING SETS、CUBE、ROLLUP这几个函数主要适用于OLAP多维数据分析模式中，多维分析中的<strong>维</strong>指的分析问题时看待问题的维度、角度。</p>
<ol>
<li><p>准备数据 字段：月份、天、用户cookieid</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">2018-03,2018-03-10,cookie1</span><br><span class="line">2018-03,2018-03-10,cookie5</span><br><span class="line">2018-03,2018-03-12,cookie7</span><br><span class="line">2018-04,2018-04-12,cookie3</span><br><span class="line">2018-04,2018-04-13,cookie2</span><br><span class="line">2018-04,2018-04-13,cookie4</span><br><span class="line">2018-04,2018-04-16,cookie4</span><br><span class="line">2018-03,2018-03-10,cookie2</span><br><span class="line">2018-03,2018-03-10,cookie3</span><br><span class="line">2018-04,2018-04-12,cookie5</span><br><span class="line">2018-04,2018-04-13,cookie6</span><br><span class="line">2018-04,2018-04-15,cookie3</span><br><span class="line">2018-04,2018-04-15,cookie2</span><br><span class="line">2018-04,2018-04-16,cookie1</span><br></pre></td></tr></table></figure></li>
<li><p>表创建并加载数据</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> cookie_info</span><br><span class="line">(</span><br><span class="line">    <span class="keyword">month</span>    STRING,</span><br><span class="line">    <span class="keyword">day</span>      STRING,</span><br><span class="line">    cookieid STRING</span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED</span><br><span class="line">    FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/cookie_info.txt&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> cookie_info;</span><br></pre></td></tr></table></figure></li>
<li><p>GROUPING SETS</p>
<p><strong>GROUPING SETS</strong>是一种将多个group by逻辑写在一个sql语句中的便利写法。等价于将不同维度的GROUP BY结果集进行UNION ALL。GROUPING__ID表示结果属于哪一个分组集合。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,</span><br><span class="line">       <span class="keyword">day</span>,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> nums,</span><br><span class="line">       GROUPING__ID</span><br><span class="line"><span class="keyword">FROM</span> cookie_info</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>, <span class="keyword">day</span></span><br><span class="line">    <span class="keyword">GROUPING</span> SETS ( <span class="keyword">month</span>, <span class="keyword">day</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- GROUPING__ID表示这一组结果属于哪个分组集合，</span></span><br><span class="line"><span class="comment">-- 根据grouping sets中的分组条件month，day，1是代表month，2是代表day</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>, <span class="keyword">NULL</span>, <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> nums, <span class="number">1</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> cookie_info <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NULL</span> <span class="keyword">as</span> <span class="keyword">month</span>, <span class="keyword">day</span>, <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> nums, <span class="number">2</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> cookie_info <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 再比如</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,</span><br><span class="line">       <span class="keyword">day</span>,</span><br><span class="line">       <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> nums,</span><br><span class="line">       GROUPING__ID</span><br><span class="line"><span class="keyword">FROM</span> cookie_info</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>, <span class="keyword">day</span></span><br><span class="line">    <span class="keyword">GROUPING</span> SETS ( <span class="keyword">month</span>, <span class="keyword">day</span>, ( <span class="keyword">month</span>, <span class="keyword">day</span>))</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>, <span class="keyword">NULL</span>, <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> nums, <span class="number">1</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> cookie_info <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NULL</span>, <span class="keyword">day</span>, <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> nums, <span class="number">2</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> cookie_info <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>, <span class="keyword">day</span>, <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> nums, <span class="number">3</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> cookie_info <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>, <span class="keyword">day</span>;</span><br></pre></td></tr></table></figure></li>
<li><h5 id="CUBE"><a href="#CUBE" class="headerlink" title="CUBE"></a>CUBE</h5><p>CUBE的语法功能指的是：根据GROUP BY的维度的所有组合进行聚合。对于CUBE,如果有n个维度,则所有组合的总个数是：<strong>2^n</strong>。比如CUBE有a,b,c3个维度，则所有组合情况是： ((a,b,c),(a,b),(b,c),(a,c),(a),(b),(c),())。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    <span class="keyword">day</span>,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> nums,</span><br><span class="line">    GROUPING__ID</span><br><span class="line"><span class="keyword">FROM</span> cookie_info</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">CUBE</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 等价于</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NULL</span>,<span class="keyword">NULL</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> nums,<span class="number">0</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> cookie_info</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,<span class="keyword">NULL</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> nums,<span class="number">1</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> cookie_info <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NULL</span>,<span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> nums,<span class="number">2</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> cookie_info <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,<span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> nums,<span class="number">3</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> cookie_info <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>ROLLUP</p>
<p>CUBE的语法功能指的是：根据GROUP BY的维度的所有组合进行聚合。</p>
<p>ROLLUP是Cube的子集，以最左侧的维度为主，从该维度进行层级聚合。比如ROLLUP有a,b,c3个维度，则所有组合情况是：((a,b,c),(a,b),(a),())。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--rollup-------------</span></span><br><span class="line"><span class="comment">--比如，以month维度进行层级聚合：</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    <span class="keyword">day</span>,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> nums,</span><br><span class="line">    GROUPING__ID</span><br><span class="line"><span class="keyword">FROM</span> cookie_info</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">ROLLUP</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;</span><br><span class="line"></span><br><span class="line"><span class="comment">--把month和day调换顺序，则以day维度进行层级聚合：</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">day</span>,</span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,</span><br><span class="line">    GROUPING__ID</span><br><span class="line"><span class="keyword">FROM</span> cookie_info</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span>,<span class="keyword">month</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">ROLLUP</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Window-functions-窗口函数"><a href="#Window-functions-窗口函数" class="headerlink" title="Window functions 窗口函数"></a>Window functions 窗口函数</h4><h5 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h5><ol>
<li><strong>窗口函数</strong>（Window functions）也叫做开窗函数、OLAP函数，其最大特点是：输入值是从SELECT语句的结果集中的一行或多行的“窗口”中获取的。</li>
<li>如果函数具有OVER子句，则它是窗口函数。</li>
<li>窗口函数可以简单地解释为类似于聚合函数的计算函数，但是通过GROUP BY子句组合的常规聚合会隐藏正在聚合的各个行，最终输出一行，窗口函数聚合后还可以访问当中的各个行，并且可以将这些行中的某些属性添加到结果集中。</li>
</ol>
<h5 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Function</span>(arg1,..., argn) <span class="keyword">OVER</span> ([<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="operator">&lt;</span>...<span class="operator">&gt;</span>] [<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="operator">&lt;</span>....<span class="operator">&gt;</span>] [<span class="operator">&lt;</span>window_expression<span class="operator">&gt;</span>])</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p>其中Function(arg1,…, argn) 可以是下面分类中的任意一个</p>
<ul>
<li>聚合函数：比如sum max avg等</li>
<li>排序函数：比如rank row_number等</li>
<li>分析函数：比如lead lag first_value等</li>
</ul>
</li>
<li><p>OVER [PARTITION BY &lt;…&gt;] 类似于group by 用于指定分组 每个分组你可以把它叫做窗口</p>
</li>
<li><p>如果没有PARTITION BY 那么整张表的所有行就是一组</p>
</li>
<li><p>[ORDER BY &lt;….&gt;] 用于指定每个分组内的数据排序规则 支持ASC、DESC</p>
</li>
<li><p>[<window_expression>] 用于指定每个窗口中 操作的数据范围 默认是窗口中所有行</p>
</li>
</ul>
</blockquote>
<h5 id="实践-1"><a href="#实践-1" class="headerlink" title="实践"></a>实践</h5><ol>
<li><p>建表并导入数据</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> website_pv_info</span><br><span class="line">(</span><br><span class="line">    cookieid   string,</span><br><span class="line">    createtime string,</span><br><span class="line">    pv         <span class="type">int</span></span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED</span><br><span class="line">    FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> website_url_info</span><br><span class="line">(</span><br><span class="line">    cookieid   string,</span><br><span class="line">    createtime string, <span class="comment">--访问时间</span></span><br><span class="line">    url        string  <span class="comment">--访问页面</span></span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED</span><br><span class="line">    FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;,&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/website_pv_info.txt&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> website_pv_info;</span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/website_url_info.txt&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> website_url_info;</span><br></pre></td></tr></table></figure></li>
<li><p>窗口聚合函数</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1、求出每个用户总pv数  sum+group by普通常规聚合操作</span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,<span class="built_in">sum</span>(pv) <span class="keyword">AS</span> total_pv <span class="keyword">FROM</span> website_pv_info <span class="keyword">GROUP</span> <span class="keyword">BY</span> cookieid;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2、sum+窗口函数 总共有四种用法 注意是整体聚合 还是累积聚合</span></span><br><span class="line"><span class="comment">-- sum(...) over( )对表所有行求和</span></span><br><span class="line"><span class="comment">-- sum(...) over( order by ... ) 连续累积求和</span></span><br><span class="line"><span class="comment">-- sum(...) over( partition by... ) 同组内所有行求和</span></span><br><span class="line"><span class="comment">-- sum(...) over( partition by... order by ... ) 在每个分组内，连续累积求和</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 需求：求出网站总的pv数 所有用户所有访问加起来</span></span><br><span class="line"><span class="comment">-- sum(...) over( )对表所有行求和</span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,createtime,pv,</span><br><span class="line">       <span class="built_in">sum</span>(pv) <span class="keyword">OVER</span>() <span class="keyword">AS</span> total_pv <span class="keyword">FROM</span> website_pv_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 需求：求出每个用户总pv数</span></span><br><span class="line"><span class="comment">-- sum(...) over( partition by... )，同组内所行求和</span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,createtime,pv,</span><br><span class="line">       <span class="built_in">sum</span>(pv) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid) <span class="keyword">AS</span> total_pv <span class="keyword">FROM</span> website_pv_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 需求：求出每个用户截止到当天，累积的总pv数</span></span><br><span class="line"><span class="comment">-- sum(...) over( partition by... order by ... )，在每个分组内，连续累积求和</span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,createtime,pv,</span><br><span class="line">       <span class="built_in">sum</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> current_total_pv</span><br><span class="line"><span class="keyword">FROM</span> website_pv_info;</span><br></pre></td></tr></table></figure></li>
<li><p>窗口表达式</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">关键字是<span class="keyword">rows</span> <span class="keyword">between</span>，包括下面这几个选项</span><br><span class="line"><span class="operator">-</span> preceding：往前</span><br><span class="line"><span class="operator">-</span> following：往后</span><br><span class="line"><span class="operator">-</span> <span class="keyword">current</span> <span class="type">row</span>：当前行</span><br><span class="line"><span class="operator">-</span> unbounded：边界</span><br><span class="line"><span class="operator">-</span> unbounded preceding 表示从前面的起点</span><br><span class="line"><span class="operator">-</span> unbounded following：表示到后面的终点</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第一行到当前行</span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,createtime,pv,</span><br><span class="line">       <span class="built_in">sum</span>(pv) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span> ) <span class="keyword">AS</span> pv2</span><br><span class="line"><span class="keyword">FROM</span> website_pv_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 向前3行至当前行</span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,createtime,pv,</span><br><span class="line">       <span class="built_in">sum</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">3</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span> ) <span class="keyword">AS</span> pv4</span><br><span class="line"><span class="keyword">from</span> website_pv_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 向前3行 向后1行</span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,createtime,pv,</span><br><span class="line">       <span class="built_in">sum</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">3</span> PRECEDING <span class="keyword">AND</span> <span class="number">1</span> FOLLOWING) <span class="keyword">AS</span> pv5</span><br><span class="line"><span class="keyword">FROM</span> website_pv_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">--当前行至最后一行</span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,createtime,pv,</span><br><span class="line">       <span class="built_in">sum</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span> <span class="keyword">AND</span> UNBOUNDED FOLLOWING) <span class="keyword">AS</span> pv6</span><br><span class="line"><span class="keyword">FROM</span> website_pv_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">--第一行到最后一行 也就是分组内的所有行</span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,createtime,pv,</span><br><span class="line">       <span class="built_in">sum</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> UNBOUNDED FOLLOWING) <span class="keyword">AS</span> pv6</span><br><span class="line"><span class="keyword">FROM</span> website_pv_info;</span><br></pre></td></tr></table></figure></li>
<li><p>窗口排序函数</p>
<p>窗口排序函数用于给每个分组内的数据打上排序的标号。注意窗口排序函数不支持窗口表达式。总共有4个函数需要掌握：</p>
<ol>
<li><p><strong>row_number：</strong>在每个分组中，为每行分配一个从1开始的唯一序列号，递增，不考虑重复；</p>
</li>
<li><p><strong>rank：</strong> 在每个分组中，为每行分配一个从1开始的序列号，考虑重复，挤占后续位置；</p>
</li>
<li><p><strong>dense_rank：</strong> 在每个分组中，为每行分配一个从1开始的序列号，考虑重复，不挤占后续位置；</p>
</li>
<li><p><strong>ntile：</strong>将每个分组内的数据分为指定的若干个桶里（分为若干个部分），并且为每一个桶分配一个桶编号。如果不能平均分配，则优先分配较小编号的桶，并且各个桶中能放的行数最多相差1。</p>
</li>
</ol>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    cookieid,</span><br><span class="line">    createtime,</span><br><span class="line">    pv,</span><br><span class="line">    <span class="built_in">RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> pv <span class="keyword">desc</span>) <span class="keyword">AS</span> rn1,</span><br><span class="line">    <span class="built_in">DENSE_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> pv <span class="keyword">desc</span>) <span class="keyword">AS</span> rn2,</span><br><span class="line">    <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> pv <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn3</span><br><span class="line"><span class="keyword">FROM</span> website_pv_info</span><br><span class="line"><span class="keyword">WHERE</span> cookieid <span class="operator">=</span> <span class="string">&#x27;cookie1&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 需求：找出每个用户访问pv最多的是哪天的Top3 重复并列的不考虑</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span></span><br><span class="line">(<span class="keyword">SELECT</span> cookieid,</span><br><span class="line">        createtime,</span><br><span class="line">        pv,</span><br><span class="line">        <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> pv <span class="keyword">DESC</span>) <span class="keyword">AS</span> seq <span class="keyword">FROM</span> website_pv_info) tmp</span><br><span class="line"><span class="keyword">WHERE</span> tmp.seq <span class="operator">&lt;</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 把每个分组内的数据分为3桶 NTILE</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    cookieid,</span><br><span class="line">    createtime,</span><br><span class="line">    pv,</span><br><span class="line">    <span class="built_in">NTILE</span>(<span class="number">3</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> rn2</span><br><span class="line"><span class="keyword">FROM</span> website_pv_info</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> cookieid,createtime;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 需求：统计每个用户pv数最多的前3分之1天。</span></span><br><span class="line"><span class="comment">-- 理解：将数据根据cookieid分 根据pv倒序排序 排序之后分为3个部分 取第一部分</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span></span><br><span class="line">(<span class="keyword">SELECT</span></span><br><span class="line">        cookieid,</span><br><span class="line">        createtime,</span><br><span class="line">        pv,</span><br><span class="line">        <span class="built_in">NTILE</span>(<span class="number">3</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> pv <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn <span class="keyword">FROM</span> website_pv_info) tmp</span><br><span class="line"><span class="keyword">WHERE</span> rn <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>窗口分析函数</p>
<ul>
<li><p>LAG(col,n,DEFAULT) 用于统计窗口内往上第n行值</p>
<p>第一个参数为列名，第二个参数为往上第n行（可选，默认为1），第三个参数为默认值（当往上第n行为NULL时候，取默认值，如不指定，则为NULL）；</p>
</li>
<li><p>LEAD(col,n,DEFAULT) 用于统计窗口内往下第n行值</p>
<p>第一个参数为列名，第二个参数为往下第n行（可选，默认为1），第三个参数为默认值（当往下第n行为NULL时候，取默认值，如不指定，则为NULL）；</p>
</li>
<li><p>FIRST_VALUE 取分组内排序后，截止到当前行，第一个值；</p>
</li>
<li><p>LAST_VALUE 取分组内排序后，截止到当前行，最后一个值；</p>
</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- LAG</span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,</span><br><span class="line">       createtime,</span><br><span class="line">       url,</span><br><span class="line">       <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> rn,</span><br><span class="line">       <span class="built_in">LAG</span>(createtime,<span class="number">1</span>,<span class="string">&#x27;1970-01-01 00:00:00&#x27;</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> last_1_time,</span><br><span class="line">       <span class="built_in">LAG</span>(createtime,<span class="number">2</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> last_2_time</span><br><span class="line"><span class="keyword">FROM</span> website_url_info;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- LEAD</span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,</span><br><span class="line">       createtime,</span><br><span class="line">       url,</span><br><span class="line">       <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> rn,</span><br><span class="line">       <span class="built_in">LEAD</span>(createtime,<span class="number">1</span>,<span class="string">&#x27;1970-01-01 00:00:00&#x27;</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> next_1_time,</span><br><span class="line">       <span class="built_in">LEAD</span>(createtime,<span class="number">2</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> next_2_time</span><br><span class="line"><span class="keyword">FROM</span> website_url_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- FIRST_VALUE</span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,</span><br><span class="line">       createtime,</span><br><span class="line">       url,</span><br><span class="line">       <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> rn,</span><br><span class="line">       <span class="built_in">FIRST_VALUE</span>(url) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> first1</span><br><span class="line"><span class="keyword">FROM</span> website_url_info;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- LAST_VALUE</span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,</span><br><span class="line">       createtime,</span><br><span class="line">       url,</span><br><span class="line">       <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> rn,</span><br><span class="line">       <span class="built_in">LAST_VALUE</span>(url) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> last1</span><br><span class="line"><span class="keyword">FROM</span> website_url_info;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="Sampling-抽样函数"><a href="#Sampling-抽样函数" class="headerlink" title="Sampling 抽样函数"></a>Sampling 抽样函数</h4><h5 id="Random随机抽样"><a href="#Random随机抽样" class="headerlink" title="Random随机抽样"></a>Random随机抽样</h5><p>随机抽样使用rand()函数和LIMIT关键字来获取数据。 使用了DISTRIBUTE和SORT关键字，可以确保数据也随机分布在mapper和reducer之间，使得底层执行有效率。 </p>
<p>ORDER BY 和rand()语句也可以达到相同的目的，但是表现不好。因为ORDER BY是全局排序，只会启动运行一个Reducer。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 需求：随机抽取2个学生的情况进行查看</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_student</span><br><span class="line">    DISTRIBUTE <span class="keyword">BY</span> rand() SORT <span class="keyword">BY</span> rand() LIMIT <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用order by+rand也可以实现同样的效果 但是效率不高</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_student <span class="keyword">ORDER</span> <span class="keyword">BY</span> rand() LIMIT <span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h5 id="Block块抽样"><a href="#Block块抽样" class="headerlink" title="Block块抽样"></a>Block块抽样</h5><p>Block块采样允许select随机获取n行数据，即数据大小或n个字节的数据。采样粒度是HDFS块大小。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---block抽样</span></span><br><span class="line"><span class="comment">--根据行数抽样</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_student <span class="keyword">TABLESAMPLE</span>(<span class="number">1</span> <span class="keyword">ROWS</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--根据数据大小百分比抽样</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_student <span class="keyword">TABLESAMPLE</span>(<span class="number">50</span> <span class="keyword">PERCENT</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--根据数据大小抽样</span></span><br><span class="line"><span class="comment">--支持数据单位 b/B, k/K, m/M, g/G</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_student <span class="keyword">TABLESAMPLE</span>(<span class="number">1</span>b);</span><br></pre></td></tr></table></figure>

<h5 id="Bucket-table分桶表抽样"><a href="#Bucket-table分桶表抽样" class="headerlink" title="Bucket table分桶表抽样"></a>Bucket table分桶表抽样</h5><p>这是一种特殊的采样方法，针对分桶表进行了优化。优点是既随机速度也很快。</p>
<p>语法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TABLESAMPLE</span> (BUCKET x <span class="keyword">OUT</span> <span class="keyword">OF</span> y [<span class="keyword">ON</span> colname])</span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>y必须是table总bucket数的倍数或者因子。hive根据y的大小，决定抽样的比例。<br>例如，table总共分了4份（4个bucket），当y=2时，抽取(4/2=)2个bucket的数据，当y=8时，抽取(4/8=)1/2个bucket的数据</li>
<li>x表示从哪个bucket开始抽取。<br>例如，table总bucket数为4，tablesample(bucket 4 out of 4)，表示总共抽取（4/4=）1个bucket的数据，抽取第4个bucket的数据。<br>注意：x的值必须小于等于y的值，否则FAILED:Numerator should not be bigger than denominator in sample clause for table stu_buck</li>
<li>ON colname表示基于什么抽<br>ON rand()表示随机抽<br>ON 分桶字段 表示基于分桶字段抽样 效率更高 推荐</li>
</ol>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---bucket table抽样</span></span><br><span class="line"><span class="comment">--根据整行数据进行抽样</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_usa_covid19_bucket <span class="keyword">TABLESAMPLE</span>(BUCKET <span class="number">1</span> <span class="keyword">OUT</span> <span class="keyword">OF</span> <span class="number">2</span> <span class="keyword">ON</span> rand());</span><br><span class="line"></span><br><span class="line"><span class="comment">--根据分桶字段进行抽样 效率更高</span></span><br><span class="line"><span class="keyword">describe</span> formatted t_usa_covid19_bucket;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_usa_covid19_bucket <span class="keyword">TABLESAMPLE</span>(BUCKET <span class="number">1</span> <span class="keyword">OUT</span> <span class="keyword">OF</span> <span class="number">2</span> <span class="keyword">ON</span> state);</span><br></pre></td></tr></table></figure>

<h3 id="Hive函数应用案例"><a href="#Hive函数应用案例" class="headerlink" title="Hive函数应用案例"></a>Hive函数应用案例</h3><h4 id="多字节分隔符"><a href="#多字节分隔符" class="headerlink" title="多字节分隔符"></a>多字节分隔符</h4><h5 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h5><p>Hive中默认使用<strong>单字节分隔符</strong>来加载文本数据，但在实际工作中，我们遇到的数据往往不是非常规范化的数据，我们会遇到以下的两种情况：</p>
<ol>
<li><p>每一行数据的分隔符是多字节分隔符，例如：”||”、“–”等</p>
 <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">01||<span class="string">周杰伦</span>||<span class="string">中国</span>||<span class="string">台湾</span>||<span class="string">男</span>||<span class="string">七里香</span></span><br><span class="line"><span class="string">02</span>||<span class="string">刘德华</span>||<span class="string">中国</span>||<span class="string">香港</span>||<span class="string">男</span>||<span class="string">笨小孩</span></span><br><span class="line"><span class="string">03</span>||<span class="string">汪  峰</span>||<span class="string">中国</span>||<span class="string">北京</span>||<span class="string">男</span>||<span class="string">光明</span></span><br><span class="line"><span class="string">04</span>||<span class="string">朴  树</span>||<span class="string">中国</span>||<span class="string">北京</span>||<span class="string">男</span>||<span class="string">那些花儿</span></span><br><span class="line"><span class="string">05</span>||<span class="string">许  巍</span>||<span class="string">中国</span>||<span class="string">陕西</span>||<span class="string">男</span>||<span class="string">故乡</span></span><br><span class="line"><span class="string">06</span>||<span class="string">张靓颖</span>||<span class="string">中国</span>||<span class="string">四川</span>||<span class="string">女</span>||<span class="string">画心</span></span><br><span class="line"><span class="string">07</span>||<span class="string">黄家驹</span>||<span class="string">中国</span>||<span class="string">香港</span>||<span class="string">男</span>||<span class="string">光辉岁月</span></span><br><span class="line"><span class="string">08</span>||<span class="string">周传雄</span>||<span class="string">中国</span>||<span class="string">台湾</span>||<span class="string">男</span>||<span class="string">青花</span></span><br><span class="line"><span class="string">09</span>||<span class="string">刘若英</span>||<span class="string">中国</span>||<span class="string">台湾</span>||<span class="string">女</span>||<span class="string">很爱很爱你</span></span><br><span class="line"><span class="string">10</span>||<span class="string">张  杰</span>||<span class="string">中国</span>||<span class="string">四川</span>||<span class="string">男</span>||<span class="string">天下</span></span><br></pre></td></tr></table></figure></li>
<li><p>数据的字段中包含了分隔符</p>
 <figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168.88.134</span> <span class="string">[08/Nov/2020:10:44:32 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> / HTTP/1.1&quot;</span> <span class="number">404</span> <span class="number">951</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:10:44:33 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/index.html HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">328</span></span><br><span class="line"><span class="number">192.168.88.134</span> <span class="string">[08/Nov/2020:20:19:06 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> / HTTP/1.1&quot;</span> <span class="number">404</span> <span class="number">951</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:19:13 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/demo4.html HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">982</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:19:13 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/js/analytics.js HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">11095</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:19:23 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/demo3.html HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">1024</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:19:26 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/demo2.html HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">854</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:19:27 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/demo.html HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">485</span></span><br><span class="line"><span class="number">192.168.88.134</span> <span class="string">[08/Nov/2020:20:26:51 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> / HTTP/1.1&quot;</span> <span class="number">404</span> <span class="number">951</span></span><br><span class="line"><span class="number">192.168.88.134</span> <span class="string">[08/Nov/2020:20:29:08 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> / HTTP/1.1&quot;</span> <span class="number">404</span> <span class="number">951</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:31:27 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/demo5.html HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">5333</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:32:59 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/demo5.html HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">5333</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:32:59 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/js/analytics.js HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">11082</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:32:59 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /favicon.ico HTTP/1.1&quot;</span> <span class="number">404</span> <span class="number">973</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:33:01 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/demo3.html HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">1024</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:34:25 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/demo2.html HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">854</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:34:25 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/js/analytics.js HTTP/1.1&quot;</span> <span class="number">304</span> -</span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:34:28 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/demo4.html HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">982</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:35:05 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/demo.html HTTP/1.1&quot;</span> <span class="number">200</span> <span class="number">485</span></span><br><span class="line"><span class="number">192.168.88.100</span> <span class="string">[08/Nov/2020:20:35:05 +0800]</span> <span class="string">&quot;<span class="keyword">GET</span> /hpsk_sdk/js/analytics.js HTTP/1.1&quot;</span> <span class="number">304</span> -</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="解决方案一：替换分割符"><a href="#解决方案一：替换分割符" class="headerlink" title="解决方案一：替换分割符"></a>解决方案一：替换分割符</h5><p>如果数据中的分隔符是多字节分隔符，可以使用程序提前将数据中的多字节分隔符替换为单字节分隔符，然后使用Hive加载，就可以实现正确加载对应的数据。</p>
<ol>
<li><p>创建Maven工程，编写对应MapReduce代码</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hive-example<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hive-exec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--只包含该项目代码中用到的jar,在父项目中引入了，但在当前模块中没有用到就会被删掉--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">minimizeJar</span>&gt;</span>true<span class="tag">&lt;/<span class="name">minimizeJar</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">filters</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">artifact</span>&gt;</span>*:*<span class="tag">&lt;/<span class="name">artifact</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.SF<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.DSA<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.RSA<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">filters</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.hadoop.changesplit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configured;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.Tool;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.ToolRunner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现Tool接口，目的是为了 hadoop 命令调用保证可以传入一些与程序入参无关的命令行参数</span></span><br><span class="line"><span class="comment"> * Configured的getConf获取环境变量实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChangeSplitCharMR</span> <span class="keyword">extends</span> <span class="title">Configured</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] strings)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 1. 构建Job</span></span><br><span class="line">        Job job = Job.getInstance(<span class="keyword">this</span>.getConf(), <span class="string">&quot;changeSplit&quot;</span>);</span><br><span class="line">        job.setJarByClass(ChangeSplitCharMR.class);</span><br><span class="line">        <span class="comment">// 2. 配置Job</span></span><br><span class="line">        <span class="comment">// input</span></span><br><span class="line">        job.setInputFormatClass(TextInputFormat.class);</span><br><span class="line">        Path inputPath = <span class="keyword">new</span> Path(strings[<span class="number">0</span>]);</span><br><span class="line">        FileInputFormat.setInputPaths(job, inputPath);</span><br><span class="line">        <span class="comment">// map</span></span><br><span class="line">        job.setMapperClass(ChangeSplitMapper.class);</span><br><span class="line">        <span class="comment">// 设置输出类型</span></span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(NullWritable.class);</span><br><span class="line">        <span class="comment">// reduce：不需要 Reduce 过程</span></span><br><span class="line">        job.setNumReduceTasks(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// output</span></span><br><span class="line">        job.setOutputFormatClass(TextOutputFormat.class);</span><br><span class="line">        Path outputPath = <span class="keyword">new</span> Path(strings[<span class="number">1</span>]);</span><br><span class="line">        FileOutputFormat.setOutputPath(job, outputPath);</span><br><span class="line">        <span class="comment">// 提交 job</span></span><br><span class="line">        <span class="keyword">return</span> job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">        <span class="keyword">int</span> status = ToolRunner.run(conf, <span class="keyword">new</span> ChangeSplitCharMR(), args);</span><br><span class="line">        System.exit(status);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.hadoop.changesplit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChangeSplitMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Text outputKey = <span class="keyword">new</span> Text();</span><br><span class="line">    <span class="keyword">private</span> NullWritable outputValue = NullWritable.get();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        String line = value.toString();</span><br><span class="line">        outputKey.set(line.replace(<span class="string">&quot;||&quot;</span>,<span class="string">&quot;|&quot;</span>));</span><br><span class="line">        context.write(outputKey,outputValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>打包并上传</p>
<p>修改不带依赖的jar包为<strong>change-split.jar</strong>，并拷贝到虚拟机中</p>
</li>
<li><p>运行hadoop程序进行数据清洗</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[eitan@hadoop103 ~]$ hadoop fs -put documents/txt/test01.txt /tmp/hive_export</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[eitan@hadoop103 ~]$ hadoop jar change-split.jar cn.itcast.hadoop.changesplit.ChangeSplitCharMR /tmp/hive_export/test01.txt /tmp/hive_export/test01_wash.txt</span><br></pre></td></tr></table></figure></li>
<li><p>结果</p>
<p><img src="https://raw.githubusercontent.com/xyq-material/image/master/blog/20220516141542.png" alt="image-20220516141538027"></p>
</li>
</ol>
<h5 id="解决方案二：RegexSerDe正则加载"><a href="#解决方案二：RegexSerDe正则加载" class="headerlink" title="解决方案二：RegexSerDe正则加载"></a>解决方案二：RegexSerDe正则加载</h5><p>RegexSerde是Hive中专门为了满足复杂数据场景所提供的正则加载和解析数据的接口，使用RegexSerde可以指定正则表达式加载数据，根据正则表达式匹配每一列数据。</p>
<ol>
<li><p>分析数据</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.88.100 [08/Nov/2020:10:44:33 +0800] &quot;GET /hpsk_sdk/index.html HTTP/1.1&quot; 200 328</span><br></pre></td></tr></table></figure></li>
<li><p>正则表达式定义每一列</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">([^ ]*) ([^&#125;]*) ([^ ]*) ([^ ]*) ([^ ]*) ([0-9]*) ([^ ]*)</span><br></pre></td></tr></table></figure></li>
<li><p>创建表</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--创建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> apachelog</span><br><span class="line">(</span><br><span class="line">    ip     string, <span class="comment">--IP地址</span></span><br><span class="line">    stime  string, <span class="comment">--时间</span></span><br><span class="line">    mothed string, <span class="comment">--请求方式</span></span><br><span class="line">    url    string, <span class="comment">--请求地址</span></span><br><span class="line">    policy string, <span class="comment">--请求协议</span></span><br><span class="line">    stat   string, <span class="comment">--请求状态</span></span><br><span class="line">    body   string  <span class="comment">--字节大小</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">--指定使用RegexSerde加载数据</span></span><br><span class="line"><span class="type">ROW</span> FORMAT SERDE <span class="string">&#x27;org.apache.hadoop.hive.serde2.RegexSerDe&#x27;</span></span><br><span class="line"><span class="comment">--指定正则表达式</span></span><br><span class="line"><span class="keyword">WITH</span> SERDEPROPERTIES (</span><br><span class="line">  &quot;input.regex&quot; <span class="operator">=</span> &quot;([^ ]*) ([^&#125;]*) ([^ ]*) ([^ ]*) ([^ ]*) ([0-9]*) ([^ ]*)&quot;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">LOAD DATA INPATH &quot;/tmp/hive_export/apache_web_access.log&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> apachelog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> apachelog;</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="解决方案三：自定义InputFormat"><a href="#解决方案三：自定义InputFormat" class="headerlink" title="解决方案三：自定义InputFormat"></a>解决方案三：自定义InputFormat</h5><p>暂无手动实现。</p>
<h4 id="URL解析函数及侧视图"><a href="#URL解析函数及侧视图" class="headerlink" title="URL解析函数及侧视图"></a>URL解析函数及侧视图</h4><h5 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1	http://facebook.com/path/p1.php?query=1</span><br><span class="line">2	http://tongji.baidu.com/news/index.jsp?uuid=allen&amp;age=18</span><br><span class="line">3	http://www.jdwz.com/index?source=baidu</span><br><span class="line">4	http://www.itcast.cn/index?source=alibaba</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> t_url</span><br><span class="line">(</span><br><span class="line">    id  <span class="type">int</span>,</span><br><span class="line">    url string</span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED</span><br><span class="line">FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/url.txt&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> t_url;</span><br></pre></td></tr></table></figure>

<h5 id="parse-url"><a href="#parse-url" class="headerlink" title="parse_url"></a>parse_url</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id,</span><br><span class="line">       parse_url(url, &quot;PROTOCOL&quot;) <span class="keyword">AS</span> protocol,</span><br><span class="line">       parse_url(url, &quot;HOST&quot;)     <span class="keyword">AS</span> host,</span><br><span class="line">       parse_url(url, &quot;PATH&quot;)     <span class="keyword">AS</span> path,</span><br><span class="line">       parse_url(url, &quot;QUERY&quot;)    <span class="keyword">AS</span> query</span><br><span class="line"><span class="keyword">FROM</span> t_url;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+-----------+-------------------+------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span> protocol  <span class="operator">|</span>       host        <span class="operator">|</span>       path       <span class="operator">|</span>       query        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+-----------+-------------------+------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>   <span class="operator">|</span> http      <span class="operator">|</span> facebook.com      <span class="operator">|</span> <span class="operator">/</span>path<span class="operator">/</span>p1.php     <span class="operator">|</span> query<span class="operator">=</span><span class="number">1</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2</span>   <span class="operator">|</span> http      <span class="operator">|</span> tongji.baidu.com  <span class="operator">|</span> <span class="operator">/</span>news<span class="operator">/</span>index.jsp  <span class="operator">|</span> uuid<span class="operator">=</span>allen<span class="operator">&amp;</span>age<span class="operator">=</span><span class="number">18</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3</span>   <span class="operator">|</span> http      <span class="operator">|</span> www.jdwz.com      <span class="operator">|</span> <span class="operator">/</span>index           <span class="operator">|</span> source<span class="operator">=</span>baidu       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">4</span>   <span class="operator">|</span> http      <span class="operator">|</span> www.itcast.cn     <span class="operator">|</span> <span class="operator">/</span>index           <span class="operator">|</span> source<span class="operator">=</span>alibaba     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+-----------+-------------------+------------------+--------------------+</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>缺点：parse_url函数每次只能解析一个参数，导致需要经过多个函数调用才能构建多列，开发角度较为麻烦，实现过程性能也相对较差，需要对同一列做多次计算处理，我们希望能实现调用一次函数，就可以将多个参数进行解析，得到多列结果</p>
</blockquote>
<h5 id="parse-url-tuple"><a href="#parse-url-tuple" class="headerlink" title="parse_url_tuple"></a>parse_url_tuple</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.id,</span><br><span class="line">       b.protocol,</span><br><span class="line">       b.host,</span><br><span class="line">       b.path,</span><br><span class="line">       b.query</span><br><span class="line"><span class="keyword">FROM</span> t_url a</span><br><span class="line">         <span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> parse_url_tuple(url, &quot;PROTOCOL&quot;, &quot;HOST&quot;, &quot;PATH&quot;, &quot;QUERY&quot;) b <span class="keyword">AS</span> protocol, host, path, query;</span><br></pre></td></tr></table></figure>

<h4 id="行列转换应用"><a href="#行列转换应用" class="headerlink" title="行列转换应用"></a>行列转换应用</h4><h5 id="行转列：多行转多列"><a href="#行转列：多行转多列" class="headerlink" title="行转列：多行转多列"></a>行转列：多行转多列</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建表并导入数据</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> row2singlecol</span><br><span class="line">(</span><br><span class="line">    col1 string,</span><br><span class="line">    col2 string,</span><br><span class="line">    col3 <span class="type">int</span></span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED</span><br><span class="line">    FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/r2c1.txt&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> row2singlecol;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 数据展示</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> row2singlecol;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+---------------------+---------------------+</span></span><br><span class="line"><span class="operator">|</span> row2singlecol.col1  <span class="operator">|</span> row2singlecol.col2  <span class="operator">|</span> row2singlecol.col3  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+---------------------+---------------------+</span></span><br><span class="line"><span class="operator">|</span> a                   <span class="operator">|</span> c                   <span class="operator">|</span> <span class="number">1</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> a                   <span class="operator">|</span> d                   <span class="operator">|</span> <span class="number">2</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> a                   <span class="operator">|</span> e                   <span class="operator">|</span> <span class="number">3</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> b                   <span class="operator">|</span> c                   <span class="operator">|</span> <span class="number">4</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> b                   <span class="operator">|</span> d                   <span class="operator">|</span> <span class="number">5</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> b                   <span class="operator">|</span> e                   <span class="operator">|</span> <span class="number">6</span>                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+---------------------+---------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 多行转多列</span></span><br><span class="line"><span class="keyword">SELECT</span> col1,</span><br><span class="line">       <span class="built_in">max</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> col2 <span class="operator">=</span> &quot;c&quot; <span class="keyword">THEN</span> col3 <span class="keyword">END</span>) <span class="keyword">AS</span> c,</span><br><span class="line">       <span class="built_in">max</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> col2 <span class="operator">=</span> &quot;d&quot; <span class="keyword">THEN</span> col3 <span class="keyword">END</span>) <span class="keyword">AS</span> d,</span><br><span class="line">       <span class="built_in">max</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> col2 <span class="operator">=</span> &quot;e&quot; <span class="keyword">THEN</span> col3 <span class="keyword">END</span>) <span class="keyword">AS</span> e</span><br><span class="line"><span class="keyword">FROM</span> row2singlecol <span class="keyword">GROUP</span> <span class="keyword">BY</span> col1;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----+----+----+</span></span><br><span class="line"><span class="operator">|</span> col1  <span class="operator">|</span> c  <span class="operator">|</span> d  <span class="operator">|</span> e  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----+----+----+</span></span><br><span class="line"><span class="operator">|</span> a     <span class="operator">|</span> <span class="number">1</span>  <span class="operator">|</span> <span class="number">2</span>  <span class="operator">|</span> <span class="number">3</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> b     <span class="operator">|</span> <span class="number">4</span>  <span class="operator">|</span> <span class="number">5</span>  <span class="operator">|</span> <span class="number">6</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+----+----+----+</span></span><br></pre></td></tr></table></figure>

<h5 id="行转列：多行转单列"><a href="#行转列：多行转单列" class="headerlink" title="行转列：多行转单列"></a>行转列：多行转单列</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建表并导入数据</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> row2multicol</span><br><span class="line">(</span><br><span class="line">    col1 string,</span><br><span class="line">    col2 string,</span><br><span class="line">    col3 <span class="type">int</span></span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED</span><br><span class="line">    FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/r2c2.txt&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> row2multicol;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 数据展示</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> row2multicol;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> row2multicol.col1  <span class="operator">|</span> row2multicol.col2  <span class="operator">|</span> row2multicol.col3  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> a                  <span class="operator">|</span> b                  <span class="operator">|</span> <span class="number">1</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> a                  <span class="operator">|</span> b                  <span class="operator">|</span> <span class="number">2</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> a                  <span class="operator">|</span> b                  <span class="operator">|</span> <span class="number">3</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> c                  <span class="operator">|</span> d                  <span class="operator">|</span> <span class="number">4</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> c                  <span class="operator">|</span> d                  <span class="operator">|</span> <span class="number">5</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> c                  <span class="operator">|</span> d                  <span class="operator">|</span> <span class="number">6</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------------+--------------------+</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 多行转单列</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">       col1,</span><br><span class="line">       col2,</span><br><span class="line">       concat_ws(<span class="string">&#x27;,&#x27;</span>, collect_list(<span class="built_in">cast</span>(col3 <span class="keyword">as</span> string))) <span class="keyword">AS</span> col3</span><br><span class="line"><span class="keyword">FROM</span> row2multicol</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> col1, col2;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+--------+</span></span><br><span class="line"><span class="operator">|</span> col1  <span class="operator">|</span> col2  <span class="operator">|</span>  col3  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+--------+</span></span><br><span class="line"><span class="operator">|</span> a     <span class="operator">|</span> b     <span class="operator">|</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> c     <span class="operator">|</span> d     <span class="operator">|</span> <span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-------+--------+</span></span><br></pre></td></tr></table></figure>

<h5 id="列转行：多列转多行"><a href="#列转行：多列转多行" class="headerlink" title="列转行：多列转多行"></a>列转行：多列转多行</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建表并导入数据</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> col2multirow</span><br><span class="line">(</span><br><span class="line">    col1 string,</span><br><span class="line">    col2 <span class="type">int</span>,</span><br><span class="line">    col3 <span class="type">int</span>,</span><br><span class="line">    col4 <span class="type">int</span></span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED</span><br><span class="line">    FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/c2r2.txt&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> col2multirow;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 多列转单行</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> col2multirow;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------------+--------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> col2multirow.col1  <span class="operator">|</span> col2multirow.col2  <span class="operator">|</span> col2multirow.col3  <span class="operator">|</span> col2multirow.col4  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------------+--------------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> a                  <span class="operator">|</span> <span class="number">1</span>                  <span class="operator">|</span> <span class="number">2</span>                  <span class="operator">|</span> <span class="number">3</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> b                  <span class="operator">|</span> <span class="number">4</span>                  <span class="operator">|</span> <span class="number">5</span>                  <span class="operator">|</span> <span class="number">6</span>                  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+--------------------+--------------------+--------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> col1,&quot;a&quot; <span class="keyword">AS</span> col2,col2 <span class="keyword">AS</span> col3 <span class="keyword">FROM</span> col2multirow</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> col1,&quot;b&quot; <span class="keyword">AS</span> col2,col3 <span class="keyword">AS</span> col3 <span class="keyword">FROM</span> col2multirow</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> col1,&quot;c&quot; <span class="keyword">AS</span> col2,col4 <span class="keyword">AS</span> col3 <span class="keyword">FROM</span> col2multirow;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+-----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> _u1.col1  <span class="operator">|</span> _u1.col2  <span class="operator">|</span> _u1.col3  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+-----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> a         <span class="operator">|</span> a         <span class="operator">|</span> <span class="number">1</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> a         <span class="operator">|</span> b         <span class="operator">|</span> <span class="number">2</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> a         <span class="operator">|</span> c         <span class="operator">|</span> <span class="number">3</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> b         <span class="operator">|</span> a         <span class="operator">|</span> <span class="number">4</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> b         <span class="operator">|</span> b         <span class="operator">|</span> <span class="number">5</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> b         <span class="operator">|</span> c         <span class="operator">|</span> <span class="number">6</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+-----------+-----------+</span></span><br></pre></td></tr></table></figure>

<h5 id="列转行：单列转多行"><a href="#列转行：单列转多行" class="headerlink" title="列转行：单列转多行"></a>列转行：单列转多行</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建表并导入数据</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> singlecol2row</span><br><span class="line">(</span><br><span class="line">    col1 string,</span><br><span class="line">    col2 string,</span><br><span class="line">    col3 string</span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED</span><br><span class="line">    FIELDS TERMINATED <span class="keyword">BY</span> &quot;\t&quot;;</span><br><span class="line"></span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/c2r2.txt&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> singlecol2row;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 单列转多行</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> singlecol2row;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+---------------------+---------------------+</span></span><br><span class="line"><span class="operator">|</span> singlecol2row.col1  <span class="operator">|</span> singlecol2row.col2  <span class="operator">|</span> singlecol2row.col3  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+---------------------+---------------------+</span></span><br><span class="line"><span class="operator">|</span> a                   <span class="operator">|</span> b                   <span class="operator">|</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> c                   <span class="operator">|</span> d                   <span class="operator">|</span> <span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+---------------------+---------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> a.col1,</span><br><span class="line">       a.col2,</span><br><span class="line">       b.col3</span><br><span class="line"><span class="keyword">FROM</span> singlecol2row a</span><br><span class="line">         <span class="keyword">LATERAL</span> <span class="keyword">VIEW</span> explode(split(col3, &quot;,&quot;)) b <span class="keyword">AS</span> col3;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------+---------+</span></span><br><span class="line"><span class="operator">|</span> a.col1  <span class="operator">|</span> a.col2  <span class="operator">|</span> b.col3  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------+---------+</span></span><br><span class="line"><span class="operator">|</span> a       <span class="operator">|</span> b       <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> a       <span class="operator">|</span> b       <span class="operator">|</span> <span class="number">2</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> a       <span class="operator">|</span> b       <span class="operator">|</span> <span class="number">3</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> c       <span class="operator">|</span> d       <span class="operator">|</span> <span class="number">4</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> c       <span class="operator">|</span> d       <span class="operator">|</span> <span class="number">5</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> c       <span class="operator">|</span> d       <span class="operator">|</span> <span class="number">6</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------+---------+</span></span><br></pre></td></tr></table></figure>

<h4 id="JSON数据处理"><a href="#JSON数据处理" class="headerlink" title="JSON数据处理"></a>JSON数据处理</h4><h5 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h5><p>将json文件每一个字段解析成对应的表字段</p>
<h5 id="方法一：使用JSON解析函数"><a href="#方法一：使用JSON解析函数" class="headerlink" title="方法一：使用JSON解析函数"></a>方法一：使用JSON解析函数</h5><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">-- 建表并导入数据</span><br><span class="line">CREATE TABLE t_json_method1</span><br><span class="line">(</span><br><span class="line">    json string</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">LOAD DATA LOCAL INPATH <span class="string">&quot;/home/eitan/documents/txt/device.json&quot;</span> INTO TABLE t_json_method1;</span><br><span class="line"></span><br><span class="line">-- 查询</span><br><span class="line">SELECT json_tuple(json, <span class="string">&quot;device&quot;</span>, <span class="string">&quot;deviceType&quot;</span>, <span class="string">&quot;signal&quot;</span>, <span class="string">&quot;time&quot;</span>)</span><br><span class="line">           AS (device, deviceType, signal, stime)</span><br><span class="line">FROM t_json_method1;</span><br><span class="line"></span><br><span class="line">+------------+-------------+---------+----------------+</span><br><span class="line">|<span class="string">   device   </span>|<span class="string"> devicetype  </span>|<span class="string"> signal  </span>|<span class="string">     stime      </span>|</span><br><span class="line">+------------+-------------+---------+----------------+</span><br><span class="line">|<span class="string"> device_30  </span>|<span class="string"> kafka       </span>|<span class="string"> 98.0    </span>|<span class="string"> 1616817201390  </span>|</span><br><span class="line">|<span class="string"> device_40  </span>|<span class="string"> route       </span>|<span class="string"> 99.0    </span>|<span class="string"> 1616817201887  </span>|</span><br><span class="line">|<span class="string"> device_21  </span>|<span class="string"> bigdata     </span>|<span class="string"> 77.0    </span>|<span class="string"> 1616817202142  </span>|</span><br><span class="line">|<span class="string"> device_31  </span>|<span class="string"> kafka       </span>|<span class="string"> 98.0    </span>|<span class="string"> 1616817202405  </span>|</span><br><span class="line">|<span class="string"> device_20  </span>|<span class="string"> bigdata     </span>|<span class="string"> 12.0    </span>|<span class="string"> 1616817202513  </span>|</span><br><span class="line">|<span class="string"> device_54  </span>|<span class="string"> bigdata     </span>|<span class="string"> 14.0    </span>|<span class="string"> 1616817202913  </span>|</span><br><span class="line">|<span class="string"> device_10  </span>|<span class="string"> db          </span>|<span class="string"> 39.0    </span>|<span class="string"> 1616817203356  </span>|</span><br><span class="line">|<span class="string"> device_94  </span>|<span class="string"> bigdata     </span>|<span class="string"> 59.0    </span>|<span class="string"> 1616817203771  </span>|</span><br><span class="line">|<span class="string"> device_32  </span>|<span class="string"> kafka       </span>|<span class="string"> 52.0    </span>|<span class="string"> 1616817204010  </span>|</span><br><span class="line">|<span class="string"> device_21  </span>|<span class="string"> bigdata     </span>|<span class="string"> 85.0    </span>|<span class="string"> 1616817204229  </span>|</span><br><span class="line">|<span class="string"> device_74  </span>|<span class="string"> bigdata     </span>|<span class="string"> 27.0    </span>|<span class="string"> 1616817204720  </span>|</span><br><span class="line">|<span class="string"> device_91  </span>|<span class="string"> bigdata     </span>|<span class="string"> 50.0    </span>|<span class="string"> 1616817205164  </span>|</span><br><span class="line">|<span class="string"> device_62  </span>|<span class="string"> db          </span>|<span class="string"> 89.0    </span>|<span class="string"> 1616817205328  </span>|</span><br><span class="line">|<span class="string"> device_21  </span>|<span class="string"> bigdata     </span>|<span class="string"> 25.0    </span>|<span class="string"> 1616817205457  </span>|</span><br><span class="line">|<span class="string"> device_76  </span>|<span class="string"> bigdata     </span>|<span class="string"> 62.0    </span>|<span class="string"> 1616817205984  </span>|</span><br><span class="line">|<span class="string"> device_74  </span>|<span class="string"> bigdata     </span>|<span class="string"> 44.0    </span>|<span class="string"> 1616817206571  </span>|</span><br><span class="line">|<span class="string"> device_42  </span>|<span class="string"> route       </span>|<span class="string"> 43.0    </span>|<span class="string"> 1616817206681  </span>|</span><br><span class="line">|<span class="string"> device_32  </span>|<span class="string"> kafka       </span>|<span class="string"> 65.0    </span>|<span class="string"> 1616817207131  </span>|</span><br><span class="line">|<span class="string"> device_32  </span>|<span class="string"> kafka       </span>|<span class="string"> 95.0    </span>|<span class="string"> 1616817207714  </span>|</span><br><span class="line">|<span class="string"> device_71  </span>|<span class="string"> bigdata     </span>|<span class="string"> 45.0    </span>|<span class="string"> 1616817207907  </span>|</span><br><span class="line">|<span class="string"> device_32  </span>|<span class="string"> kafka       </span>|<span class="string"> 81.0    </span>|<span class="string"> 1616817208320  </span>|</span><br><span class="line">|<span class="string"> device_10  </span>|<span class="string"> db          </span>|<span class="string"> 81.0    </span>|<span class="string"> 1616817208907  </span>|</span><br><span class="line">|<span class="string"> device_20  </span>|<span class="string"> bigdata     </span>|<span class="string"> 69.0    </span>|<span class="string"> 1616817209287  </span>|</span><br><span class="line">|<span class="string"> device_61  </span>|<span class="string"> db          </span>|<span class="string"> 98.0    </span>|<span class="string"> 1616817209785  </span>|</span><br><span class="line">|<span class="string"> device_30  </span>|<span class="string"> kafka       </span>|<span class="string"> 95.0    </span>|<span class="string"> 1616817210104  </span>|</span><br><span class="line">|<span class="string"> device_43  </span>|<span class="string"> route       </span>|<span class="string"> 57.0    </span>|<span class="string"> 1616817210540  </span>|</span><br><span class="line">|<span class="string"> device_10  </span>|<span class="string"> db          </span>|<span class="string"> 36.0    </span>|<span class="string"> 1616817211134  </span>|</span><br><span class="line">|<span class="string"> device_20  </span>|<span class="string"> bigdata     </span>|<span class="string"> 75.0    </span>|<span class="string"> 1616817211248  </span>|</span><br><span class="line">|<span class="string"> device_64  </span>|<span class="string"> db          </span>|<span class="string"> 68.0    </span>|<span class="string"> 1616817211812  </span>|</span><br><span class="line">|<span class="string"> device_53  </span>|<span class="string"> bigdata     </span>|<span class="string"> 60.0    </span>|<span class="string"> 1616817212237  </span>|</span><br><span class="line">|<span class="string"> device_52  </span>|<span class="string"> bigdata     </span>|<span class="string"> 57.0    </span>|<span class="string"> 1616817212709  </span>|</span><br><span class="line">|<span class="string"> device_30  </span>|<span class="string"> kafka       </span>|<span class="string"> 75.0    </span>|<span class="string"> 1616817213073  </span>|</span><br><span class="line">|<span class="string"> device_31  </span>|<span class="string"> kafka       </span>|<span class="string"> 83.0    </span>|<span class="string"> 1616817213614  </span>|</span><br><span class="line">|<span class="string"> device_93  </span>|<span class="string"> bigdata     </span>|<span class="string"> 54.0    </span>|<span class="string"> 1616817214101  </span>|</span><br><span class="line">|<span class="string"> device_20  </span>|<span class="string"> bigdata     </span>|<span class="string"> 84.0    </span>|<span class="string"> 1616817214639  </span>|</span><br><span class="line">+------------+-------------+---------+----------------+</span><br></pre></td></tr></table></figure>

<h5 id="方法二：指定解析JSON的SerDe"><a href="#方法二：指定解析JSON的SerDe" class="headerlink" title="方法二：指定解析JSON的SerDe"></a>方法二：指定解析JSON的SerDe</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建表并指定序列化和反序列化的类</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_json_method2</span><br><span class="line">(</span><br><span class="line">    device     string,</span><br><span class="line">    deviceType string,</span><br><span class="line">    signal     <span class="keyword">double</span>,</span><br><span class="line"> 	`<span class="type">time</span>`       string</span><br><span class="line">) <span class="type">ROW</span> FORMAT SERDE <span class="string">&#x27;org.apache.hive.hcatalog.data.JsonSerDe&#x27;</span></span><br><span class="line">    STORED <span class="keyword">AS</span> TEXTFILE;</span><br><span class="line"></span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/device.json&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> t_json_method2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_json_method2;</span><br></pre></td></tr></table></figure>

<h4 id="窗口函数应用实例"><a href="#窗口函数应用实例" class="headerlink" title="窗口函数应用实例"></a>窗口函数应用实例</h4><h5 id="连续登陆用户"><a href="#连续登陆用户" class="headerlink" title="连续登陆用户"></a>连续登陆用户</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建表并加载数据</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_login</span><br><span class="line">(</span><br><span class="line">    userid    string,</span><br><span class="line">    logintime string</span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/login.log&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> t_login;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_login;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> t_login.userid  <span class="operator">|</span> t_login.logintime  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+--------------------+</span></span><br><span class="line"><span class="operator">|</span> A               <span class="operator">|</span> <span class="number">2021</span><span class="number">-03</span><span class="number">-22</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> B               <span class="operator">|</span> <span class="number">2021</span><span class="number">-03</span><span class="number">-22</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> C               <span class="operator">|</span> <span class="number">2021</span><span class="number">-03</span><span class="number">-22</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> A               <span class="operator">|</span> <span class="number">2021</span><span class="number">-03</span><span class="number">-23</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> C               <span class="operator">|</span> <span class="number">2021</span><span class="number">-03</span><span class="number">-23</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> A               <span class="operator">|</span> <span class="number">2021</span><span class="number">-03</span><span class="number">-24</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> B               <span class="operator">|</span> <span class="number">2021</span><span class="number">-03</span><span class="number">-24</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+--------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 连续两天登入的用户</span></span><br><span class="line"><span class="keyword">WITH</span> t1 <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> userid,</span><br><span class="line">           logintime,</span><br><span class="line">           <span class="built_in">lead</span>(logintime, <span class="number">1</span>) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> userid <span class="keyword">ORDER</span> <span class="keyword">BY</span> logintime) <span class="keyword">as</span> nexttime</span><br><span class="line">    <span class="keyword">FROM</span> t_login</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> userid <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> date_add(logintime, <span class="number">1</span>) <span class="operator">=</span><span class="operator">=</span> nexttime;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 连续三天登入的用户</span></span><br><span class="line"><span class="keyword">WITH</span> t1 <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> userid,</span><br><span class="line">           date_add(logintime, <span class="number">2</span>)                                           <span class="keyword">AS</span> nextday,</span><br><span class="line">           <span class="built_in">lead</span>(logintime, <span class="number">2</span>) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> userid <span class="keyword">ORDER</span> <span class="keyword">BY</span> logintime) <span class="keyword">as</span> nextlogin</span><br><span class="line">    <span class="keyword">FROM</span> t_login</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> userid <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> nextday <span class="operator">=</span> nextlogin;</span><br></pre></td></tr></table></figure>

<h5 id="级联累加求和"><a href="#级联累加求和" class="headerlink" title="级联累加求和"></a>级联累加求和</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建表加载数据</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_money</span><br><span class="line">(</span><br><span class="line">    userid string,</span><br><span class="line">    mth    string,</span><br><span class="line">    money  <span class="type">int</span></span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED</span><br><span class="line">    FIELDS TERMINATED <span class="keyword">BY</span> &quot;\t&quot;;</span><br><span class="line"></span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/money.tsv&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> t_money;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t_money;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+--------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> t_money.userid  <span class="operator">|</span> t_money.mth  <span class="operator">|</span> t_money.money  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+--------------+----------------+</span></span><br><span class="line"><span class="operator">|</span> A               <span class="operator">|</span> <span class="number">2021</span><span class="number">-01</span>      <span class="operator">|</span> <span class="number">5</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> A               <span class="operator">|</span> <span class="number">2021</span><span class="number">-01</span>      <span class="operator">|</span> <span class="number">15</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> B               <span class="operator">|</span> <span class="number">2021</span><span class="number">-01</span>      <span class="operator">|</span> <span class="number">5</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> A               <span class="operator">|</span> <span class="number">2021</span><span class="number">-01</span>      <span class="operator">|</span> <span class="number">8</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> B               <span class="operator">|</span> <span class="number">2021</span><span class="number">-01</span>      <span class="operator">|</span> <span class="number">25</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> A               <span class="operator">|</span> <span class="number">2021</span><span class="number">-01</span>      <span class="operator">|</span> <span class="number">5</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> A               <span class="operator">|</span> <span class="number">2021</span><span class="number">-02</span>      <span class="operator">|</span> <span class="number">4</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> A               <span class="operator">|</span> <span class="number">2021</span><span class="number">-02</span>      <span class="operator">|</span> <span class="number">6</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> B               <span class="operator">|</span> <span class="number">2021</span><span class="number">-02</span>      <span class="operator">|</span> <span class="number">10</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> B               <span class="operator">|</span> <span class="number">2021</span><span class="number">-02</span>      <span class="operator">|</span> <span class="number">5</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> A               <span class="operator">|</span> <span class="number">2021</span><span class="number">-03</span>      <span class="operator">|</span> <span class="number">7</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> B               <span class="operator">|</span> <span class="number">2021</span><span class="number">-03</span>      <span class="operator">|</span> <span class="number">9</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> A               <span class="operator">|</span> <span class="number">2021</span><span class="number">-03</span>      <span class="operator">|</span> <span class="number">11</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> B               <span class="operator">|</span> <span class="number">2021</span><span class="number">-03</span>      <span class="operator">|</span> <span class="number">6</span>              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+--------------+----------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询每月消费金额和累计消费金额</span></span><br><span class="line"><span class="keyword">WITH</span> t1 <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> userid,</span><br><span class="line">           mth,</span><br><span class="line">           <span class="built_in">sum</span>(money) <span class="keyword">AS</span> m_money</span><br><span class="line">    <span class="keyword">FROM</span> t_money <span class="keyword">GROUP</span> <span class="keyword">BY</span> userid, mth</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> userid, mth, m_money, <span class="built_in">sum</span>(m_money) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> userid <span class="keyword">ORDER</span> <span class="keyword">BY</span> mth) <span class="keyword">FROM</span> t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+----------+----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> userid  <span class="operator">|</span>   mth    <span class="operator">|</span> m_money  <span class="operator">|</span> sum_window_0  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+----------+----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> A       <span class="operator">|</span> <span class="number">2021</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">33</span>       <span class="operator">|</span> <span class="number">33</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> A       <span class="operator">|</span> <span class="number">2021</span><span class="number">-02</span>  <span class="operator">|</span> <span class="number">10</span>       <span class="operator">|</span> <span class="number">43</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> A       <span class="operator">|</span> <span class="number">2021</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">18</span>       <span class="operator">|</span> <span class="number">61</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> B       <span class="operator">|</span> <span class="number">2021</span><span class="number">-01</span>  <span class="operator">|</span> <span class="number">30</span>       <span class="operator">|</span> <span class="number">30</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> B       <span class="operator">|</span> <span class="number">2021</span><span class="number">-02</span>  <span class="operator">|</span> <span class="number">15</span>       <span class="operator">|</span> <span class="number">45</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> B       <span class="operator">|</span> <span class="number">2021</span><span class="number">-03</span>  <span class="operator">|</span> <span class="number">15</span>       <span class="operator">|</span> <span class="number">60</span>            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+----------+----------+---------------+</span></span><br></pre></td></tr></table></figure>

<h5 id="分组TopN"><a href="#分组TopN" class="headerlink" title="分组TopN"></a>分组TopN</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建表并载入数据</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t_emp</span><br><span class="line">(</span><br><span class="line">    empno     string,</span><br><span class="line">    ename     string,</span><br><span class="line">    job       string,</span><br><span class="line">    managerid string,</span><br><span class="line">    hiredate  string,</span><br><span class="line">    salary    <span class="keyword">double</span>,</span><br><span class="line">    bonus     <span class="keyword">double</span>,</span><br><span class="line">    deptno    string</span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED</span><br><span class="line">    FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/emp.txt&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> t_emp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> empno,ename,salary,deptno <span class="keyword">FROM</span> t_emp;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------+---------+---------+</span></span><br><span class="line"><span class="operator">|</span> empno  <span class="operator">|</span>  ename  <span class="operator">|</span> salary  <span class="operator">|</span> deptno  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------+---------+---------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7369</span>   <span class="operator">|</span> SMITH   <span class="operator">|</span> <span class="number">800.0</span>   <span class="operator">|</span> <span class="number">20</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7499</span>   <span class="operator">|</span> ALLEN   <span class="operator">|</span> <span class="number">1600.0</span>  <span class="operator">|</span> <span class="number">30</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7521</span>   <span class="operator">|</span> WARD    <span class="operator">|</span> <span class="number">1250.0</span>  <span class="operator">|</span> <span class="number">30</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7566</span>   <span class="operator">|</span> JONES   <span class="operator">|</span> <span class="number">2975.0</span>  <span class="operator">|</span> <span class="number">20</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7654</span>   <span class="operator">|</span> MARTIN  <span class="operator">|</span> <span class="number">1250.0</span>  <span class="operator">|</span> <span class="number">30</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7698</span>   <span class="operator">|</span> BLAKE   <span class="operator">|</span> <span class="number">2850.0</span>  <span class="operator">|</span> <span class="number">30</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7782</span>   <span class="operator">|</span> CLARK   <span class="operator">|</span> <span class="number">2450.0</span>  <span class="operator">|</span> <span class="number">10</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7788</span>   <span class="operator">|</span> SCOTT   <span class="operator">|</span> <span class="number">3000.0</span>  <span class="operator">|</span> <span class="number">20</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7839</span>   <span class="operator">|</span> KING    <span class="operator">|</span> <span class="number">5000.0</span>  <span class="operator">|</span> <span class="number">10</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7844</span>   <span class="operator">|</span> TURNER  <span class="operator">|</span> <span class="number">1500.0</span>  <span class="operator">|</span> <span class="number">30</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7876</span>   <span class="operator">|</span> ADAMS   <span class="operator">|</span> <span class="number">1100.0</span>  <span class="operator">|</span> <span class="number">20</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7900</span>   <span class="operator">|</span> JAMES   <span class="operator">|</span> <span class="number">950.0</span>   <span class="operator">|</span> <span class="number">30</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7902</span>   <span class="operator">|</span> FORD    <span class="operator">|</span> <span class="number">3000.0</span>  <span class="operator">|</span> <span class="number">20</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7934</span>   <span class="operator">|</span> MILLER  <span class="operator">|</span> <span class="number">1300.0</span>  <span class="operator">|</span> <span class="number">10</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------+---------+---------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询每个部分薪水前2名</span></span><br><span class="line"><span class="keyword">WITH</span> t1 <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> empno,</span><br><span class="line">           ename,</span><br><span class="line">           salary,</span><br><span class="line">           deptno,</span><br><span class="line">           <span class="built_in">row_number</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> deptno <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span> t_emp</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t1 <span class="keyword">WHERE</span> rn <span class="operator">&lt;</span> <span class="number">3</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+-----------+------------+------------+--------+</span></span><br><span class="line"><span class="operator">|</span> t1.empno  <span class="operator">|</span> t1.ename  <span class="operator">|</span> t1.salary  <span class="operator">|</span> t1.deptno  <span class="operator">|</span> t1.rn  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+-----------+------------+------------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7839</span>      <span class="operator">|</span> KING      <span class="operator">|</span> <span class="number">5000.0</span>     <span class="operator">|</span> <span class="number">10</span>         <span class="operator">|</span> <span class="number">1</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7782</span>      <span class="operator">|</span> CLARK     <span class="operator">|</span> <span class="number">2450.0</span>     <span class="operator">|</span> <span class="number">10</span>         <span class="operator">|</span> <span class="number">2</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7788</span>      <span class="operator">|</span> SCOTT     <span class="operator">|</span> <span class="number">3000.0</span>     <span class="operator">|</span> <span class="number">20</span>         <span class="operator">|</span> <span class="number">1</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7902</span>      <span class="operator">|</span> FORD      <span class="operator">|</span> <span class="number">3000.0</span>     <span class="operator">|</span> <span class="number">20</span>         <span class="operator">|</span> <span class="number">2</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7698</span>      <span class="operator">|</span> BLAKE     <span class="operator">|</span> <span class="number">2850.0</span>     <span class="operator">|</span> <span class="number">30</span>         <span class="operator">|</span> <span class="number">1</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7499</span>      <span class="operator">|</span> ALLEN     <span class="operator">|</span> <span class="number">1600.0</span>     <span class="operator">|</span> <span class="number">30</span>         <span class="operator">|</span> <span class="number">2</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+-----------+------------+------------+--------+</span></span><br></pre></td></tr></table></figure>

<h4 id="拉链表的设计与实现"><a href="#拉链表的设计与实现" class="headerlink" title="拉链表的设计与实现"></a>拉链表的设计与实现</h4><h5 id="功能与应用场景"><a href="#功能与应用场景" class="headerlink" title="功能与应用场景"></a>功能与应用场景</h5><p>拉链表专门用于解决在数据仓库中数据发生变化如何实现数据存储的问题，如果直接覆盖历史状态，会导致无法查询历史状态，如果将所有数据单独切片存储，会导致存储大量非更新数据的问题。</p>
<p>拉链表的设计是将更新的数据进行状态记录，没有发生更新的数据不进行状态存储，用于存储所有数据在不同时间上的所有状态，通过时间进行标记每个状态的生命周期，查询时，根据需求可以获取指定时间范围状态的数据，默认用9999-12-31等最大值来表示最新状态。</p>
<h5 id="拉链表实现"><a href="#拉链表实现" class="headerlink" title="拉链表实现"></a>拉链表实现</h5><ol>
<li><p>创建表并插入数据</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dw_zipper</span><br><span class="line">(</span><br><span class="line">    userid    string,</span><br><span class="line">    phone     string,</span><br><span class="line">    nick      string,</span><br><span class="line">    gender    <span class="type">int</span>,</span><br><span class="line">    addr      string,</span><br><span class="line">    starttime string,</span><br><span class="line">    endtime   string</span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/zipper.txt&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> dw_zipper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> dw_zipper;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/xyq-material/image/master/blog/20220518172138.png" alt="image-20220518172133066"></p>
</li>
<li><p>创建ods层增量表，模拟增量</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ods_zipper_update</span><br><span class="line">(</span><br><span class="line">    userid    string,</span><br><span class="line">    phone     string,</span><br><span class="line">    nick      string,</span><br><span class="line">    gender    <span class="type">int</span>,</span><br><span class="line">    addr      string,</span><br><span class="line">    starttime string,</span><br><span class="line">    endtime   string</span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line">LOAD DATA <span class="keyword">LOCAL</span> INPATH &quot;/home/eitan/documents/txt/update.txt&quot; <span class="keyword">INTO</span> <span class="keyword">TABLE</span> ods_zipper_update;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> ods_zipper_update;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/xyq-material/image/master/blog/20220518172819.png" alt="image-20220518172817709"></p>
</li>
<li><p>合并数据</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建零时表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_zipper</span><br><span class="line">(</span><br><span class="line">    userid    string,</span><br><span class="line">    phone     string,</span><br><span class="line">    nick      string,</span><br><span class="line">    gender    <span class="type">int</span>,</span><br><span class="line">    addr      string,</span><br><span class="line">    starttime string,</span><br><span class="line">    endtime   string</span><br><span class="line">) <span class="type">ROW</span> FORMAT DELIMITED FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 合并拉链表与增量表</span></span><br><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> tmp_zipper</span><br><span class="line"><span class="keyword">SELECT</span> userid,</span><br><span class="line">       phone,</span><br><span class="line">       nick,</span><br><span class="line">       gender,</span><br><span class="line">       addr,</span><br><span class="line">       starttime,</span><br><span class="line">       endtime</span><br><span class="line"><span class="keyword">FROM</span> ods_zipper_update</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> a.userid,</span><br><span class="line">       a.phone,</span><br><span class="line">       a.nick,</span><br><span class="line">       a.gender,</span><br><span class="line">       a.addr,</span><br><span class="line">       a.starttime,</span><br><span class="line">       if(b.userid <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">OR</span> a.endtime <span class="operator">&lt;</span> &quot;9999-12-31&quot;, a.endtime, date_sub(b.starttime, <span class="number">1</span>)) <span class="keyword">AS</span> endtime</span><br><span class="line"><span class="keyword">FROM</span> dw_zipper a</span><br><span class="line">         <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> ods_zipper_update b <span class="keyword">ON</span> a.userid <span class="operator">=</span> b.userid;</span><br></pre></td></tr></table></figure></li>
<li><p>覆盖拉链表</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> dw_zipper</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tmp_zipper <span class="keyword">ORDER</span> <span class="keyword">BY</span> userid;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Hive性能优化"><a href="#Hive性能优化" class="headerlink" title="Hive性能优化"></a>Hive性能优化</h3><h4 id="Hive表设计优化"><a href="#Hive表设计优化" class="headerlink" title="Hive表设计优化"></a>Hive表设计优化</h4><h5 id="分区表"><a href="#分区表" class="headerlink" title="分区表"></a>分区表</h5><p>根据查询的需求，将数据按照查询的条件【一般都以时间】进行划分分区存储，将不同分区的数据单独使用一个HDFS目录来进行存储，当底层实现计算时，根据查询的条件，只读取对应分区的数据作为输入，减少不必要的数据加载，提高程序的性能。</p>
<h5 id="分桶表"><a href="#分桶表" class="headerlink" title="分桶表"></a>分桶表</h5><p>分桶表的设计有别于分区表的设计，分区表是将数据划分不同的目录进行存储，而分桶表是将数据划分不同的文件进行存储。分桶表的设计是按照一定的规则【通过MapReduce中的多个Reduce来实现】将数据划分到不同的文件中进行存储，构建分桶表。</p>
<p>如果有两张表按照相同的划分规则【按照Join的关联字段】将各自的数据进行划分，在Join时，就可以实现Bucket与Bucket的Join，避免不必要的比较。</p>
<h4 id="Hive表数据优化"><a href="#Hive表数据优化" class="headerlink" title="Hive表数据优化"></a>Hive表数据优化</h4><h5 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h5><table>
<thead>
<tr>
<th>文件格式</th>
<th>优点</th>
<th>缺点</th>
<th>应用场景</th>
</tr>
</thead>
<tbody><tr>
<td>TextFIle（默认）</td>
<td>1. 最简单的数据格式，不需要经过处理，可以直接查看<br />2. 可以使用任意的分隔符进行分割<br />3. 可以搭配Gzip、Bzip2、Snappy等压缩一起使用</td>
<td>1. 耗费存储空间，I/O性能较低<br />2. 结合压缩时Hive不进行数据切分合并，不能进行并行操作，查询效率低<br />3. 按行存储，读取列的性能差</td>
<td>1. 适合于小量数据的存储查询<br />2. 一般用于做第一层数据加载和测试使用</td>
</tr>
<tr>
<td>SequenceFile</td>
<td>1. 以二进制的KV形式存储数据，与底层交互更加友好，性能更快<br />2. 可压缩、可分割，优化磁盘利用率和I/O<br />3. 可并行操作数据，查询效率高<br />4. SequenceFile也可以用于存储多个小文件</td>
<td>1. 存储空间消耗最大<br />2. 与非Hadoop生态系统之外的工具不兼容<br />3. n 构建SequenceFile需要通过TextFile文件转化加载</td>
<td>1. 适合于小量数据，但是查询列比较多的场景</td>
</tr>
<tr>
<td>Parquet</td>
<td>1. 更高效的压缩和编码<br />2. 可用于多种数据处理框架</td>
<td>1. 不支持update, insert, delete, ACID</td>
<td>1. 适用于字段数非常多，无更新，只取部分列的查询</td>
</tr>
<tr>
<td>ORC（OptimizedRC File）</td>
<td>1. 列式存储，存储效率非常高<br />2. 可压缩，高效的列存取<br />3. 查询效率较高，支持索引<br />4. 支持矢量化查询</td>
<td>1. 加载时性能消耗较大<br />2. 需要通过text文件转化生成<br />3. 读取全量数据时性能较差</td>
<td>1. 适用于Hive中大型的存储、查询</td>
</tr>
</tbody></table>
<h5 id="数据压缩"><a href="#数据压缩" class="headerlink" title="数据压缩"></a>数据压缩</h5><ol>
<li><p>压缩的优点</p>
<ul>
<li>减小文件存储所占空间</li>
<li>加快文件传输效率，从而提高系统的处理速度</li>
<li>降低IO读写的次数</li>
</ul>
</li>
<li><p>压缩的缺点</p>
<ul>
<li>使用数据时需要先对文件解压，加重CPU负荷，压缩算法越复杂，解压时间越长</li>
</ul>
</li>
<li><p>压缩配置</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--开启输出压缩</span></span><br><span class="line"><span class="keyword">set</span> mapreduce.output.fileoutputformat.compress<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="comment">--配置压缩类型为Snappy</span></span><br><span class="line"><span class="keyword">set</span> mapreduce.output.fileoutputformat.compress.codec<span class="operator">=</span>org.apache.hadoop.io.compress.SnappyCodec;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 中间结果压缩</span></span><br><span class="line"><span class="keyword">set</span> hive.exec.compress.intermediate<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="keyword">set</span> hive.intermediate.compression.codec<span class="operator">=</span>org.apache.hadoop.io.compress.SnappyCodec;</span><br><span class="line"><span class="comment">-- 输出结果压缩</span></span><br><span class="line"><span class="keyword">set</span> hive.exec.compress.output<span class="operator">=</span><span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>永久配置：</p>
<ol>
<li><p>将以上MapReduce的配置写入mapred-site.xml中，重启Hadoop</p>
</li>
<li><p>将以上Hive的配置写入hive-site.xml中，重启Hive</p>
</li>
</ol>
</blockquote>
</li>
</ol>
<h5 id="存储优化"><a href="#存储优化" class="headerlink" title="存储优化"></a>存储优化</h5><ol>
<li><p>避免小文件的生成</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 如果hive的程序，只有maptask，将MapTask产生的所有小文件进行合并</span></span><br><span class="line"><span class="keyword">set</span> hive.merge.mapfiles<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="comment">-- 如果hive的程序，有Map和ReduceTask,将ReduceTask产生的所有小文件进行合并</span></span><br><span class="line"><span class="keyword">set</span> hive.merge.mapredfiles<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="comment">-- 每一个合并的文件的大小</span></span><br><span class="line"><span class="keyword">set</span> hive.merge.size.per.task<span class="operator">=</span><span class="number">256000000</span>;</span><br><span class="line"><span class="comment">-- 平均每个文件的大小，如果小于这个值就会进行合并</span></span><br><span class="line"><span class="keyword">set</span> hive.merge.smallfiles.avgsize<span class="operator">=</span><span class="number">16000000</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>读取小文件</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 设置Hive中底层MapReduce读取数据的输入类：将所有文件合并为一个大文件作为输入</span></span><br><span class="line"><span class="keyword">set</span> hive.input.format<span class="operator">=</span>org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;</span><br></pre></td></tr></table></figure></li>
<li><p>ORC文件索引</p>
<p>一个ORC文件包含一个或多个stripes(groups of row data)，每个stripe中包含了每个column的min/max值的索引数据，<strong>当查询中有&lt;,&gt;,=的操作时，会根据min/max值，跳过扫描不包含的stripes</strong>。而其中为<strong>每个stripe建立的包含min/max值的索引，就称为Row Group Index行组索引</strong>。</p>
<p>为了使Row Group Index有效利用，向表中加载数据时，<strong>必须对需要使用索引的字段进行排序</strong>，否则，min/max会失去意义。另外，<strong>这种索引主要用于数值型字段的范围查询过滤优化上</strong>。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 开启索引配置</span></span><br><span class="line"><span class="keyword">set</span> hive.optimize.index.filter<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建表，并指定构建索引</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tb_sogou_orc_index</span><br><span class="line">stored <span class="keyword">as</span> orc tblproperties (&quot;orc.create.index&quot;<span class="operator">=</span>&quot;true&quot;)</span><br><span class="line"><span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_sogou_source</span><br><span class="line">distribute <span class="keyword">by</span> stime</span><br><span class="line">sort <span class="keyword">by</span> stime;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 当进行范围或者等值查询（&lt;,&gt;,=）时就可以基于构建的索引进行查询</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> tb_sogou_orc_index <span class="keyword">where</span> stime <span class="operator">&gt;</span> <span class="string">&#x27;12:00:00&#x27;</span> <span class="keyword">and</span> stime <span class="operator">&lt;</span> <span class="string">&#x27;18:00:00&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>建表时候，通过表参数”orc.bloom.filter.columns”=”columnName……”来指定为哪些字段建立BloomFilter索引，这样，在生成数据的时候，会在每个stripe中，为该字段建立BloomFilter的数据结构，当查<strong>询条件中包含对该字段的=号过滤时候</strong>，先从BloomFilter中获取以下是否包含该值，如果不包含，则跳过该stripe。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建表指定创建布隆索引</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tb_sogou_orc_bloom</span><br><span class="line">stored <span class="keyword">as</span> orc tblproperties (&quot;orc.create.index&quot;<span class="operator">=</span>&quot;true&quot;,&quot;orc.bloom.filter.columns&quot;<span class="operator">=</span>&quot;stime,userid&quot;)</span><br><span class="line"><span class="keyword">as</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_sogou_source</span><br><span class="line">distribute <span class="keyword">by</span> stime</span><br><span class="line">sort <span class="keyword">by</span> stime;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- stime的范围过滤可以走row group index，userid的过滤可以走bloom filter index</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">from</span> tb_sogou_orc_index</span><br><span class="line"><span class="keyword">where</span> stime <span class="operator">&gt;</span> <span class="string">&#x27;12:00:00&#x27;</span> <span class="keyword">and</span> stime <span class="operator">&lt;</span> <span class="string">&#x27;18:00:00&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> userid <span class="operator">=</span> <span class="string">&#x27;3933365481995287&#x27;</span> ;</span><br></pre></td></tr></table></figure></li>
<li><p>ORC矢量化查询</p>
<p>Hive的默认查询执行引擎一次处理一行，而矢量化查询执行是一种Hive针对ORC文件操作的特性，目的是按照每批1024行读取数据，并且一次性对整个记录整合（而不是对单条记录）应用操作，提升了像过滤, 联合, 聚合等等操作的性能。</p>
<p>注意：要使用矢量化查询执行，就必须以<strong>ORC格式</strong>存储数据。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.vectorized.execution.enabled <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">set</span> hive.vectorized.execution.reduce.enabled <span class="operator">=</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="计算Job执行优化"><a href="#计算Job执行优化" class="headerlink" title="计算Job执行优化"></a>计算Job执行优化</h4><h5 id="Explain"><a href="#Explain" class="headerlink" title="Explain"></a>Explain</h5><p>常用语法命令如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN [FORMATTED<span class="operator">|</span>EXTENDED<span class="operator">|</span>DEPENDENCY<span class="operator">|</span><span class="keyword">AUTHORIZATION</span><span class="operator">|</span>]  query</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>FORMATTED：对执行计划进行格式化，返回JSON格式的执行计划</li>
<li>EXTENDED：提供一些额外的信息，比如文件的路径信息</li>
<li>DEPENDENCY：以JSON格式返回查询所依赖的表和分区的列表 </li>
<li>AUTHORIZATION：列出需要被授权的条目，包括输入与输出</li>
</ul>
</blockquote>
<h5 id="MapReduce属性优化"><a href="#MapReduce属性优化" class="headerlink" title="MapReduce属性优化"></a>MapReduce属性优化</h5><ol>
<li><p>本地模式</p>
<p>使用Hive的过程中，有一些数据量不大的表也会转换为MapReduce处理，提交到集群时，需要申请资源，等待资源分配，启动JVM进程，再运行Task，一系列的过程比较繁琐，本身数据量并不大，提交到YARN运行返回会导致性能较差的问题。</p>
<p>Hive为了解决这个问题，延用了MapReduce中的设计，提供本地计算模式，允许程序不提交给YARN，直接在本地运行，以便于提高小数据量程序的性能。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 开启本地模式</span></span><br><span class="line"><span class="keyword">set</span> hive.exec.mode.local.auto <span class="operator">=</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果以下任意一个条件不满足，那么即使开启了本地模式，将依旧会提交给YARN集群运行：</p>
<ul>
<li>处理的数据量不超过128M</li>
<li>MapTask的个数不超过4个</li>
<li>ReduceTask的个数不超过1个</li>
</ul>
</blockquote>
</li>
<li><p>JVM重用</p>
<p>JVM正常指代一个Java进程，Hadoop默认使用派生的JVM来执行map-reducer，如果一个MapReduce程序中有100个Map，10个Reduce，Hadoop默认会为每个Task启动一个JVM来运行，那么就会启动100个JVM来运行MapTask，在JVM启动时内存开销大，尤其是Job大数据量情况，如果单个Task数据量比较小，也会申请JVM资源，这就导致了资源紧张及浪费的情况。</p>
<p>为了解决上述问题，MapReduce中提供了JVM重用机制来解决，JVM重用可以使得JVM实例在同一个job中重新使用N次，当一个Task运行结束以后，JVM不会进行释放，而是继续供下一个Task运行，直到运行了N个Task以后，就会释放，N的值可以在Hadoop的mapred-site.xml文件中进行配置，通常在10-20之间。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Hadoop3之前的配置，在mapred-site.xml中添加以下参数</span></span><br><span class="line"><span class="comment">-- Hadoop3中已不再支持该选项</span></span><br><span class="line">mapreduce.job.jvm.numtasks<span class="operator">=</span><span class="number">10</span> </span><br></pre></td></tr></table></figure></li>
<li><p>并行执行</p>
<p>Hive在实现HQL计算运行时，会解析为多个Stage，有时候Stage彼此之间有依赖关系，只能挨个执行，但是在一些别的场景下，很多的Stage之间是没有依赖关系的，例如Union语句，Join语句等等，这些Stage没有依赖关系，但是Hive依旧默认挨个执行每个Stage，这样会导致性能非常差，我们可以通过修改参数，开启并行执行，当多个Stage之间没有依赖关系时，允许多个Stage并行执行，提高性能。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 开启Stage并行化，默认为false</span></span><br><span class="line"><span class="keyword">SET</span> hive.exec.parallel<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="comment">-- 指定并行化线程数，默认为8</span></span><br><span class="line"><span class="keyword">SET</span> hive.exec.parallel.thread.number<span class="operator">=</span><span class="number">16</span>; </span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="Join优化"><a href="#Join优化" class="headerlink" title="Join优化"></a>Join优化</h5><ol>
<li><p>Map Join</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Hive中小表的大小限制</span></span><br><span class="line"><span class="comment">-- 2.0版本之前的控制属性</span></span><br><span class="line">hive.mapjoin.smalltable.filesize<span class="operator">=</span><span class="number">25</span>M</span><br><span class="line"><span class="comment">-- 2.0版本开始由以下参数控制</span></span><br><span class="line">hive.auto.convert.join.noconditionaltask.size<span class="operator">=</span><span class="number">512000000</span></span><br></pre></td></tr></table></figure></li>
<li><p>Reduce Join</p>
</li>
<li><p>Bucket Join</p>
<ol>
<li><p><strong>Bucket Join</strong></p>
<p>语法：<strong>clustered by colName</strong></p>
<p>参数：<strong>set</strong> hive.optimize.bucketmapjoin = <strong>true</strong>;</p>
<p>要求：分桶字段 = Join字段 ，桶的个数相等或者成倍数</p>
</li>
<li><p><strong>Sort Merge Bucket Join（SMB）</strong>：基于有序的数据Join</p>
<p>语法：<strong>clustered by colName sorted by (colName)</strong></p>
<p>参数：</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 开启分桶SMB join</span></span><br><span class="line"><span class="keyword">set</span> hive.optimize.bucketmapjoin <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">set</span> hive.auto.convert.sortmerge.join<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="keyword">set</span> hive.optimize.bucketmapjoin.sortedmerge <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">set</span> hive.auto.convert.sortmerge.join.noconditionaltask<span class="operator">=</span><span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p>要求：分桶字段 = Join字段 = 排序字段 ，桶的个数相等或者成倍数</p>
</li>
</ol>
</li>
</ol>
<h5 id="优化器"><a href="#优化器" class="headerlink" title="优化器"></a>优化器</h5><ol>
<li><p>关联优化</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 对有关联关系的操作进行解析时，可以尽量放在同一个MapReduce中实现</span></span><br><span class="line"><span class="keyword">set</span> hive.optimize.correlation<span class="operator">=</span><span class="literal">true</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>优化引擎</p>
<ol>
<li><p><strong>RBO</strong></p>
<ul>
<li>rule basic optimise：基于规则的优化器</li>
<li>根据设定好的规则来对程序进行优化</li>
</ul>
</li>
<li><p><strong>CBO</strong></p>
<ul>
<li>cost basic optimise：基于代价的优化器</li>
<li>根据不同场景所需要付出的代价来合适选择优化的方案</li>
<li>对数据的分布的信息【数值出现的次数，条数，分布】来综合判断用哪种处理的方案是最佳方案</li>
</ul>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> hive.cbo.enable<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="keyword">set</span> hive.compute.query.using.stats<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="keyword">set</span> hive.stats.fetch.column.stats<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="keyword">set</span> hive.stats.fetch.partition.stats<span class="operator">=</span><span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p>要想使用CBO引擎，必须构建数据的元数据【表行数、列的信息、分区的信息……】</p>
</li>
<li><p>提前获取这些信息，CBO才能基于代价选择合适的处理计划</p>
</li>
<li><p>所以CBO引擎一般搭配analyze分析优化器一起使用</p>
</li>
</ul>
</blockquote>
</li>
</ol>
</li>
<li><p>Analyze分析优化器</p>
<p>用于提前运行一个MapReduce程序将表或者分区的信息构建一些元数据【表的信息、分区信息、列的信息】，搭配CBO引擎一起使用。</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 构建分区信息元数据</span></span><br><span class="line">ANALYZE <span class="keyword">TABLE</span> tablename</span><br><span class="line">  [<span class="keyword">PARTITION</span>(partcol1[<span class="operator">=</span>val1], partcol2[<span class="operator">=</span>val2], ...)]</span><br><span class="line">  COMPUTE STATISTICS [noscan];</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 构建列的元数据</span></span><br><span class="line">ANALYZE <span class="keyword">TABLE</span> tablename</span><br><span class="line">  [<span class="keyword">PARTITION</span>(partcol1[<span class="operator">=</span>val1], partcol2[<span class="operator">=</span>val2], ...)]</span><br><span class="line">  COMPUTE STATISTICS <span class="keyword">FOR</span> COLUMNS ( columns name1, columns name2...) [noscan];</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看元数据</span></span><br><span class="line"><span class="keyword">DESC</span> FORMATTED [tablename] [columnname];</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="谓词下推（PPD）"><a href="#谓词下推（PPD）" class="headerlink" title="谓词下推（PPD）"></a>谓词下推（PPD）</h5><p>谓词下推 Predicate Pushdown（PPD）的思想简单点说就是在不影响最终结果的情况下，尽量将过滤条件提前执行。谓词下推后，过滤条件在map端执行，减少了map端的输出，降低了数据在集群上传输的量，降低了Reduce端的数据负载，节约了集群的资源，也提升了任务的性能。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 默认自动开启谓词下推</span></span><br><span class="line">hive.optimize.ppd<span class="operator">=</span><span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/xyq-material/image/master/blog/20220519235158.png" alt="image-20220519235156534"></p>
<blockquote>
<ul>
<li>Inner Join和Full outer Join，条件写在on后面，还是where后面，性能上面没有区别</li>
<li>Left outer Join时 ，右侧的表写在on后面，左侧的表写在where后面，性能上有提高</li>
<li>Right outer Join时，左侧的表写在on后面、右侧的表写在where后面，性能上有提高</li>
<li>如果SQL语句中出现不确定结果的函数，也无法实现下推</li>
</ul>
</blockquote>
<h5 id="数据倾斜"><a href="#数据倾斜" class="headerlink" title="数据倾斜"></a>数据倾斜</h5><ol>
<li><p>group By的数据倾斜</p>
<p>当程序中出现group by或者count（distinct）等分组聚合的场景时，如果数据本身是倾斜的根据MapReduce的Hash分区规则，肯定会出现数据倾斜的现象。根本原因是因为分区规则导致的，所以我们可以通过以下几种方案来解决group by导致的数据倾斜的问题。</p>
<p><strong>方案一：开启Map端聚合</strong></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 开启Map端聚合：Combiner</span></span><br><span class="line">hive.map.aggr<span class="operator">=</span><span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过减少Reduce的输入量，避免每个Task数据差异过大导致数据倾斜</p>
</blockquote>
<p><strong>方案二：实现随机分区</strong></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQL中避免数据倾斜，构建随机分区</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">table</span> distribute <span class="keyword">by</span> rand();</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p>distribute by用于指定底层的MapReduce按照哪个字段作为Key实现分区、分组等</p>
</li>
<li><p>默认由Hive自己选择，我们可以通过distribute by自己指定，通过rank函数随机值实现随机分区，避免数据倾斜</p>
</li>
</ul>
</blockquote>
<p><strong>方案三：自动构建随机分区并自动聚合</strong></p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 开启随机分区，走两个MapReduce </span></span><br><span class="line">hive.groupby.skewindata<span class="operator">=</span><span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p>开启该参数以后，当前程序会自动通过两个MapReduce来运行</p>
</li>
<li><p>第一个MapReduce自动进行随机分区，然后实现聚合</p>
</li>
<li><p>第二个MapReduce将聚合的结果再按照业务进行处理，得到结果</p>
</li>
</ul>
</blockquote>
</li>
<li><p>Join的数据倾斜</p>
<p>实际业务需求中往往需要构建两张表的Join实现，如果两张表比较大，无法实现Map Join，只能走Reduce Join，那么当关联字段中某一种值过多的时候依旧会导致数据倾斜的问题，面对Join产生的数据倾斜，我们核心的思想是尽量避免Reduce Join的产生，优先使用Map Join来实现，但往往很多的Join场景不满足Map Join的需求，那么我们可以以下几种方案来解决Join产生的数据倾斜问题：</p>
<p><strong>方案一：提前过滤，将大数据变成小数据，实现Map Join</strong></p>
<p><strong>方案二：使用Bucket Join</strong></p>
<p><strong>方案三：使用Skew Join</strong></p>
<p>Skew Join是Hive中一种专门为了避免数据倾斜而设计的特殊的Join过程，这种Join的原理是将Map Join和Reduce Join进行合并，如果某个值出现了数据倾斜，就会将产生数据倾斜的数据单独使用Map Join来实现，其他没有产生数据倾斜的数据由Reduce Join来实现，这样就避免了Reduce Join中产生数据倾斜的问题，最终将Map Join的结果和Reduce Join的结果进行Union合并</p>
 <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 开启运行过程中skewjoin</span></span><br><span class="line"><span class="keyword">set</span> hive.optimize.skewjoin<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="comment">-- 如果这个key的出现的次数超过这个范围</span></span><br><span class="line"><span class="keyword">set</span> hive.skewjoin.key<span class="operator">=</span><span class="number">100000</span>;</span><br><span class="line"><span class="comment">-- 在编译时判断是否会产生数据倾斜</span></span><br><span class="line"><span class="keyword">set</span> hive.optimize.skewjoin.compiletime<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="comment">-- 不合并，提升性能</span></span><br><span class="line"><span class="keyword">set</span> hive.optimize.union.remove<span class="operator">=</span><span class="literal">true</span>;</span><br><span class="line"><span class="comment">-- 如果Hive的底层走的是MapReduce，必须开启这个属性，才能实现不合并</span></span><br><span class="line"><span class="keyword">set</span> mapreduce.input.fileinputformat.input.dir.recursive<span class="operator">=</span><span class="literal">true</span>;</span><br></pre></td></tr></table></figure></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Eitan
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://example.com/2022/05/20/Hadoop%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9AHive/" title="Hadoop（四）：Hive">http://example.com/2022/05/20/Hadoop（四）：Hive/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/hadoop/" rel="tag"><i class="fa fa-tag"></i> hadoop</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/05/20/Spark%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="prev" title="Spark（一）：环境搭建">
                  <i class="fa fa-chevron-left"></i> Spark（一）：环境搭建
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/05/22/Spark%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9ASparkCore/" rel="next" title="Spark（二）：SparkCore">
                  Spark（二）：SparkCore <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>





<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Eitan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>






  





</body>
</html>
